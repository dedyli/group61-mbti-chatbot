<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Admin Dashboard</title>
  
  <!-- Supabase Client Library -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/supabase-js/2.38.4/supabase.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{--bg-dark:#111827;--bg-light:#1f2937;--primary:#8B5CF6;--text-light:#f7f5ff;--text-muted:#bdb7e6;--border:#374151;--success:#22c55e;--danger:#ef4444}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg-dark);color:var(--text-light);margin:0;min-height:100vh;display:flex;align-items:flex-start;justify-content:center}
    .container{width:100%;max-width:1200px;padding:24px}
    
    /* Login */
    #login-section{width:100%;max-width:420px;margin:10vh auto;background:var(--bg-light);padding:24px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    #login-section h1{margin:0 0 16px}
    .form-group{margin:0 0 12px}
    .form-group label{display:block;margin:0 0 6px;color:var(--text-muted)}
    .form-group input,.select{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg-dark);color:var(--text-light)}
    button{appearance:none;border:0;border-radius:10px;background:var(--primary);color:#fff;padding:12px 16px;font-weight:700;cursor:pointer;transition:.15s}
    button:hover{filter:brightness(1.05)}
    button:disabled{background:var(--border);cursor:not-allowed}
    #error-message{min-height:1.25em;color:var(--danger);margin-top:8px}
    
    /* Dashboard */
    #dashboard-section{display:none}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;margin:0 0 16px}
    .tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin:0 0 16px}
    .nav-tab{background:transparent;color:var(--text-muted);padding:12px 18px;border-radius:10px 10px 0 0;border:1px solid transparent;border-bottom:0}
    .nav-tab.active{color:var(--primary);background:var(--bg-light);border-color:var(--border);border-bottom-color:transparent}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    /* Cards / grids */
    .stats-grid{display:grid;grid-template-columns:repeat(6,minmax(150px,1fr));gap:16px;margin:0 0 16px}
    @media (max-width:1100px){.stats-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:680px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
    .stat-card{background:var(--bg-light);padding:16px;border-radius:12px;min-height:110px;display:flex;flex-direction:column;justify-content:space-between}
    .stat-card h3{margin:0;color:var(--text-muted);font-size:.9rem;text-transform:uppercase;letter-spacing:.02em}
    .stat-card .value{font-size:1.8rem;font-weight:800}
    
    /* Charts */
    .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;min-height:360px}
    @media (max-width:900px){.charts-grid{grid-template-columns:1fr}}
    .chart-card{background:var(--bg-light);padding:14px;border-radius:12px;min-height:340px}
    
    /* Tables */
    .data-table{width:100%;border-collapse:collapse;background:var(--bg-light);border-radius:12px;overflow:hidden;margin:16px 0}
    .data-table th,.data-table td{padding:12px 14px;border-bottom:1px solid var(--border);text-align:left}
    .data-table th{color:var(--text-muted);background:var(--bg-dark)}
    .data-table tr:hover{background:rgba(139,92,246,.1)}
    
    .alert{background:var(--bg-light);border:1px dashed var(--border);padding:12px;border-radius:10px;color:var(--text-muted);margin:16px 0}
    .loading{text-align:center;padding:20px;color:var(--text-muted)}
    .error{color:var(--danger);background:rgba(239,68,68,.1);border:1px solid var(--danger);padding:12px;border-radius:8px;margin:16px 0}
  </style>
</head>
<body>
  <section id="login-section">
    <h1>Admin Login</h1>
    <form id="login-form">
      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" required/>
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" required/>
      </div>
      <button type="submit">Login</button>
    </form>
    <p id="error-message"></p>
  </section>

  <section id="dashboard-section" class="container">
    <header class="dashboard-header">
      <h1>Admin Dashboard</h1>
      <div>
        <span id="user-email" style="margin-right:16px;color:var(--text-muted)"></span>
        <button id="logout-btn">Logout</button>
      </div>
    </header>

    <nav class="tabs">
      <button class="nav-tab active" onclick="switchTab(this,'overview')">Overview</button>
      <button class="nav-tab" onclick="switchTab(this,'conversations')">Conversations</button>
      <button class="nav-tab" onclick="switchTab(this,'feedback')">Feedback</button>
      <button class="nav-tab" onclick="switchTab(this,'contacts')">Contacts</button>
    </nav>

    <main>
      <div id="overview-tab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Users</h3><div id="total-users" class="value">0</div></div>
          <div class="stat-card"><h3>Total Conversations</h3><div id="total-convos" class="value">0</div></div>
          <div class="stat-card"><h3>Completion Rate</h3><div id="completion-rate" class="value">0%</div></div>
          <div class="stat-card"><h3>Total Feedback</h3><div id="total-feedback" class="value">0</div></div>
          <div class="stat-card"><h3>Contact Messages</h3><div id="total-contacts" class="value">0</div></div>
          <div class="stat-card"><h3>Accuracy Rate</h3><div id="accuracy-rate" class="value">N/A</div></div>
        </div>
        <div class="charts-grid">
          <div class="chart-card"><canvas id="conversations-chart"></canvas></div>
          <div class="chart-card"><canvas id="feedback-chart"></canvas></div>
        </div>
      </div>

      <div id="conversations-tab" class="tab-content">
        <div id="conversations-loading" class="loading">Loading conversations...</div>
        <div id="conversations-error" class="error" style="display:none"></div>
        <table id="conversations-table" class="data-table" style="display:none">
          <thead>
            <tr>
              <th>Date</th>
              <th>Messages</th>
              <th>Completed</th>
              <th>Language</th>
              <th>Client IP Hash</th>
            </tr>
          </thead>
          <tbody id="conversations-tbody"></tbody>
        </table>
      </div>

      <div id="feedback-tab" class="tab-content">
        <div id="feedback-loading" class="loading">Loading feedback...</div>
        <div id="feedback-error" class="error" style="display:none"></div>
        <table id="feedback-table" class="data-table" style="display:none">
          <thead>
            <tr>
              <th>Date</th>
              <th>Conversation ID</th>
              <th>Accurate</th>
              <th>Comments</th>
            </tr>
          </thead>
          <tbody id="feedback-tbody"></tbody>
        </table>
      </div>

      <div id="contacts-tab" class="tab-content">
        <div id="contacts-loading" class="loading">Loading contacts...</div>
        <div id="contacts-error" class="error" style="display:none"></div>
        <table id="contacts-table" class="data-table" style="display:none">
          <thead>
            <tr>
              <th>Date</th>
              <th>Name</th>
              <th>Email</th>
              <th>Language</th>
              <th>Message</th>
            </tr>
          </thead>
          <tbody id="contacts-tbody"></tbody>
        </table>
      </div>
    </main>
  </section>

<script>
  // ⚠️ IMPORTANT: Replace these with your actual Supabase credentials
  const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // e.g., 'https://xxxxx.supabase.co'
  const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // This is safe to expose in client
  
  // Initialize Supabase client
  let supabase;
  let currentUser = null;
  let conversationsChart, feedbackChart;

  function initializeSupabase() {
    if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
      showError('Please configure your Supabase credentials in the script');
      return false;
    }
    
    try {
      supabase = supabaseJs.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      return true;
    } catch (error) {
      showError('Failed to initialize Supabase: ' + error.message);
      return false;
    }
  }

  function showError(message) {
    document.getElementById('error-message').textContent = message;
  }

  function clearError() {
    document.getElementById('error-message').textContent = '';
  }

  // UI Management
  function showDashboard(show) {
    document.getElementById('login-section').style.display = show ? 'none' : 'block';
    document.getElementById('dashboard-section').style.display = show ? 'block' : 'none';
    
    if (show && currentUser) {
      document.getElementById('user-email').textContent = currentUser.email;
      loadDashboardData();
    }
  }

  // Authentication
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();
    
    if (!supabase) {
      showError('Supabase not initialized');
      return;
    }

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password) {
      showError('Please enter both email and password');
      return;
    }

    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password
      });

      if (error) {
        showError(error.message);
        return;
      }

      currentUser = data.user;
      
      // Check if user has admin role (you can customize this check)
      if (!isAdminUser(currentUser)) {
        await supabase.auth.signOut();
        showError('Access denied. Admin privileges required.');
        return;
      }

      showDashboard(true);
      
    } catch (error) {
      showError('Login failed: ' + error.message);
    }
  });

  document.getElementById('logout-btn').addEventListener('click', async () => {
    try {
      await supabase.auth.signOut();
      currentUser = null;
      showDashboard(false);
      document.getElementById('login-form').reset();
    } catch (error) {
      console.error('Logout error:', error);
    }
  });

  // Admin user check - customize this based on your needs
  function isAdminUser(user) {
    // Option 1: Check by email domain
    const adminDomains = ['yourdomain.com', 'admin.yoursite.com'];
    const emailDomain = user.email.split('@')[1];
    
    // Option 2: Check by specific emails
    const adminEmails = ['admin@yoursite.com', 'your-email@domain.com'];
    
    // Option 3: Check user metadata (if you set admin role in Supabase)
    const isAdminByRole = user.user_metadata?.role === 'admin' || user.app_metadata?.role === 'admin';
    
    return adminEmails.includes(user.email) || 
           adminDomains.includes(emailDomain) || 
           isAdminByRole;
  }

  // Tab Management
  function switchTab(btn, tab) {
    document.querySelectorAll('.tab-content').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
    document.getElementById(tab + '-tab')?.classList.add('active');
    btn.classList.add('active');
    
    // Load tab-specific data
    if (tab === 'conversations') loadConversations();
    if (tab === 'feedback') loadFeedback();
    if (tab === 'contacts') loadContacts();
  }

  // Data Loading Functions
  async function loadDashboardData() {
    await Promise.all([
      loadOverviewStats(),
      loadOverviewCharts()
    ]);
  }

  async function loadOverviewStats() {
    try {
      // Load conversations count
      const { count: conversationsCount } = await supabase
        .from('conversations')
        .select('*', { count: 'exact', head: true });

      // Load unique users (by IP hash)
      const { data: uniqueIPs } = await supabase
        .from('conversations')
        .select('client_ip_hash')
        .not('client_ip_hash', 'is', null);

      const uniqueUsers = new Set(uniqueIPs?.map(u => u.client_ip_hash)).size;

      // Load completed conversations
      const { count: completedCount } = await supabase
        .from('conversations')
        .select('*', { count: 'exact', head: true })
        .eq('final_analysis', true);

      // Load feedback count
      const { count: feedbackCount } = await supabase
        .from('feedback')
        .select('*', { count: 'exact', head: true });

      // Load contact messages count
      const { count: contactsCount } = await supabase
        .from('contact_messages')
        .select('*', { count: 'exact', head: true });

      // Load feedback accuracy
      const { data: feedbackData } = await supabase
        .from('feedback')
        .select('is_accurate');

      let accuracyRate = 'N/A';
      if (feedbackData && feedbackData.length > 0) {
        const accurate = feedbackData.filter(f => f.is_accurate).length;
        accuracyRate = Math.round((accurate / feedbackData.length) * 100) + '%';
      }

      // Update UI
      document.getElementById('total-users').textContent = uniqueUsers || 0;
      document.getElementById('total-convos').textContent = conversationsCount || 0;
      document.getElementById('completion-rate').textContent = 
        conversationsCount > 0 ? Math.round((completedCount / conversationsCount) * 100) + '%' : '0%';
      document.getElementById('total-feedback').textContent = feedbackCount || 0;
      document.getElementById('total-contacts').textContent = contactsCount || 0;
      document.getElementById('accuracy-rate').textContent = accuracyRate;

    } catch (error) {
      console.error('Error loading overview stats:', error);
      showError('Failed to load overview statistics');
    }
  }

  async function loadOverviewCharts() {
    try {
      // Destroy existing charts
      if (conversationsChart) conversationsChart.destroy();
      if (feedbackChart) feedbackChart.destroy();

      // Load conversations over time (last 7 days)
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      const { data: recentConversations } = await supabase
        .from('conversations')
        .select('created_at')
        .gte('created_at', sevenDaysAgo.toISOString());

      // Group by day
      const conversationsByDay = {};
      const last7Days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last7Days.push(dateStr);
        conversationsByDay[dateStr] = 0;
      }

      recentConversations?.forEach(conv => {
        const date = conv.created_at.split('T')[0];
        if (conversationsByDay.hasOwnProperty(date)) {
          conversationsByDay[date]++;
        }
      });

      // Conversations chart
      const ctx1 = document.getElementById('conversations-chart').getContext('2d');
      conversationsChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: last7Days.map(date => new Date(date).toLocaleDateString('en-US', { weekday: 'short' })),
          datasets: [{
            label: 'Conversations',
            data: last7Days.map(date => conversationsByDay[date]),
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139,92,246,.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#f7f5ff' } }
          },
          scales: {
            x: { ticks: { color: '#bdb7e6' } },
            y: { ticks: { color: '#bdb7e6' } }
          }
        }
      });

      // Feedback chart
      const { data: feedbackData } = await supabase
        .from('feedback')
        .select('is_accurate');

      const accurate = feedbackData?.filter(f => f.is_accurate).length || 0;
      const inaccurate = (feedbackData?.length || 0) - accurate;

      const ctx2 = document.getElementById('feedback-chart').getContext('2d');
      feedbackChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Accurate', 'Inaccurate'],
          datasets: [{
            data: [accurate, inaccurate],
            backgroundColor: ['#22c55e', '#ef4444']
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { labels: { color: '#f7f5ff' } }
          }
        }
      });

    } catch (error) {
      console.error('Error loading charts:', error);
    }
  }

  async function loadConversations() {
    const loading = document.getElementById('conversations-loading');
    const error = document.getElementById('conversations-error');
    const table = document.getElementById('conversations-table');
    const tbody = document.getElementById('conversations-tbody');

    loading.style.display = 'block';
    error.style.display = 'none';
    table.style.display = 'none';

    try {
      const { data: conversations, error: convError } = await supabase
        .from('conversations')
        .select('id, created_at, message_count, final_analysis, language, client_ip_hash')
        .order('created_at', { ascending: false })
        .limit(50);

      if (convError) throw convError;

      tbody.innerHTML = conversations?.map(conv => `
        <tr>
          <td>${new Date(conv.created_at).toLocaleString()}</td>
          <td>${conv.message_count || 'N/A'}</td>
          <td>${conv.final_analysis ? 'Yes' : 'No'}</td>
          <td>${conv.language || 'N/A'}</td>
          <td>${conv.client_ip_hash ? conv.client_ip_hash.substring(0, 8) + '...' : 'N/A'}</td>
        </tr>
      `).join('') || '<tr><td colspan="5">No conversations found</td></tr>';

      loading.style.display = 'none';
      table.style.display = 'table';

    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = 'Error loading conversations: ' + err.message;
    }
  }

  async function loadFeedback() {
    const loading = document.getElementById('feedback-loading');
    const error = document.getElementById('feedback-error');
    const table = document.getElementById('feedback-table');
    const tbody = document.getElementById('feedback-tbody');

    loading.style.display = 'block';
    error.style.display = 'none';
    table.style.display = 'none';

    try {
      const { data: feedback, error: feedError } = await supabase
        .from('feedback')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50);

      if (feedError) throw feedError;

      tbody.innerHTML = feedback?.map(fb => `
        <tr>
          <td>${new Date(fb.created_at).toLocaleString()}</td>
          <td>${fb.conversation_id || 'N/A'}</td>
          <td>${fb.is_accurate ? 'Yes' : 'No'}</td>
          <td>${fb.comments || 'N/A'}</td>
        </tr>
      `).join('') || '<tr><td colspan="4">No feedback found</td></tr>';

      loading.style.display = 'none';
      table.style.display = 'table';

    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = 'Error loading feedback: ' + err.message;
    }
  }

  async function loadContacts() {
    const loading = document.getElementById('contacts-loading');
    const error = document.getElementById('contacts-error');
    const table = document.getElementById('contacts-table');
    const tbody = document.getElementById('contacts-tbody');

    loading.style.display = 'block';
    error.style.display = 'none';
    table.style.display = 'none';

    try {
      const { data: contacts, error: contactError } = await supabase
        .from('contact_messages')
        .select('*')
        .order('created_at', { ascending: false })
        .limit(50);

      if (contactError) throw contactError;

      tbody.innerHTML = contacts?.map(contact => `
        <tr>
          <td>${new Date(contact.created_at).toLocaleString()}</td>
          <td>${contact.name || 'N/A'}</td>
          <td><a href="mailto:${contact.email || ''}">${contact.email || 'N/A'}</a></td>
          <td>${contact.lang || 'N/A'}</td>
          <td>${contact.message || 'N/A'}</td>
        </tr>
      `).join('') || '<tr><td colspan="5">No contact messages found</td></tr>';

      loading.style.display = 'none';
      table.style.display = 'table';

    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = 'Error loading contacts: ' + err.message;
    }
  }

  // Check for existing session on page load
  document.addEventListener('DOMContentLoaded', async () => {
    if (!initializeSupabase()) {
      return;
    }

    try {
      const { data: { session } } = await supabase.auth.getSession();
      
      if (session?.user) {
        currentUser = session.user;
        
        if (isAdminUser(currentUser)) {
          showDashboard(true);
        } else {
          await supabase.auth.signOut();
          showError('Access denied. Admin privileges required.');
        }
      }
    } catch (error) {
      console.error('Session check error:', error);
    }

    // Listen for auth changes
    supabase.auth.onAuthStateChange((event, session) => {
      if (event === 'SIGNED_OUT') {
        currentUser = null;
        showDashboard(false);
      }
    });
  });
</script>
</body>
</html>