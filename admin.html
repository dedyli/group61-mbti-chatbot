<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>System Access</title>
  <meta name="robots" content="noindex, nofollow">
  
  <!-- Supabase Client Library -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{--bg-dark:#111827;--bg-light:#1f2937;--primary:#8B5CF6;--text-light:#f7f5ff;--text-muted:#bdb7e6;--border:#374151;--success:#22c55e;--danger:#ef4444;--info:#3b82f6}
    *{box-sizing:border-box}
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:var(--bg-dark);color:var(--text-light);margin:0;min-height:100vh;display:flex;align-items:flex-start;justify-content:center}
    .container{width:100%;max-width:1400px;padding:24px}
    
    /* Security Warning */
    .security-notice{background:var(--danger);color:white;padding:8px 16px;text-align:center;font-size:0.9rem;position:fixed;top:0;left:0;right:0;z-index:1000}
    
    /* Login */
    #login-section{width:100%;max-width:420px;margin:10vh auto;background:var(--bg-light);padding:24px;border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,.25)}
    #login-section h1{margin:0 0 16px}
    .form-group{margin:0 0 12px}
    .form-group label{display:block;margin:0 0 6px;color:var(--text-muted)}
    .form-group input,.select{width:100%;padding:12px;border:1px solid var(--border);border-radius:8px;background:var(--bg-dark);color:var(--text-light)}
    button{appearance:none;border:0;border-radius:10px;background:var(--primary);color:#fff;padding:12px 16px;font-weight:700;cursor:pointer;transition:.15s}
    button:hover{filter:brightness(1.05)}
    button:disabled{background:var(--border);cursor:not-allowed}
    #error-message{min-height:1.25em;color:var(--danger);margin-top:8px}
    
    /* Dashboard */
    #dashboard-section{display:none}
    .dashboard-header{display:flex;justify-content:space-between;align-items:center;margin:0 0 16px}
    .tabs{display:flex;gap:2px;border-bottom:1px solid var(--border);margin:0 0 16px}
    .nav-tab{background:transparent;color:var(--text-muted);padding:12px 18px;border-radius:10px 10px 0 0;border:1px solid transparent;border-bottom:0}
    .nav-tab.active{color:var(--primary);background:var(--bg-light);border-color:var(--border);border-bottom-color:transparent}
    .tab-content{display:none}
    .tab-content.active{display:block}
    
    /* Cards / grids */
    .stats-grid{display:grid;grid-template-columns:repeat(6,minmax(150px,1fr));gap:16px;margin:0 0 16px}
    @media (max-width:1100px){.stats-grid{grid-template-columns:repeat(3,1fr)}}
    @media (max-width:680px){.stats-grid{grid-template-columns:repeat(2,1fr)}}
    .stat-card{background:var(--bg-light);padding:16px;border-radius:12px;min-height:110px;display:flex;flex-direction:column;justify-content:space-between}
    .stat-card h3{margin:0;color:var(--text-muted);font-size:.9rem;text-transform:uppercase;letter-spacing:.02em}
    .stat-card .value{font-size:1.8rem;font-weight:800}
    
    /* Charts */
    .charts-grid{display:grid;grid-template-columns:2fr 1fr;gap:16px;min-height:360px}
    @media (max-width:900px){.charts-grid{grid-template-columns:1fr}}
    .chart-card{background:var(--bg-light);padding:14px;border-radius:12px;min-height:340px}
    
    /* Table Controls */
    .table-controls{display:flex;justify-content:space-between;align-items:center;margin:16px 0;flex-wrap:wrap;gap:12px}
    .table-controls-left{display:flex;align-items:center;gap:12px}
    .table-controls-right{display:flex;align-items:center;gap:12px}
    .page-size-selector{padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg-dark);color:var(--text-light);font-size:0.9rem}
    .search-input{padding:8px 12px;border:1px solid var(--border);border-radius:6px;background:var(--bg-dark);color:var(--text-light);min-width:200px}
    .refresh-btn{padding:8px 16px;background:var(--info);border-radius:6px;font-size:0.9rem}
    
    /* Tables */
    .table-container{background:var(--bg-light);border-radius:12px;overflow:hidden;margin:16px 0}
    .data-table{width:100%;border-collapse:collapse}
    .data-table th,.data-table td{padding:12px 14px;border-bottom:1px solid var(--border);text-align:left}
    .data-table th{color:var(--text-muted);background:var(--bg-dark);font-weight:600;position:sticky;top:0}
    .data-table tr:hover{background:rgba(139,92,246,.1)}
    .data-table td{font-size:0.9rem}
    
    /* Pagination */
    .pagination-container{background:var(--bg-light);padding:16px;border-top:1px solid var(--border);display:flex;justify-content:between;align-items:center;flex-wrap:wrap;gap:16px}
    .pagination-info{color:var(--text-muted);font-size:0.9rem}
    .pagination-controls{display:flex;align-items:center;gap:8px}
    .pagination-controls button{padding:8px 12px;background:transparent;border:1px solid var(--border);border-radius:6px;color:var(--text-light);font-size:0.9rem;min-width:40px}
    .pagination-controls button:hover:not(:disabled){background:var(--primary);border-color:var(--primary)}
    .pagination-controls button.active{background:var(--primary);border-color:var(--primary)}
    .pagination-controls button:disabled{opacity:0.5;cursor:not-allowed}
    .pagination-jump{display:flex;align-items:center;gap:8px;margin-left:16px}
    .pagination-jump input{width:60px;padding:6px 8px;text-align:center;border:1px solid var(--border);border-radius:4px;background:var(--bg-dark);color:var(--text-light)}
    
    /* Status badges */
    .status-badge{padding:4px 8px;border-radius:12px;font-size:0.8rem;font-weight:600}
    .status-completed{background:var(--success);color:white}
    .status-pending{background:var(--danger);color:white}
    .status-accurate{background:var(--success);color:white}
    .status-inaccurate{background:var(--danger);color:white}
    
    .alert{background:var(--bg-light);border:1px dashed var(--border);padding:12px;border-radius:10px;color:var(--text-muted);margin:16px 0}
    .loading{text-align:center;padding:20px;color:var(--text-muted)}
    .error{color:var(--danger);background:rgba(239,68,68,.1);border:1px solid var(--danger);padding:12px;border-radius:8px;margin:16px 0}
    .lockout-message{background:var(--danger);color:white;padding:16px;border-radius:8px;margin:16px 0;text-align:center}
    
    /* Responsive */
    @media (max-width:768px){
      .table-controls{flex-direction:column;align-items:stretch}
      .table-controls-left,.table-controls-right{justify-content:center}
      .pagination-container{flex-direction:column;text-align:center}
      .pagination-controls{justify-content:center}
      .data-table{font-size:0.8rem}
      .data-table th,.data-table td{padding:8px 6px}
    }
  </style>
</head>
<body>
  <!-- Security Notice -->
  <div class="security-notice" id="security-notice" style="display:none;">
    🔒 Secure Admin Access - Authorized Personnel Only
  </div>

  <section id="login-section">
    <h1>System Access</h1>
    <div id="lockout-warning" class="lockout-message" style="display:none;">
      <strong>Account Temporarily Locked</strong><br>
      Too many failed attempts. Please try again in <span id="lockout-time">15</span> minutes.
    </div>
    <form id="login-form">
      <div class="form-group">
        <label for="email">Email</label>
        <input id="email" type="email" required autocomplete="username"/>
      </div>
      <div class="form-group">
        <label for="password">Password</label>
        <input id="password" type="password" required autocomplete="current-password"/>
      </div>
      <button type="submit" id="login-btn">Access System</button>
    </form>
    <p id="error-message"></p>
    <div id="attempts-warning" style="color:var(--danger);font-size:0.9rem;margin-top:8px;display:none;">
      <span id="attempts-count">0</span> failed attempts. Account will be locked after 5 attempts.
    </div>
  </section>

  <section id="dashboard-section" class="container">
    <header class="dashboard-header">
      <h1>System Dashboard</h1>
      <div>
        <span id="user-email" style="margin-right:16px;color:var(--text-muted)"></span>
        <span id="session-timer" style="margin-right:16px;color:var(--text-muted);font-size:0.9rem;"></span>
        <button id="logout-btn">Logout</button>
      </div>
    </header>

    <nav class="tabs">
      <button class="nav-tab active" onclick="switchTab(this,'overview')">Overview</button>
      <button class="nav-tab" onclick="switchTab(this,'conversations')">Conversations</button>
      <button class="nav-tab" onclick="switchTab(this,'feedback')">Feedback</button>
      <button class="nav-tab" onclick="switchTab(this,'contacts')">Contacts</button>
    </nav>

    <main>
      <div id="overview-tab" class="tab-content active">
        <div class="stats-grid">
          <div class="stat-card"><h3>Total Users</h3><div id="total-users" class="value">0</div></div>
          <div class="stat-card"><h3>Total Conversations</h3><div id="total-convos" class="value">0</div></div>
          <div class="stat-card"><h3>Completion Rate</h3><div id="completion-rate" class="value">0%</div></div>
          <div class="stat-card"><h3>Total Feedback</h3><div id="total-feedback" class="value">0</div></div>
          <div class="stat-card"><h3>Contact Messages</h3><div id="total-contacts" class="value">0</div></div>
          <div class="stat-card"><h3>Accuracy Rate</h3><div id="accuracy-rate" class="value">N/A</div></div>
        </div>
        <div class="charts-grid">
          <div class="chart-card"><canvas id="conversations-chart"></canvas></div>
          <div class="chart-card"><canvas id="feedback-chart"></canvas></div>
        </div>
      </div>

      <!-- Conversations Tab -->
      <div id="conversations-tab" class="tab-content">
        <div class="table-controls">
          <div class="table-controls-left">
            <label for="conversations-page-size">Show:</label>
            <select id="conversations-page-size" class="page-size-selector" onchange="changeConversationsPageSize()">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span>entries</span>
          </div>
          <div class="table-controls-right">
            <input id="conversations-search" type="search" class="search-input" placeholder="Search conversations..." onchange="searchConversations()">
            <button class="refresh-btn" onclick="loadConversations(1)">Refresh</button>
          </div>
        </div>
        
        <div id="conversations-loading" class="loading">Loading conversations...</div>
        <div id="conversations-error" class="error" style="display:none"></div>
        
        <div id="conversations-table-container" class="table-container" style="display:none">
          <table id="conversations-table" class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Messages</th>
                <th>Status</th>
                <th>Language</th>
                <th>Client IP</th>
              </tr>
            </thead>
            <tbody id="conversations-tbody"></tbody>
          </table>
          <div class="pagination-container">
            <div class="pagination-info" id="conversations-pagination-info">
              Showing 0 to 0 of 0 entries
            </div>
            <div class="pagination-controls" id="conversations-pagination-controls">
              <!-- Pagination buttons will be generated here -->
            </div>
            <div class="pagination-jump">
              <span>Go to page:</span>
              <input type="number" id="conversations-page-jump" min="1" onchange="jumpToConversationsPage()">
            </div>
          </div>
        </div>
      </div>

      <!-- Feedback Tab -->
      <div id="feedback-tab" class="tab-content">
        <div class="table-controls">
          <div class="table-controls-left">
            <label for="feedback-page-size">Show:</label>
            <select id="feedback-page-size" class="page-size-selector" onchange="changeFeedbackPageSize()">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span>entries</span>
          </div>
          <div class="table-controls-right">
            <input id="feedback-search" type="search" class="search-input" placeholder="Search feedback..." onchange="searchFeedback()">
            <button class="refresh-btn" onclick="loadFeedback(1)">Refresh</button>
          </div>
        </div>
        
        <div id="feedback-loading" class="loading">Loading feedback...</div>
        <div id="feedback-error" class="error" style="display:none"></div>
        
        <div id="feedback-table-container" class="table-container" style="display:none">
          <table id="feedback-table" class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Conversation ID</th>
                <th>Accuracy</th>
                <th>Comments</th>
              </tr>
            </thead>
            <tbody id="feedback-tbody"></tbody>
          </table>
          <div class="pagination-container">
            <div class="pagination-info" id="feedback-pagination-info">
              Showing 0 to 0 of 0 entries
            </div>
            <div class="pagination-controls" id="feedback-pagination-controls">
              <!-- Pagination buttons will be generated here -->
            </div>
            <div class="pagination-jump">
              <span>Go to page:</span>
              <input type="number" id="feedback-page-jump" min="1" onchange="jumpToFeedbackPage()">
            </div>
          </div>
        </div>
      </div>

      <!-- Contacts Tab -->
      <div id="contacts-tab" class="tab-content">
        <div class="table-controls">
          <div class="table-controls-left">
            <label for="contacts-page-size">Show:</label>
            <select id="contacts-page-size" class="page-size-selector" onchange="changeContactsPageSize()">
              <option value="10">10</option>
              <option value="25" selected>25</option>
              <option value="50">50</option>
              <option value="100">100</option>
            </select>
            <span>entries</span>
          </div>
          <div class="table-controls-right">
            <input id="contacts-search" type="search" class="search-input" placeholder="Search contacts..." onchange="searchContacts()">
            <button class="refresh-btn" onclick="loadContacts(1)">Refresh</button>
          </div>
        </div>
        
        <div id="contacts-loading" class="loading">Loading contacts...</div>
        <div id="contacts-error" class="error" style="display:none"></div>
        
        <div id="contacts-table-container" class="table-container" style="display:none">
          <table id="contacts-table" class="data-table">
            <thead>
              <tr>
                <th>Date</th>
                <th>Name</th>
                <th>Email</th>
                <th>Language</th>
                <th>Message</th>
              </tr>
            </thead>
            <tbody id="contacts-tbody"></tbody>
          </table>
          <div class="pagination-container">
            <div class="pagination-info" id="contacts-pagination-info">
              Showing 0 to 0 of 0 entries
            </div>
            <div class="pagination-controls" id="contacts-pagination-controls">
              <!-- Pagination buttons will be generated here -->
            </div>
            <div class="pagination-jump">
              <span>Go to page:</span>
              <input type="number" id="contacts-page-jump" min="1" onchange="jumpToContactsPage()">
            </div>
          </div>
        </div>
      </div>
    </main>
  </section>

<script>
  // ⚠️ SECURITY CONFIGURATION
  const SECURITY_CONFIG = {
    allowedDomains: ['yourdomain.com', 'localhost', '127.0.0.1'],
    maxLoginAttempts: 5,
    lockoutDuration: 15 * 60 * 1000,
    sessionTimeout: 30 * 60 * 1000,
    showSecurityNotice: true
  };

  // ⚠️ REPLACE WITH YOUR ACTUAL SUPABASE CREDENTIALS
  const SUPABASE_URL = 'https://okbqkkftdxazdfkiovjj.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rYnFra2Z0ZHhhemRma2lvdmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDUxOTEsImV4cCI6MjA3MDcyMTE5MX0.SvYI1lxJP-dzEK5j1xGNdJu-pNtWEzVm7S2wnQBMY9c';
  
  // Initialize variables
  let supabase;
  let currentUser = null;
  let conversationsChart, feedbackChart;

  // Pagination state
  const paginationState = {
    conversations: { currentPage: 1, pageSize: 25, totalCount: 0, searchTerm: '' },
    feedback: { currentPage: 1, pageSize: 25, totalCount: 0, searchTerm: '' },
    contacts: { currentPage: 1, pageSize: 25, totalCount: 0, searchTerm: '' }
  };

  // Security functions (simplified for space - same as before)
  function validateDomain() {
    const currentDomain = window.location.hostname;
    if (!SECURITY_CONFIG.allowedDomains.includes(currentDomain)) {
      document.body.innerHTML = '<div style="text-align:center;padding:50px;"><h1>🔒 Access Denied</h1></div>';
      throw new Error('Unauthorized domain');
    }
  }

  function checkRateLimit() {
    const attempts = parseInt(sessionStorage.getItem('loginAttempts') || '0');
    const lastAttempt = parseInt(sessionStorage.getItem('lastAttempt') || '0');
    
    if (attempts >= SECURITY_CONFIG.maxLoginAttempts) {
      const timeSinceLastAttempt = Date.now() - lastAttempt;
      if (timeSinceLastAttempt < SECURITY_CONFIG.lockoutDuration) {
        const minutesLeft = Math.ceil((SECURITY_CONFIG.lockoutDuration - timeSinceLastAttempt) / 60000);
        showLockoutMessage(minutesLeft);
        return false;
      } else {
        sessionStorage.removeItem('loginAttempts');
        sessionStorage.removeItem('lastAttempt');
        hideLockoutMessage();
      }
    }
    return true;
  }

  function recordFailedAttempt() {
    const attempts = parseInt(sessionStorage.getItem('loginAttempts') || '0') + 1;
    sessionStorage.setItem('loginAttempts', attempts.toString());
    sessionStorage.setItem('lastAttempt', Date.now().toString());
    updateAttemptsWarning(attempts);
    
    if (attempts >= SECURITY_CONFIG.maxLoginAttempts) {
      showLockoutMessage(Math.ceil(SECURITY_CONFIG.lockoutDuration / 60000));
    }
  }

  function resetAttempts() {
    sessionStorage.removeItem('loginAttempts');
    sessionStorage.removeItem('lastAttempt');
    hideAttemptsWarning();
  }

  function showLockoutMessage(minutes) {
    document.getElementById('lockout-time').textContent = minutes;
    document.getElementById('lockout-warning').style.display = 'block';
    document.getElementById('login-btn').disabled = true;
  }

  function hideLockoutMessage() {
    document.getElementById('lockout-warning').style.display = 'none';
    document.getElementById('login-btn').disabled = false;
  }

  function updateAttemptsWarning(attempts) {
    if (attempts > 0 && attempts < SECURITY_CONFIG.maxLoginAttempts) {
      document.getElementById('attempts-count').textContent = attempts;
      document.getElementById('attempts-warning').style.display = 'block';
    }
  }

  function hideAttemptsWarning() {
    document.getElementById('attempts-warning').style.display = 'none';
  }

  // Session timer
  let sessionTimer;
  let sessionStartTime;

  function startSessionTimer() {
    sessionStartTime = Date.now();
    sessionTimer = setInterval(() => {
      const elapsed = Date.now() - sessionStartTime;
      const remaining = SECURITY_CONFIG.sessionTimeout - elapsed;
      
      if (remaining <= 0) {
        clearInterval(sessionTimer);
        alert('Session expired for security. Please login again.');
        logout();
      } else {
        const minutes = Math.floor(remaining / 60000);
        const seconds = Math.floor((remaining % 60000) / 1000);
        document.getElementById('session-timer').textContent = `Session: ${minutes}:${seconds.toString().padStart(2, '0')}`;
      }
    }, 1000);
  }

  function stopSessionTimer() {
    if (sessionTimer) clearInterval(sessionTimer);
    document.getElementById('session-timer').textContent = '';
  }

  // Initialize Supabase
  function initializeSupabase() {
    if (!SUPABASE_URL || !SUPABASE_ANON_KEY || 
        SUPABASE_URL.includes('your-project-id') || 
        SUPABASE_ANON_KEY.includes('your-anon-key')) {
      showError('System not properly configured');
      return false;
    }

    if (!window.supabase) {
      showError('System libraries not loaded. Please check your connection.');
      return false;
    }
    
    try {
      supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
      return true;
    } catch (error) {
      showError('Failed to initialize system');
      return false;
    }
  }

  function showError(message) {
    document.getElementById('error-message').textContent = message;
  }

  function clearError() {
    document.getElementById('error-message').textContent = '';
  }

  function showDashboard(show) {
    document.getElementById('login-section').style.display = show ? 'none' : 'block';
    document.getElementById('dashboard-section').style.display = show ? 'block' : 'none';
    
    if (show && currentUser) {
      document.getElementById('user-email').textContent = currentUser.email;
      startSessionTimer();
      loadDashboardData();
    } else {
      stopSessionTimer();
    }
  }

  // Authentication
  document.getElementById('login-form').addEventListener('submit', async (e) => {
    e.preventDefault();
    clearError();
    
    if (!checkRateLimit() || !supabase) return;

    const email = document.getElementById('email').value.trim();
    const password = document.getElementById('password').value;

    if (!email || !password) {
      showError('Please enter both email and password');
      return;
    }

    try {
      const { data, error } = await supabase.auth.signInWithPassword({ email, password });

      if (error) {
        recordFailedAttempt();
        showError('Authentication failed');
        return;
      }

      currentUser = data.user;
      resetAttempts();
      showDashboard(true);
      
    } catch (error) {
      recordFailedAttempt();
      showError('System error during authentication');
    }
  });

  function logout() {
    if (supabase) supabase.auth.signOut();
    currentUser = null;
    showDashboard(false);
    document.getElementById('login-form').reset();
    stopSessionTimer();
  }

  document.getElementById('logout-btn').addEventListener('click', logout);

  // Tab Management
  function switchTab(btn, tab) {
    document.querySelectorAll('.tab-content').forEach(n => n.classList.remove('active'));
    document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
    document.getElementById(tab + '-tab')?.classList.add('active');
    btn.classList.add('active');
    
    if (tab === 'conversations') loadConversations(1);
    if (tab === 'feedback') loadFeedback(1);
    if (tab === 'contacts') loadContacts(1);
  }

  // Pagination Helper Functions
  function generatePaginationControls(type, currentPage, totalPages) {
    const controlsContainer = document.getElementById(`${type}-pagination-controls`);
    controlsContainer.innerHTML = '';

    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.textContent = '‹';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => type === 'conversations' ? loadConversations(currentPage - 1) :
                            type === 'feedback' ? loadFeedback(currentPage - 1) :
                            loadContacts(currentPage - 1);
    controlsContainer.appendChild(prevBtn);

    // Page numbers
    const startPage = Math.max(1, currentPage - 2);
    const endPage = Math.min(totalPages, currentPage + 2);

    if (startPage > 1) {
      const firstBtn = document.createElement('button');
      firstBtn.textContent = '1';
      firstBtn.onclick = () => type === 'conversations' ? loadConversations(1) :
                              type === 'feedback' ? loadFeedback(1) :
                              loadContacts(1);
      controlsContainer.appendChild(firstBtn);

      if (startPage > 2) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.style.padding = '8px';
        controlsContainer.appendChild(ellipsis);
      }
    }

    for (let i = startPage; i <= endPage; i++) {
      const pageBtn = document.createElement('button');
      pageBtn.textContent = i;
      pageBtn.className = i === currentPage ? 'active' : '';
      pageBtn.onclick = () => type === 'conversations' ? loadConversations(i) :
                              type === 'feedback' ? loadFeedback(i) :
                              loadContacts(i);
      controlsContainer.appendChild(pageBtn);
    }

    if (endPage < totalPages) {
      if (endPage < totalPages - 1) {
        const ellipsis = document.createElement('span');
        ellipsis.textContent = '...';
        ellipsis.style.padding = '8px';
        controlsContainer.appendChild(ellipsis);
      }

      const lastBtn = document.createElement('button');
      lastBtn.textContent = totalPages;
      lastBtn.onclick = () => type === 'conversations' ? loadConversations(totalPages) :
                              type === 'feedback' ? loadFeedback(totalPages) :
                              loadContacts(totalPages);
      controlsContainer.appendChild(lastBtn);
    }

    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.textContent = '›';
    nextBtn.disabled = currentPage === totalPages;
    nextBtn.onclick = () => type === 'conversations' ? loadConversations(currentPage + 1) :
                            type === 'feedback' ? loadFeedback(currentPage + 1) :
                            loadContacts(currentPage + 1);
    controlsContainer.appendChild(nextBtn);
  }

  function updatePaginationInfo(type, currentPage, pageSize, totalCount) {
    const start = (currentPage - 1) * pageSize + 1;
    const end = Math.min(currentPage * pageSize, totalCount);
    const infoElement = document.getElementById(`${type}-pagination-info`);
    infoElement.textContent = `Showing ${start} to ${end} of ${totalCount} entries`;
  }

  // Page size change functions
  function changeConversationsPageSize() {
    paginationState.conversations.pageSize = parseInt(document.getElementById('conversations-page-size').value);
    loadConversations(1);
  }

  function changeFeedbackPageSize() {
    paginationState.feedback.pageSize = parseInt(document.getElementById('feedback-page-size').value);
    loadFeedback(1);
  }

  function changeContactsPageSize() {
    paginationState.contacts.pageSize = parseInt(document.getElementById('contacts-page-size').value);
    loadContacts(1);
  }

  // Search functions
  function searchConversations() {
    paginationState.conversations.searchTerm = document.getElementById('conversations-search').value;
    loadConversations(1);
  }

  function searchFeedback() {
    paginationState.feedback.searchTerm = document.getElementById('feedback-search').value;
    loadFeedback(1);
  }

  function searchContacts() {
    paginationState.contacts.searchTerm = document.getElementById('contacts-search').value;
    loadContacts(1);
  }

  // Jump to page functions
  function jumpToConversationsPage() {
    const page = parseInt(document.getElementById('conversations-page-jump').value);
    const maxPage = Math.ceil(paginationState.conversations.totalCount / paginationState.conversations.pageSize);
    if (page >= 1 && page <= maxPage) {
      loadConversations(page);
    }
  }

  function jumpToFeedbackPage() {
    const page = parseInt(document.getElementById('feedback-page-jump').value);
    const maxPage = Math.ceil(paginationState.feedback.totalCount / paginationState.feedback.pageSize);
    if (page >= 1 && page <= maxPage) {
      loadFeedback(page);
    }
  }

  function jumpToContactsPage() {
    const page = parseInt(document.getElementById('contacts-page-jump').value);
    const maxPage = Math.ceil(paginationState.contacts.totalCount / paginationState.contacts.pageSize);
    if (page >= 1 && page <= maxPage) {
      loadContacts(page);
    }
  }

  // Data Loading Functions
  async function loadDashboardData() {
    await Promise.all([loadOverviewStats(), loadOverviewCharts()]);
  }

  async function loadOverviewStats() {
    try {
      const results = await Promise.allSettled([
        supabase.from('conversations').select('*', { count: 'exact', head: true }),
        supabase.from('conversations').select('client_ip_hash').not('client_ip_hash', 'is', null),
        supabase.from('conversations').select('*', { count: 'exact', head: true }).eq('final_analysis', true),
        supabase.from('feedback').select('*', { count: 'exact', head: true }),
        supabase.from('contact_messages').select('*', { count: 'exact', head: true }),
        supabase.from('feedback').select('is_accurate')
      ]);

      const conversationsCount = results[0].status === 'fulfilled' ? results[0].value.count : 0;
      const uniqueIPs = results[1].status === 'fulfilled' ? results[1].value.data : [];
      const completedCount = results[2].status === 'fulfilled' ? results[2].value.count : 0;
      const feedbackCount = results[3].status === 'fulfilled' ? results[3].value.count : 0;
      const contactsCount = results[4].status === 'fulfilled' ? results[4].value.count : 0;
      const feedbackData = results[5].status === 'fulfilled' ? results[5].value.data : [];

      const uniqueUsers = new Set(uniqueIPs?.map(u => u.client_ip_hash)).size;
      
      let accuracyRate = 'N/A';
      if (feedbackData && feedbackData.length > 0) {
        const accurate = feedbackData.filter(f => f.is_accurate).length;
        accuracyRate = Math.round((accurate / feedbackData.length) * 100) + '%';
      }

      document.getElementById('total-users').textContent = uniqueUsers || 0;
      document.getElementById('total-convos').textContent = conversationsCount || 0;
      document.getElementById('completion-rate').textContent = 
        conversationsCount > 0 ? Math.round((completedCount / conversationsCount) * 100) + '%' : '0%';
      document.getElementById('total-feedback').textContent = feedbackCount || 0;
      document.getElementById('total-contacts').textContent = contactsCount || 0;
      document.getElementById('accuracy-rate').textContent = accuracyRate;

    } catch (error) {
      console.error('Error loading overview stats:', error);
    }
  }

  async function loadOverviewCharts() {
    try {
      if (conversationsChart) conversationsChart.destroy();
      if (feedbackChart) feedbackChart.destroy();

      // Load conversations over time
      const sevenDaysAgo = new Date();
      sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);

      const { data: recentConversations } = await supabase
        .from('conversations')
        .select('created_at')
        .gte('created_at', sevenDaysAgo.toISOString());

      const conversationsByDay = {};
      const last7Days = [];
      for (let i = 6; i >= 0; i--) {
        const date = new Date();
        date.setDate(date.getDate() - i);
        const dateStr = date.toISOString().split('T')[0];
        last7Days.push(dateStr);
        conversationsByDay[dateStr] = 0;
      }

      recentConversations?.forEach(conv => {
        const date = conv.created_at.split('T')[0];
        if (conversationsByDay.hasOwnProperty(date)) {
          conversationsByDay[date]++;
        }
      });

      const ctx1 = document.getElementById('conversations-chart').getContext('2d');
      conversationsChart = new Chart(ctx1, {
        type: 'line',
        data: {
          labels: last7Days.map(date => new Date(date).toLocaleDateString('en-US', { weekday: 'short' })),
          datasets: [{
            label: 'Conversations',
            data: last7Days.map(date => conversationsByDay[date]),
            borderColor: '#8B5CF6',
            backgroundColor: 'rgba(139,92,246,.1)',
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#f7f5ff' } } },
          scales: {
            x: { ticks: { color: '#bdb7e6' } },
            y: { ticks: { color: '#bdb7e6' } }
          }
        }
      });

      const { data: feedbackData } = await supabase.from('feedback').select('is_accurate');
      const accurate = feedbackData?.filter(f => f.is_accurate).length || 0;
      const inaccurate = (feedbackData?.length || 0) - accurate;

      const ctx2 = document.getElementById('feedback-chart').getContext('2d');
      feedbackChart = new Chart(ctx2, {
        type: 'doughnut',
        data: {
          labels: ['Accurate', 'Inaccurate'],
          datasets: [{ data: [accurate, inaccurate], backgroundColor: ['#22c55e', '#ef4444'] }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: { legend: { labels: { color: '#f7f5ff' } } }
        }
      });

    } catch (error) {
      console.error('Error loading charts:', error);
    }
  }

  async function loadConversations(page = 1) {
    const loading = document.getElementById('conversations-loading');
    const error = document.getElementById('conversations-error');
    const tableContainer = document.getElementById('conversations-table-container');
    const tbody = document.getElementById('conversations-tbody');

    loading.style.display = 'block';
    error.style.display = 'none';
    tableContainer.style.display = 'none';

    paginationState.conversations.currentPage = page;
    const { pageSize, searchTerm } = paginationState.conversations;
    const offset = (page - 1) * pageSize;

    try {
      let query = supabase
        .from('conversations')
        .select('id, created_at, message_count, final_analysis, language, client_ip_hash', { count: 'exact' })
        .order('created_at', { ascending: false })
        .range(offset, offset + pageSize - 1);

      if (searchTerm) {
        query = query.or(`language.ilike.%${searchTerm}%,client_ip_hash.ilike.%${searchTerm}%`);
      }

      const { data: conversations, count, error: convError } = await query;

      if (convError) throw convError;

      paginationState.conversations.totalCount = count || 0;
      const totalPages = Math.ceil(paginationState.conversations.totalCount / pageSize);

      tbody.innerHTML = conversations?.map(conv => `
        <tr>
          <td>${new Date(conv.created_at).toLocaleString()}</td>
          <td>${conv.message_count || 'N/A'}</td>
          <td><span class="status-badge ${conv.final_analysis ? 'status-completed' : 'status-pending'}">${conv.final_analysis ? 'Completed' : 'Pending'}</span></td>
          <td>${conv.language || 'N/A'}</td>
          <td>${conv.client_ip_hash ? conv.client_ip_hash.substring(0, 8) + '...' : 'N/A'}</td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">No conversations found</td></tr>';

      updatePaginationInfo('conversations', page, pageSize, paginationState.conversations.totalCount);
      generatePaginationControls('conversations', page, totalPages);
      
      document.getElementById('conversations-page-jump').max = totalPages;
      document.getElementById('conversations-page-jump').value = page;

      loading.style.display = 'none';
      tableContainer.style.display = 'block';

    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = 'Error loading conversations: ' + err.message;
    }
  }

  async function loadFeedback(page = 1) {
    const loading = document.getElementById('feedback-loading');
    const error = document.getElementById('feedback-error');
    const tableContainer = document.getElementById('feedback-table-container');
    const tbody = document.getElementById('feedback-tbody');

    loading.style.display = 'block';
    error.style.display = 'none';
    tableContainer.style.display = 'none';

    paginationState.feedback.currentPage = page;
    const { pageSize, searchTerm } = paginationState.feedback;
    const offset = (page - 1) * pageSize;

    try {
      let query = supabase
        .from('feedback')
        .select('*', { count: 'exact' })
        .order('created_at', { ascending: false })
        .range(offset, offset + pageSize - 1);

      if (searchTerm) {
        query = query.or(`comments.ilike.%${searchTerm}%,conversation_id.ilike.%${searchTerm}%`);
      }

      const { data: feedback, count, error: feedError } = await query;

      if (feedError) throw feedError;

      paginationState.feedback.totalCount = count || 0;
      const totalPages = Math.ceil(paginationState.feedback.totalCount / pageSize);

      tbody.innerHTML = feedback?.map(fb => `
        <tr>
          <td>${new Date(fb.created_at).toLocaleString()}</td>
          <td>${fb.conversation_id || 'N/A'}</td>
          <td><span class="status-badge ${fb.is_accurate ? 'status-accurate' : 'status-inaccurate'}">${fb.is_accurate ? 'Accurate' : 'Inaccurate'}</span></td>
          <td>${fb.comments ? fb.comments.substring(0, 100) + (fb.comments.length > 100 ? '...' : '') : 'N/A'}</td>
        </tr>
      `).join('') || '<tr><td colspan="4" style="text-align:center;color:var(--text-muted);">No feedback found</td></tr>';

      updatePaginationInfo('feedback', page, pageSize, paginationState.feedback.totalCount);
      generatePaginationControls('feedback', page, totalPages);
      
      document.getElementById('feedback-page-jump').max = totalPages;
      document.getElementById('feedback-page-jump').value = page;

      loading.style.display = 'none';
      tableContainer.style.display = 'block';

    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = 'Error loading feedback: ' + err.message;
    }
  }

  async function loadContacts(page = 1) {
    const loading = document.getElementById('contacts-loading');
    const error = document.getElementById('contacts-error');
    const tableContainer = document.getElementById('contacts-table-container');
    const tbody = document.getElementById('contacts-tbody');

    loading.style.display = 'block';
    error.style.display = 'none';
    tableContainer.style.display = 'none';

    paginationState.contacts.currentPage = page;
    const { pageSize, searchTerm } = paginationState.contacts;
    const offset = (page - 1) * pageSize;

    try {
      let query = supabase
        .from('contact_messages')
        .select('*', { count: 'exact' })
        .order('created_at', { ascending: false })
        .range(offset, offset + pageSize - 1);

      if (searchTerm) {
        query = query.or(`name.ilike.%${searchTerm}%,email.ilike.%${searchTerm}%,message.ilike.%${searchTerm}%`);
      }

      const { data: contacts, count, error: contactError } = await query;

      if (contactError) throw contactError;

      paginationState.contacts.totalCount = count || 0;
      const totalPages = Math.ceil(paginationState.contacts.totalCount / pageSize);

      tbody.innerHTML = contacts?.map(contact => `
        <tr>
          <td>${new Date(contact.created_at).toLocaleString()}</td>
          <td>${contact.name || 'N/A'}</td>
          <td><a href="mailto:${contact.email || ''}" style="color:var(--primary);">${contact.email || 'N/A'}</a></td>
          <td>${contact.lang || 'N/A'}</td>
          <td>${contact.message ? contact.message.substring(0, 100) + (contact.message.length > 100 ? '...' : '') : 'N/A'}</td>
        </tr>
      `).join('') || '<tr><td colspan="5" style="text-align:center;color:var(--text-muted);">No contact messages found</td></tr>';

      updatePaginationInfo('contacts', page, pageSize, paginationState.contacts.totalCount);
      generatePaginationControls('contacts', page, totalPages);
      
      document.getElementById('contacts-page-jump').max = totalPages;
      document.getElementById('contacts-page-jump').value = page;

      loading.style.display = 'none';
      tableContainer.style.display = 'block';

    } catch (err) {
      loading.style.display = 'none';
      error.style.display = 'block';
      error.textContent = 'Error loading contacts: ' + err.message;
    }
  }

  // Initialize everything
  document.addEventListener('DOMContentLoaded', async () => {
    try {
      validateDomain();
      
      if (SECURITY_CONFIG.showSecurityNotice) {
        document.getElementById('security-notice').style.display = 'block';
      }
      
      checkRateLimit();
      
      setTimeout(async () => {
        if (!initializeSupabase()) return;

        try {
          const { data: { session } } = await supabase.auth.getSession();
          if (session?.user) {
            currentUser = session.user;
            showDashboard(true);
          }
        } catch (error) {
          console.error('Session check error:', error);
        }

        supabase.auth.onAuthStateChange((event, session) => {
          if (event === 'SIGNED_OUT') {
            currentUser = null;
            showDashboard(false);
          } else if (event === 'SIGNED_IN' && session?.user) {
            currentUser = session.user;
            showDashboard(true);
          }
        });
      }, 100);
      
    } catch (error) {
      console.error('Initialization error:', error);
    }
  });

  // Security measures
  document.addEventListener('contextmenu', e => e.preventDefault());
  document.addEventListener('keydown', e => {
    if (e.key === 'F12' || (e.ctrlKey && e.shiftKey && e.key === 'I')) {
      e.preventDefault();
    }
  });
</script>
</body>
</html>