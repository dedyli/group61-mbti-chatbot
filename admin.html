// Replace the <script> section in your admin.html with this:

<script>
    // Supabase configuration - Using existing setup
    const SUPABASE_URL = 'https://okbqkkftdxazdfkiovjj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rYnFra2Z0ZHhhemRma2lvdmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDUxOTEsImV4cCI6MjA3MDcyMTE5MX0.SvYI1lxJP-dzEK5j1xGNdJu-pNtWEzVm7S2wnQBMY9c';
    
    // Admin API endpoint
    const ADMIN_API_BASE = '/.netlify/functions/admin-analytics';
    
    // Initialize Supabase client for authentication
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Global state
    let currentSession = null;
    
    // DOM elements
    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const errorMessage = document.getElementById('error-message');

    // Chart variables
    let conversationsChart, sentimentChart, mbtiChart, traitsChart, feedbackTrendsChart, issuesChart;

    // Global variables for contacts pagination
    const CONTACTS_PAGE_SIZE = 10;
    let contactsPage = 1;
    let lastContactsTotal = 0;
    let lastContactsRows = [];

    // Debug function
    function debug(message, data = null) {
      console.log(`[Admin Dashboard] ${message}`, data);
    }

    // Secure API call function using Supabase session
    async function secureApiCall(action, data = {}) {
      if (!currentSession?.access_token) {
        throw new Error('Not authenticated');
      }

      try {
        const response = await fetch(ADMIN_API_BASE, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentSession.access_token}`
          },
          body: JSON.stringify({ action, ...data })
        });

        if (!response.ok) {
          if (response.status === 401) {
            // Session expired
            await handleLogout();
            throw new Error('Session expired. Please login again.');
          }
          const errorText = await response.text();
          throw new Error(`API call failed: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'API call failed');
        }

        return result.data;

      } catch (error) {
        console.error('Secure API call error:', error);
        throw error;
      }
    }

    // Login form handler
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      // Clear previous error
      errorMessage.textContent = '';
      
      // Get form data
      const email = document.getElementById('email').value.trim();
      const password = document.getElementById('password').value;
      
      debug('Attempting login', { email });
      
      if (!email || !password) {
        errorMessage.textContent = 'Please enter both email and password';
        return;
      }
      
      errorMessage.textContent = 'Authenticating...';
      
      try {
        // Use Supabase authentication
        const { data, error } = await supabaseClient.auth.signInWithPassword({
          email: email,
          password: password
        });
        
        debug('Login response', { data: !!data, error });
        
        if (error) {
          debug('Login error', error);
          if (error.message.includes('Invalid login credentials')) {
            errorMessage.textContent = 'Invalid email or password. Please check your credentials.';
          } else if (error.message.includes('Email not confirmed')) {
            errorMessage.textContent = 'Please confirm your email address before logging in.';
          } else {
            errorMessage.textContent = error.message;
          }
        } else if (data.session) {
          debug('Login successful');
          currentSession = data.session;
          errorMessage.textContent = 'Login successful!';
          
          // Test API access
          try {
            await secureApiCall('overview_stats');
            debug('API access confirmed');
            loginForm.reset();
          } catch (apiError) {
            debug('API access failed', apiError);
            errorMessage.textContent = 'Login successful but API access failed. Please contact admin.';
          }
        } else {
          errorMessage.textContent = 'Login failed - no session returned';
        }
      } catch (err) {
        debug('Login exception', err);
        errorMessage.textContent = 'Network error. Please check your connection and try again.';
      }
    });

    // Logout handler
    logoutBtn.addEventListener('click', handleLogout);

    async function handleLogout() {
      debug('Logging out');
      try {
        await supabaseClient.auth.signOut();
      } catch (error) {
        debug('Logout error', error);
      }
      currentSession = null;
    }

    // Auth state change handler
    supabaseClient.auth.onAuthStateChange((event, session) => {
      debug('Auth state changed', { event, session: !!session });
      
      currentSession = session;
      
      if (session) {
        // User is logged in
        loginSection.style.display = 'none';
        dashboardSection.style.display = 'block';
        initializeDashboard();
      } else {
        // User is logged out
        loginSection.style.display = 'block';
        dashboardSection.style.display = 'none';
        currentSession = null;
      }
    });

    // Tab switching function
    function switchTab(tabName) {
      debug('Switching to tab', tabName);
      
      // Remove active class from all tabs and content
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
      
      // Add active class to selected tab
      const tabElement = document.getElementById(tabName + '-tab');
      if (tabElement) {
        tabElement.classList.add('active');
      }
      event.target.classList.add('active');
      
      // Load tab-specific data
      switch(tabName) {
        case 'overview':
          loadOverviewData();
          break;
        case 'mbti':
          loadMBTIAnalysis();
          break;
        case 'feedback':
          loadFeedbackAnalysis();
          break;
        case 'conversations':
          loadConversations();
          break;
        case 'contacts':
          loadContacts();
          break;
        case 'export':
          // Export tab doesn't need to load data
          break;
      }
    }

    // Initialize dashboard
    async function initializeDashboard() {
      debug('Initializing dashboard');
      try {
        await loadOverviewData();
        await loadOverviewCharts();
      } catch (err) {
        debug('Dashboard initialization error', err);
        errorMessage.textContent = `Dashboard error: ${err.message}`;
      }
    }

    // Load overview data using secure API
    async function loadOverviewData() {
      debug('Loading overview data');
      try {
        const stats = await secureApiCall('overview_stats');
        
        // Update stat displays
        document.getElementById('total-users').textContent = stats.totalUsers || 0;
        document.getElementById('total-convos').textContent = stats.totalConversations || 0;
        document.getElementById('accuracy-rate').textContent = stats.accuracyRate || 'N/A';
        document.getElementById('avg-length').textContent = stats.avgConversationLength || '0';
        document.getElementById('satisfaction').textContent = stats.completionRate || '0%';
        document.getElementById('response-time').textContent = '1.4s'; // Mock data
        
        debug('Overview stats loaded', stats);
        
      } catch (err) {
        debug('Overview data error', err);
        // Set error values
        document.getElementById('total-convos').textContent = 'Error';
        document.getElementById('total-users').textContent = 'Error';
        document.getElementById('accuracy-rate').textContent = 'Error';
        document.getElementById('satisfaction').textContent = 'Error';
      }
    }

    // Load overview charts (using mock data for now)
    async function loadOverviewCharts() {
      debug('Loading overview charts');
      
      try {
        // Destroy existing charts
        if (conversationsChart) conversationsChart.destroy();
        if (sentimentChart) sentimentChart.destroy();

        // Conversations chart
        const ctx1 = document.getElementById('conversations-chart').getContext('2d');
        conversationsChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
              label: 'Conversations',
              data: [12, 19, 15, 25, 22, 18, 28],
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139,92,246,.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#f7f5ff' } }
            },
            scales: {
              x: { ticks: { color: '#bdb7e6' } },
              y: { ticks: { color: '#bdb7e6' } }
            }
          }
        });

        // Sentiment chart
        const ctx2 = document.getElementById('sentiment-chart').getContext('2d');
        sentimentChart = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
              data: [65, 25, 10],
              backgroundColor: ['#22c55e', '#bdb7e6', '#ef4444']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#f7f5ff' } }
            }
          }
        });

      } catch (err) {
        debug('Charts error', err);
      }
    }

    // MBTI Analysis functions
    async function loadMBTIAnalysis() {
      debug('Loading MBTI analysis');
      
      try {
        const mbtiData = await secureApiCall('mbti_analysis');
        
        const total = Object.values(mbtiData).reduce((a, b) => a + b, 0);
        const grid = document.getElementById('mbti-grid');
        grid.innerHTML = '';
        
        // Create MBTI cards
        Object.entries(mbtiData).forEach(([type, count]) => {
          const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          const card = document.createElement('div');
          card.className = 'mbti-card';
          card.innerHTML = `
            <div class="type">${type}</div>
            <div class="count">${count}</div>
            <div class="percentage">${percentage}%</div>
          `;
          grid.appendChild(card);
        });
        
        // Create MBTI distribution chart
        if (mbtiChart) mbtiChart.destroy();
        const ctx = document.getElementById('mbti-chart').getContext('2d');
        mbtiChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(mbtiData),
            datasets: [{
              label: 'Count',
              data: Object.values(mbtiData),
              backgroundColor: '#8B5CF6'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#f7f5ff' } }
            },
            scales: {
              x: { ticks: { color: '#bdb7e6' } },
              y: { ticks: { color: '#bdb7e6' } }
            }
          }
        });
        
        // Create traits radar chart (mock data)
        if (traitsChart) traitsChart.destroy();
        const ctx3 = document.getElementById('traits-chart').getContext('2d');
        traitsChart = new Chart(ctx3, {
          type: 'radar',
          data: {
            labels: ['Extroversion', 'Sensing', 'Thinking', 'Judging'],
            datasets: [{
              label: 'Average Scores',
              data: [45, 60, 55, 48],
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139,92,246,.2)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#f7f5ff' } }
            },
            scales: {
              r: {
                ticks: { color: '#bdb7e6' },
                grid: { color: 'rgba(255,255,255,.1)' }
              }
            }
          }
        });
        
      } catch (err) {
        debug('MBTI analysis error', err);
        document.getElementById('mbti-grid').innerHTML = '<p>Error loading MBTI data</p>';
      }
    }

    // Feedback Analysis functions
    async function loadFeedbackAnalysis() {
      debug('Loading feedback analysis');
      
      try {
        const result = await secureApiCall('feedback');
        const { data: feedbackData, stats } = result;
        
        document.getElementById('total-feedback').textContent = stats.total || 0;
        
        if (stats.total > 0) {
          const positiveRate = ((stats.positive / stats.total) * 100).toFixed(1);
          document.getElementById('positive-rate').textContent = positiveRate + '%';
        } else {
          document.getElementById('positive-rate').textContent = 'N/A';
        }
        
        document.getElementById('common-issues').textContent = 'Response accuracy, Speed';
        document.getElementById('improvement-areas').textContent = 'Personality analysis depth';
        
        // Create feedback trends chart (mock data)
        if (feedbackTrendsChart) feedbackTrendsChart.destroy();
        const ctx4 = document.getElementById('feedback-trends-chart').getContext('2d');
        feedbackTrendsChart = new Chart(ctx4, {
          type: 'line',
          data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [
              {
                label: 'Positive Feedback',
                data: [65, 70, 68, 75],
                borderColor: '#22c55e',
                backgroundColor: 'rgba(34,197,94,.1)'
              },
              {
                label: 'Negative Feedback',
                data: [35, 30, 32, 25],
                borderColor: '#ef4444',
                backgroundColor: 'rgba(239,68,68,.1)'
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#f7f5ff' } }
            },
            scales: {
              x: { ticks: { color: '#bdb7e6' } },
              y: { ticks: { color: '#bdb7e6' } }
            }
          }
        });
        
        // Create issues chart (mock data)
        if (issuesChart) issuesChart.destroy();
        const ctx5 = document.getElementById('issues-chart').getContext('2d');
        issuesChart = new Chart(ctx5, {
          type: 'pie',
          data: {
            labels: ['Accuracy', 'Speed', 'Understanding', 'Other'],
            datasets: [{
              data: [40, 25, 20, 15],
              backgroundColor: ['#ef4444', '#f59e0b', '#8B5CF6', '#bdb7e6']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
              legend: { labels: { color: '#f7f5ff' } }
            }
          }
        });
        
      } catch (err) {
        debug('Feedback analysis error', err);
        document.getElementById('total-feedback').textContent = 'Error';
        document.getElementById('positive-rate').textContent = 'Error';
      }
    }

    // Conversations functions
    async function loadConversations() {
      debug('Loading conversations');
      
      try {
        const conversations = await secureApiCall('conversations', { limit: 20, offset: 0 });
        
        const container = document.getElementById('conversations-container');
        
        if (conversations && conversations.length > 0) {
          container.innerHTML = '';
          
          conversations.forEach(convo => {
            const item = document.createElement('div');
            item.className = 'convo-item';
            
            // Generate display data
            const sentiment = ['positive', 'neutral', 'negative'][Math.floor(Math.random() * 3)];
            const mbtiType = ['INTJ', 'ENFP', 'ISTP', 'INFJ'][Math.floor(Math.random() * 4)];
            const summary = generateConversationSummary();
            
            item.innerHTML = `
              <div class="convo-header">
                <div class="convo-meta">
                  <strong>ID:</strong> ${convo.id} | 
                  <strong>Date:</strong> ${new Date(convo.created_at).toLocaleString()} | 
                  <strong>Messages:</strong> ${convo.message_count || 'N/A'} |
                  <strong>Completed:</strong> ${convo.final_analysis ? 'Yes' : 'No'}
                </div>
                <div class="convo-tags">
                  <span class="tag">${mbtiType}</span>
                  <span class="sentiment-indicator sentiment-${sentiment}">${sentiment}</span>
                </div>
              </div>
              <div class="convo-summary">${summary}</div>
            `;
            container.appendChild(item);
          });
        } else {
          container.innerHTML = '<p>No conversations found.</p>';
        }
        
      } catch (err) {
        debug('Conversations error', err);
        document.getElementById('conversations-container').innerHTML = `<p>Error loading conversations: ${err.message}</p>`;
      }
    }

    function generateConversationSummary() {
      const summaries = [
        'User explored personality type and career recommendations',
        'Career guidance based on MBTI traits and preferences',
        'Relationship patterns and communication style analysis',
        'Decision-making processes and stress handling discussion',
        'Growth opportunities and personal development areas',
        'Leadership style and team dynamics exploration',
        'Learning preferences and study strategies',
        'Work environment and culture fit analysis'
      ];
      return summaries[Math.floor(Math.random() * summaries.length)];
    }

    function applyFilters() {
      debug('Applying conversation filters');
      loadConversations();
    }

    // Contacts functions
    async function loadContacts(page = 1) {
      debug('Loading contacts', { page });
      contactsPage = page;
      
      const tbody = document.getElementById('contacts-tbody');
      const q = (document.getElementById('contacts-q').value || '').trim();

      tbody.innerHTML = `<tr><td colspan="5" class="muted-sm">Loading...</td></tr>`;

      try {
        const offset = (contactsPage - 1) * CONTACTS_PAGE_SIZE;
        const result = await secureApiCall('contacts', { 
          limit: CONTACTS_PAGE_SIZE, 
          offset, 
          search: q 
        });
        
        const { data: contacts, total } = result;
        lastContactsTotal = total || 0;
        lastContactsRows = contacts || [];

        if (!contacts || contacts.length === 0) {
          tbody.innerHTML = `<tr><td colspan="5" class="muted-sm">No messages found.</td></tr>`;
        } else {
          tbody.innerHTML = contacts.map(r => `
            <tr>
              <td>${new Date(r.created_at).toLocaleString()}</td>
              <td>${escapeHTML(r.name || '')}</td>
              <td><a href="mailto:${encodeURIComponent(r.email || '')}">${escapeHTML(r.email || '')}</a></td>
              <td>${escapeHTML(r.lang || '')}</td>
              <td>${escapeHTML(r.message || '')}</td>
            </tr>
          `).join('');
        }

        updateContactsPagination();

      } catch (err) {
        debug('Contacts load error', err);
        tbody.innerHTML = `<tr><td colspan="5" class="muted-sm">Error: ${escapeHTML(err.message || String(err))}</td></tr>`;
      }
    }

    function updateContactsPagination() {
      const pageEl = document.getElementById('contacts-page');
      const prevEl = document.getElementById('contacts-prev');
      const nextEl = document.getElementById('contacts-next');
      const maxPage = Math.max(1, Math.ceil(lastContactsTotal / CONTACTS_PAGE_SIZE));
      
      pageEl.textContent = `Page ${contactsPage} of ${maxPage}`;
      prevEl.disabled = contactsPage <= 1;
      nextEl.disabled = contactsPage >= maxPage;
    }

    function contactsPrev() {
      if (contactsPage > 1) {
        contactsPage--;
        loadContacts(contactsPage);
      }
    }

    function contactsNext() {
      const maxPage = Math.max(1, Math.ceil(lastContactsTotal / CONTACTS_PAGE_SIZE));
      if (contactsPage < maxPage) {
        contactsPage++;
        loadContacts(contactsPage);
      }
    }

    // Export functions
    function exportData(type) {
      debug('Exporting data', type);
      alert(`Export ${type} feature will be available soon. Use the API to access raw data.`);
    }

    function exportContactsCSV() {
      if (!lastContactsRows?.length) {
        alert('No rows to export. Try Refresh first.');
        return;
      }
      const data = lastContactsRows.map(r => ({
        created_at: r.created_at,
        name: r.name,
        email: r.email,
        lang: r.lang,
        message: r.message
      }));
      const csv = convertToCSV(data, ['created_at', 'name', 'email', 'lang', 'message']);
      downloadCSV(csv, `contact_messages_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function convertToCSV(data, columns) {
      const header = columns.join(',');
      const rows = data.map(row => 
        columns.map(col => {
          const v = row[col];
          if (typeof v === 'string' && (v.includes(',') || v.includes('\n'))) {
            return `"${v.replace(/"/g, '""')}"`;
          }
          return v ?? '';
        }).join(',')
      );
      return [header, ...rows].join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    // Utility functions
    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, c => ({
        '&': '&amp;',
        '<': '&lt;',
        '>': '&gt;',
        '"': '&quot;',
        "'": '&#39;'
      }[c]));
    }

    // Initialize MBTI filter options
    document.addEventListener('DOMContentLoaded', () => {
      const types = ['INTJ', 'INTP', 'ENTJ', 'ENTP', 'INFJ', 'INFP', 'ENFJ', 'ENFP', 
                     'ISTJ', 'ISFJ', 'ESTJ', 'ESFJ', 'ISTP', 'ISFP', 'ESTP', 'ESFP'];
      const sel = document.getElementById('mbti-filter');
      types.forEach(t => {
        const o = document.createElement('option');
        o.value = t;
        o.textContent = t;
        sel.appendChild(o);
      });
      
      // Check for existing session
      supabaseClient.auth.getSession().then(({ data: { session } }) => {
        debug('Initial session check', !!session);
        currentSession = session;
      });
    });
    
    // Auto-refresh overview stats every 5 minutes when logged in
    setInterval(() => {
      if (dashboardSection.style.display !== 'none' && currentSession) {
        loadOverviewData();
      }
    }, 300000);
</script>