<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard</title>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --bg-dark: #111827;
            --bg-light: #1f2937;
            --primary: #8B5CF6;
            --text-light: #f7f5ff;
            --text-muted: #bdb7e6;
            --border-color: #374151;
            --success: #22c55e;
            --danger: #ef4444;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-light);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }

        /* Login Section */
        #login-section {
            width: 100%;
            max-width: 400px;
            padding: 2rem;
            background-color: var(--bg-light);
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        #login-section h1 {
            text-align: center;
            color: var(--text-light);
            margin-bottom: 1.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--text-muted);
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            background-color: var(--bg-dark);
            color: var(--text-light);
            border-radius: 4px;
            box-sizing: border-box;
        }

        button {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            background-color: var(--primary);
            color: white;
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        button:hover {
            background-color: #7c3aed;
        }
        
        button:disabled {
            background-color: var(--border-color);
            cursor: not-allowed;
        }

        #error-message {
            color: var(--danger);
            text-align: center;
            margin-top: 1rem;
            min-height: 1.2em;
        }
        
        /* Dashboard Section */
        #dashboard-section {
            width: 100%;
            max-width: 1200px;
            padding: 2rem;
            display: none;
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }

        .dashboard-header h1 {
            margin: 0;
        }

        #logout-btn {
            width: auto;
            padding: 0.5rem 1rem;
        }

        .tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 1.5rem;
        }

        .nav-tab {
            background: none;
            border: none;
            color: var(--text-muted);
            padding: 1rem 1.5rem;
            cursor: pointer;
            font-size: 1rem;
            width: auto;
            border-bottom: 2px solid transparent;
        }

        .nav-tab:hover {
            background-color: var(--bg-light);
            color: var(--text-light);
        }

        .nav-tab.active {
            color: var(--primary);
            border-bottom-color: var(--primary);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Overview Tab */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background-color: var(--bg-light);
            padding: 1.5rem;
            border-radius: 8px;
        }

        .stat-card h3 {
            margin: 0 0 0.5rem;
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }

        .stat-card .value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--text-light);
        }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1.5rem;
            height: 350px;
        }
        
        .chart-container {
             background-color: var(--bg-light);
             padding: 1rem;
             border-radius: 8px;
        }

        /* MBTI Tab */
        #mbti-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .mbti-card {
            background-color: var(--bg-light);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }
        
        .mbti-card .type { font-size: 1.5rem; font-weight: bold; color: var(--primary); }
        .mbti-card .count { font-size: 1.2rem; margin: 0.5rem 0; }
        .mbti-card .percentage { font-size: 0.9rem; color: var(--text-muted); }

        /* Conversations Tab */
        #conversations-container .convo-item {
            background-color: var(--bg-light);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border-left: 4px solid var(--primary);
        }
        .convo-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
        .convo-meta { font-size: 0.8rem; color: var(--text-muted); }
        .tag { background-color: var(--primary); padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; }
        .sentiment-indicator { padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.8rem; text-transform: capitalize;}
        .sentiment-positive { background-color: var(--success); }
        .sentiment-neutral { background-color: var(--text-muted); color: var(--bg-dark); }
        .sentiment-negative { background-color: var(--danger); }
        .convo-summary { font-size: 0.9rem; }
        
        /* Contacts Tab */
        .contacts-table {
            width: 100%;
            border-collapse: collapse;
            background-color: var(--bg-light);
        }
        .contacts-table th, .contacts-table td {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border-color);
            text-align: left;
        }
        .contacts-table th { color: var(--text-muted); font-weight: bold; }
        .muted-sm { color: var(--text-muted); text-align: center; }
        .contacts-controls { margin-bottom: 1rem; display: flex; gap: 1rem; }
        #contacts-q { flex-grow: 1; }
        
    </style>
</head>
<body>

    <section id="login-section">
        <h1>Admin Login</h1>
        <form id="login-form">
            <div class="form-group">
                <label for="email">Email</label>
                <input type="email" id="email" required>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <input type="password" id="password" required>
            </div>
            <button type="submit">Login</button>
        </form>
        <p id="error-message"></p>
    </section>

    <section id="dashboard-section">
        <header class="dashboard-header">
            <h1>Admin Dashboard</h1>
            <button id="logout-btn">Logout</button>
        </header>

        <nav class="tabs">
            <button class="nav-tab active" onclick="switchTab('overview')">Overview</button>
            <button class="nav-tab" onclick="switchTab('mbti')">MBTI Analysis</button>
            <button class="nav-tab" onclick="switchTab('feedback')">Feedback</button>
            <button class="nav-tab" onclick="switchTab('conversations')">Conversations</button>
            <button class="nav-tab" onclick="switchTab('contacts')">Contacts</button>
            <button class="nav-tab" onclick="switchTab('export')">Export</button>
        </nav>

        <main>
            <div id="overview-tab" class="tab-content active">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3>Total Users</h3>
                        <div id="total-users" class="value">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Total Conversations</h3>
                        <div id="total-convos" class="value">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Accuracy Rate</h3>
                        <div id="accuracy-rate" class="value">N/A</div>
                    </div>
                    <div class="stat-card">
                        <h3>Completion Rate</h3>
                        <div id="satisfaction" class="value">0%</div>
                    </div>
                     <div class="stat-card">
                        <h3>Avg. Length</h3>
                        <div id="avg-length" class="value">0</div>
                    </div>
                    <div class="stat-card">
                        <h3>Avg. Response</h3>
                        <div id="response-time" class="value">0s</div>
                    </div>
                </div>
                <div class="charts-grid">
                    <div class="chart-container">
                        <canvas id="conversations-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="sentiment-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="mbti-tab" class="tab-content">
                 <div id="mbti-grid"></div>
                 <div class="charts-grid" style="grid-template-columns: 1fr 1fr; margin-top: 2rem;">
                    <div class="chart-container">
                        <canvas id="mbti-chart"></canvas>
                    </div>
                    <div class="chart-container">
                        <canvas id="traits-chart"></canvas>
                    </div>
                </div>
            </div>

            <div id="feedback-tab" class="tab-content">
                <div class="stats-grid" style="grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));">
                    <div class="stat-card"><h3>Total Feedback</h3><div id="total-feedback" class="value">0</div></div>
                    <div class="stat-card"><h3>Positive Rate</h3><div id="positive-rate" class="value">0%</div></div>
                    <div class="stat-card"><h3>Common Issues</h3><p id="common-issues">N/A</p></div>
                    <div class="stat-card"><h3>Improvement Areas</h3><p id="improvement-areas">N/A</p></div>
                </div>
                <div class="charts-grid" style="grid-template-columns: 2fr 1fr;">
                    <div class="chart-container"><canvas id="feedback-trends-chart"></canvas></div>
                    <div class="chart-container"><canvas id="issues-chart"></canvas></div>
                </div>
            </div>

            <div id="conversations-tab" class="tab-content">
                 <div class="filters" style="margin-bottom: 1rem; display: flex; gap: 1rem;">
                    <select id="mbti-filter" class="form-group" style="background: var(--bg-light); color: var(--text-light); border: 1px solid var(--border-color); padding: 0.5rem; border-radius: 4px;"><option value="">All MBTI Types</option></select>
                    <button onclick="applyFilters()">Apply Filters</button>
                </div>
                <div id="conversations-container"></div>
            </div>
            
             <div id="contacts-tab" class="tab-content">
                <div class="contacts-controls">
                    <input type="search" id="contacts-q" placeholder="Search by name, email, or message..." class="form-group" onchange="loadContacts(1)" style="margin:0;"/>
                    <button onclick="loadContacts(1)">Refresh</button>
                    <button onclick="exportContactsCSV()">Export CSV</button>
                </div>
                <table class="contacts-table">
                    <thead>
                        <tr><th>Date</th><th>Name</th><th>Email</th><th>Lang</th><th>Message</th></tr>
                    </thead>
                    <tbody id="contacts-tbody"></tbody>
                </table>
                <div class="pagination" style="margin-top: 1rem; text-align: center;">
                    <button id="contacts-prev" onclick="contactsPrev()">&laquo; Prev</button>
                    <span id="contacts-page" style="margin: 0 1rem;">Page 1 of 1</span>
                    <button id="contacts-next" onclick="contactsNext()">Next &raquo;</button>
                </div>
            </div>
            
            <div id="export-tab" class="tab-content">
                <h2>Export Data</h2>
                <p>Select a dataset to export as CSV. For large datasets, this may take a moment.</p>
                <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                    <button onclick="exportData('conversations')">Export Conversations</button>
                    <button onclick="exportData('feedback')">Export Feedback</button>
                </div>
            </div>
        </main>
    </section>

<script>
    // Supabase configuration - Using existing setup
    const SUPABASE_URL = 'https://okbqkkftdxazdfkiovjj.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rYnFra2Z0ZHhhemRma2lvdmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDUxOTEsImV4cCI6MjA3MDcyMTE5MX0.SvYI1lxJP-dzEK5j1xGNdJu-pNtWEzVm7S2wnQBMY9c';
    
    // Admin API endpoint
    const ADMIN_API_BASE = '/.netlify/functions/admin-analytics';
    
    // Initialize Supabase client for authentication
    const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    // Global state
    let currentSession = null;
    
    // DOM elements
    const loginSection = document.getElementById('login-section');
    const dashboardSection = document.getElementById('dashboard-section');
    const loginForm = document.getElementById('login-form');
    const logoutBtn = document.getElementById('logout-btn');
    const errorMessage = document.getElementById('error-message');

    // Chart variables
    let conversationsChart, sentimentChart, mbtiChart, traitsChart, feedbackTrendsChart, issuesChart;

    // Global variables for contacts pagination
    const CONTACTS_PAGE_SIZE = 10;
    let contactsPage = 1;
    let lastContactsTotal = 0;
    let lastContactsRows = [];

    // Debug function
    function debug(message, data = null) {
      console.log(`[Admin Dashboard] ${message}`, data);
    }

    // Secure API call function using Supabase session
    async function secureApiCall(action, data = {}) {
      if (!currentSession?.access_token) {
        throw new Error('Not authenticated');
      }

      try {
        const response = await fetch(ADMIN_API_BASE, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${currentSession.access_token}`
          },
          body: JSON.stringify({ action, ...data })
        });

        if (!response.ok) {
          if (response.status === 401) {
            // Session expired
            await handleLogout();
            throw new Error('Session expired. Please login again.');
          }
          const errorText = await response.text();
          throw new Error(`API call failed: ${response.status} - ${errorText}`);
        }

        const result = await response.json();
        if (!result.success) {
          throw new Error(result.error || 'API call failed');
        }

        return result.data;

      } catch (error) {
        console.error('Secure API call error:', error);
        throw error;
      }
    }

    // Login form handler (CORRECTED VERSION)
    loginForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        errorMessage.textContent = '';
        const email = document.getElementById('email').value.trim();
        const password = document.getElementById('password').value;
        
        debug('Attempting login', { email });
        
        if (!email || !password) {
            errorMessage.textContent = 'Please enter both email and password';
            return;
        }
        
        errorMessage.textContent = 'Authenticating...';
        
        try {
            const { error } = await supabaseClient.auth.signInWithPassword({
                email: email,
                password: password
            });
            
            if (error) {
                debug('Login error', error);
                if (error.message.includes('Invalid login credentials')) {
                    errorMessage.textContent = 'Invalid email or password. Please check your credentials.';
                } else if (error.message.includes('Email not confirmed')) {
                    errorMessage.textContent = 'Please confirm your email address before logging in.';
                } else {
                    errorMessage.textContent = error.message;
                }
            } else {
                errorMessage.textContent = '';
                loginForm.reset();
            }
        } catch (err) {
            debug('Login exception', err);
            errorMessage.textContent = 'Network error. Please check your connection and try again.';
        }
    });


    // Logout handler
    logoutBtn.addEventListener('click', handleLogout);

    async function handleLogout() {
      debug('Logging out');
      try {
        await supabaseClient.auth.signOut();
      } catch (error) {
        debug('Logout error', error);
      }
      currentSession = null;
    }

    // Auth state change handler
    supabaseClient.auth.onAuthStateChange((event, session) => {
      debug('Auth state changed', { event, session: !!session });
      
      currentSession = session;
      
      if (session) {
        // User is logged in
        loginSection.style.display = 'none';
        dashboardSection.style.display = 'block';
        initializeDashboard();
      } else {
        // User is logged out
        loginSection.style.display = 'block';
        dashboardSection.style.display = 'none';
        currentSession = null;
      }
    });

    // Tab switching function
    function switchTab(tabName) {
      debug('Switching to tab', tabName);
      
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.nav-tab').forEach(b => b.classList.remove('active'));
      
      document.getElementById(tabName + '-tab').classList.add('active');
      event.target.classList.add('active');
      
      switch(tabName) {
        case 'overview':
          loadOverviewData();
          break;
        case 'mbti':
          loadMBTIAnalysis();
          break;
        case 'feedback':
          loadFeedbackAnalysis();
          break;
        case 'conversations':
          loadConversations();
          break;
        case 'contacts':
          loadContacts();
          break;
        case 'export':
          break;
      }
    }

    // Initialize dashboard
    async function initializeDashboard() {
      debug('Initializing dashboard');
      try {
        await loadOverviewData();
        await loadOverviewCharts();
      } catch (err) {
        debug('Dashboard initialization error', err);
        errorMessage.textContent = `Dashboard error: ${err.message}`;
      }
    }

    // Load overview data using secure API
    async function loadOverviewData() {
      debug('Loading overview data');
      try {
        const stats = await secureApiCall('overview_stats');
        
        document.getElementById('total-users').textContent = stats.totalUsers || 0;
        document.getElementById('total-convos').textContent = stats.totalConversations || 0;
        document.getElementById('accuracy-rate').textContent = stats.accuracyRate || 'N/A';
        document.getElementById('avg-length').textContent = stats.avgConversationLength || '0';
        document.getElementById('satisfaction').textContent = stats.completionRate || '0%';
        document.getElementById('response-time').textContent = '1.4s'; // Mock data
        
        debug('Overview stats loaded', stats);
        
      } catch (err) {
        debug('Overview data error', err);
        document.getElementById('total-convos').textContent = 'Error';
        document.getElementById('total-users').textContent = 'Error';
        document.getElementById('accuracy-rate').textContent = 'Error';
        document.getElementById('satisfaction').textContent = 'Error';
      }
    }

    // Load overview charts
    async function loadOverviewCharts() {
      debug('Loading overview charts');
      
      try {
        if (conversationsChart) conversationsChart.destroy();
        if (sentimentChart) sentimentChart.destroy();

        const ctx1 = document.getElementById('conversations-chart').getContext('2d');
        conversationsChart = new Chart(ctx1, {
          type: 'line',
          data: {
            labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
            datasets: [{
              label: 'Conversations',
              data: [12, 19, 15, 25, 22, 18, 28],
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139,92,246,.1)',
              tension: 0.4
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f7f5ff' } } },
            scales: {
              x: { ticks: { color: '#bdb7e6' } },
              y: { ticks: { color: '#bdb7e6' } }
            }
          }
        });

        const ctx2 = document.getElementById('sentiment-chart').getContext('2d');
        sentimentChart = new Chart(ctx2, {
          type: 'doughnut',
          data: {
            labels: ['Positive', 'Neutral', 'Negative'],
            datasets: [{
              data: [65, 25, 10],
              backgroundColor: ['#22c55e', '#bdb7e6', '#ef4444']
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f7f5ff' } } }
          }
        });

      } catch (err) {
        debug('Charts error', err);
      }
    }

    // MBTI Analysis functions
    async function loadMBTIAnalysis() {
      debug('Loading MBTI analysis');
      try {
        const mbtiData = await secureApiCall('mbti_analysis');
        const total = Object.values(mbtiData).reduce((a, b) => a + b, 0);
        const grid = document.getElementById('mbti-grid');
        grid.innerHTML = '';
        
        Object.entries(mbtiData).forEach(([type, count]) => {
          const percentage = total > 0 ? ((count / total) * 100).toFixed(1) : '0.0';
          const card = document.createElement('div');
          card.className = 'mbti-card';
          card.innerHTML = `<div class="type">${type}</div><div class="count">${count}</div><div class="percentage">${percentage}%</div>`;
          grid.appendChild(card);
        });
        
        if (mbtiChart) mbtiChart.destroy();
        const ctx = document.getElementById('mbti-chart').getContext('2d');
        mbtiChart = new Chart(ctx, {
          type: 'bar',
          data: {
            labels: Object.keys(mbtiData),
            datasets: [{ label: 'Count', data: Object.values(mbtiData), backgroundColor: '#8B5CF6' }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f7f5ff' } } },
            scales: { x: { ticks: { color: '#bdb7e6' } }, y: { ticks: { color: '#bdb7e6' } } }
          }
        });
        
        if (traitsChart) traitsChart.destroy();
        const ctx3 = document.getElementById('traits-chart').getContext('2d');
        traitsChart = new Chart(ctx3, {
          type: 'radar',
          data: {
            labels: ['Extroversion', 'Sensing', 'Thinking', 'Judging'],
            datasets: [{
              label: 'Average Scores',
              data: [45, 60, 55, 48],
              borderColor: '#8B5CF6',
              backgroundColor: 'rgba(139,92,246,.2)'
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f7f5ff' } } },
            scales: { r: { ticks: { color: '#bdb7e6' }, grid: { color: 'rgba(255,255,255,.1)' } } }
          }
        });
      } catch (err) {
        debug('MBTI analysis error', err);
        document.getElementById('mbti-grid').innerHTML = '<p>Error loading MBTI data</p>';
      }
    }

    // Feedback Analysis functions
    async function loadFeedbackAnalysis() {
      debug('Loading feedback analysis');
      try {
        const result = await secureApiCall('feedback');
        const { stats } = result;
        
        document.getElementById('total-feedback').textContent = stats.total || 0;
        document.getElementById('positive-rate').textContent = stats.total > 0 ? `${((stats.positive / stats.total) * 100).toFixed(1)}%` : 'N/A';
        document.getElementById('common-issues').textContent = 'Response accuracy, Speed';
        document.getElementById('improvement-areas').textContent = 'Personality analysis depth';
        
        if (feedbackTrendsChart) feedbackTrendsChart.destroy();
        const ctx4 = document.getElementById('feedback-trends-chart').getContext('2d');
        feedbackTrendsChart = new Chart(ctx4, {
          type: 'line',
          data: {
            labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
            datasets: [
              { label: 'Positive Feedback', data: [65, 70, 68, 75], borderColor: '#22c55e', backgroundColor: 'rgba(34,197,94,.1)' },
              { label: 'Negative Feedback', data: [35, 30, 32, 25], borderColor: '#ef4444', backgroundColor: 'rgba(239,68,68,.1)' }
            ]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f7f5ff' } } },
            scales: { x: { ticks: { color: '#bdb7e6' } }, y: { ticks: { color: '#bdb7e6' } } }
          }
        });
        
        if (issuesChart) issuesChart.destroy();
        const ctx5 = document.getElementById('issues-chart').getContext('2d');
        issuesChart = new Chart(ctx5, {
          type: 'pie',
          data: {
            labels: ['Accuracy', 'Speed', 'Understanding', 'Other'],
            datasets: [{ data: [40, 25, 20, 15], backgroundColor: ['#ef4444', '#f59e0b', '#8B5CF6', '#bdb7e6'] }]
          },
          options: {
            responsive: true, maintainAspectRatio: false,
            plugins: { legend: { labels: { color: '#f7f5ff' } } }
          }
        });
      } catch (err) {
        debug('Feedback analysis error', err);
        document.getElementById('total-feedback').textContent = 'Error';
        document.getElementById('positive-rate').textContent = 'Error';
      }
    }

    // Conversations functions
    async function loadConversations() {
      debug('Loading conversations');
      try {
        const conversations = await secureApiCall('conversations', { limit: 20, offset: 0 });
        const container = document.getElementById('conversations-container');
        if (conversations && conversations.length > 0) {
          container.innerHTML = conversations.map(convo => {
            const sentiment = ['positive', 'neutral', 'negative'][Math.floor(Math.random() * 3)];
            const mbtiType = ['INTJ', 'ENFP', 'ISTP', 'INFJ'][Math.floor(Math.random() * 4)];
            const summary = generateConversationSummary();
            return `
              <div class="convo-item">
                <div class="convo-header">
                  <div class="convo-meta">
                    <strong>ID:</strong> ${convo.id} | 
                    <strong>Date:</strong> ${new Date(convo.created_at).toLocaleString()} | 
                    <strong>Messages:</strong> ${convo.message_count || 'N/A'} |
                    <strong>Completed:</strong> ${convo.final_analysis ? 'Yes' : 'No'}
                  </div>
                  <div class="convo-tags">
                    <span class="tag">${mbtiType}</span>
                    <span class="sentiment-indicator sentiment-${sentiment}">${sentiment}</span>
                  </div>
                </div>
                <div class="convo-summary">${summary}</div>
              </div>
            `;
          }).join('');
        } else {
          container.innerHTML = '<p>No conversations found.</p>';
        }
      } catch (err) {
        debug('Conversations error', err);
        document.getElementById('conversations-container').innerHTML = `<p>Error loading conversations: ${err.message}</p>`;
      }
    }

    function generateConversationSummary() {
      const summaries = [
        'User explored personality type and career recommendations',
        'Career guidance based on MBTI traits and preferences',
        'Relationship patterns and communication style analysis',
        'Decision-making processes and stress handling discussion',
      ];
      return summaries[Math.floor(Math.random() * summaries.length)];
    }

    function applyFilters() {
      debug('Applying conversation filters');
      loadConversations();
    }

    // Contacts functions
    async function loadContacts(page = 1) {
      debug('Loading contacts', { page });
      contactsPage = page;
      const tbody = document.getElementById('contacts-tbody');
      const q = (document.getElementById('contacts-q').value || '').trim();
      tbody.innerHTML = `<tr><td colspan="5" class="muted-sm">Loading...</td></tr>`;

      try {
        const offset = (contactsPage - 1) * CONTACTS_PAGE_SIZE;
        const result = await secureApiCall('contacts', { limit: CONTACTS_PAGE_SIZE, offset, search: q });
        const { data: contacts, total } = result;
        lastContactsTotal = total || 0;
        lastContactsRows = contacts || [];

        tbody.innerHTML = (contacts && contacts.length > 0)
          ? contacts.map(r => `
            <tr>
              <td>${new Date(r.created_at).toLocaleString()}</td>
              <td>${escapeHTML(r.name || '')}</td>
              <td><a href="mailto:${encodeURIComponent(r.email || '')}">${escapeHTML(r.email || '')}</a></td>
              <td>${escapeHTML(r.lang || '')}</td>
              <td>${escapeHTML(r.message || '')}</td>
            </tr>`).join('')
          : `<tr><td colspan="5" class="muted-sm">No messages found.</td></tr>`;
        
        updateContactsPagination();
      } catch (err) {
        debug('Contacts load error', err);
        tbody.innerHTML = `<tr><td colspan="5" class="muted-sm">Error: ${escapeHTML(err.message || String(err))}</td></tr>`;
      }
    }

    function updateContactsPagination() {
      const pageEl = document.getElementById('contacts-page');
      const prevEl = document.getElementById('contacts-prev');
      const nextEl = document.getElementById('contacts-next');
      const maxPage = Math.max(1, Math.ceil(lastContactsTotal / CONTACTS_PAGE_SIZE));
      pageEl.textContent = `Page ${contactsPage} of ${maxPage}`;
      prevEl.disabled = contactsPage <= 1;
      nextEl.disabled = contactsPage >= maxPage;
    }

    function contactsPrev() { if (contactsPage > 1) { loadContacts(contactsPage - 1); } }
    function contactsNext() {
      const maxPage = Math.max(1, Math.ceil(lastContactsTotal / CONTACTS_PAGE_SIZE));
      if (contactsPage < maxPage) { loadContacts(contactsPage + 1); }
    }

    // Export functions
    function exportData(type) {
      debug('Exporting data', type);
      alert(`Export ${type} feature will be available soon. Use the API to access raw data.`);
    }

    function exportContactsCSV() {
      if (!lastContactsRows?.length) {
        alert('No rows to export. Try Refresh first.');
        return;
      }
      const data = lastContactsRows.map(r => ({ ...r }));
      const csv = convertToCSV(data, ['created_at', 'name', 'email', 'lang', 'message']);
      downloadCSV(csv, `contact_messages_${new Date().toISOString().split('T')[0]}.csv`);
    }

    function convertToCSV(data, columns) {
      const header = columns.join(',');
      const rows = data.map(row => 
        columns.map(col => {
          const v = row[col];
          return (typeof v === 'string' && (v.includes(',') || v.includes('\n'))) ? `"${v.replace(/"/g, '""')}"` : v ?? '';
        }).join(',')
      );
      return [header, ...rows].join('\n');
    }

    function downloadCSV(csv, filename) {
      const blob = new Blob([csv], { type: 'text/csv' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = filename;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);
    }

    function escapeHTML(str) {
      return String(str).replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    document.addEventListener('DOMContentLoaded', () => {
      const types = ['INTJ','INTP','ENTJ','ENTP','INFJ','INFP','ENFJ','ENFP','ISTJ','ISFJ','ESTJ','ESFJ','ISTP','ISFP','ESTP','ESFP'];
      const sel = document.getElementById('mbti-filter');
      types.forEach(t => {
        const o = document.createElement('option');
        o.value = t; o.textContent = t; sel.appendChild(o);
      });
      
      supabaseClient.auth.getSession().then(({ data: { session } }) => {
        debug('Initial session check', !!session);
        currentSession = session;
      });
    });
    
    setInterval(() => {
      if (dashboardSection.style.display !== 'none' && currentSession) {
        loadOverviewData();
      }
    }, 300000); // Auto-refresh overview stats every 5 minutes
</script>

</body>
</html>