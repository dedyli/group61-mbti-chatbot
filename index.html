<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind‑Mapper AI — Sophisticated MBTI Personality Analyst</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet" />
  <style>
    :root{ --bg:#0b0a13; --fg:#f7f5ff; --muted:#bdb7e6; --accent:#8B5CF6; --accent-2:#F0A6FF; --gold:#EED972; --glass:rgba(255,255,255,.08); --glass-stroke:rgba(255,255,255,.12); }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{ margin:0; color:var(--fg); background:var(--bg); font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; overflow-x:hidden; }

    /* Bilingual helpers */
    [data-lang]{display:none}
    body.lang-en [data-lang="en"], body.lang-en .block-en{display:initial}
    body.lang-vi [data-lang="vi"], body.lang-vi .block-vi{display:initial}

    /* Aurora */
    .aurora{position:fixed; inset:0; z-index:-2; pointer-events:none; background:
      radial-gradient(60vw 60vw at -10% -10%, rgba(139,92,246,.35), transparent 60%),
      radial-gradient(50vw 50vw at 110% 10%, rgba(240,166,255,.25), transparent 60%),
      radial-gradient(40vw 40vw at 50% 110%, rgba(238,217,114,.18), transparent 60%),
      radial-gradient(25vw 25vw at 20% 70%, rgba(139,92,246,.18), transparent 70%);
      filter:saturate(120%) blur(10px); animation:auroraShift 24s ease-in-out infinite alternate; }
    @keyframes auroraShift{to{transform:translateY(-2%) scale(1.02)}}
    .sparkles{position:fixed; inset:0; z-index:-1; pointer-events:none}
    .sparkles i{position:absolute; width:2px; height:2px; border-radius:50%; background:rgba(255,255,255,.55); filter:blur(.2px); opacity:.4; animation:float 16s linear infinite}
    @keyframes float{to{transform:translateY(-120vh)}}

    /* Header */
    header{ position:sticky; top:16px; z-index:50; display:flex; gap:16px; align-items:center; justify-content:space-between; margin:16px auto 0; max-width:1200px; padding:12px 16px; border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); -webkit-backdrop-filter:blur(14px) saturate(140%); backdrop-filter:blur(14px) saturate(140%); border:1px solid var(--glass-stroke); box-shadow:0 8px 28px rgba(0,0,0,.25); }
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{width:120px; height:40px; object-fit:contain; border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .brand h1{margin:0; font-family:'Playfair Display',serif; font-weight:800; font-size:20px; letter-spacing:.3px}
    nav ul{margin:0; padding:0; list-style:none; display:flex; gap:8px; align-items:center}
    nav a{ color:var(--fg); text-decoration:none; font-weight:600; font-size:14px; letter-spacing:.3px; padding:10px 14px; border-radius:999px; position:relative; overflow:hidden; }
    nav a:after{content:""; position:absolute; inset:0; background:linear-gradient(90deg,var(--accent),var(--accent-2)); opacity:0; transition:.35s}
    nav a:hover:after, nav a.active:after{opacity:.25}
    .lang{display:flex; align-items:center; gap:8px}
    .pill{border:1px solid var(--glass-stroke); background:var(--glass); padding:8px 10px; border-radius:999px; display:flex; align-items:center; gap:8px}
    .pill select{background:transparent; border:none; color:var(--fg); font-weight:600}

    .container{max-width:1200px; margin:0 auto; padding:64px 16px}

    /* Hero */
    .hero{display:grid; grid-template-columns:1.1fr .9fr; align-items:center; gap:48px; padding-top:48px}
    .title{ font-family:'Playfair Display',serif; font-weight:800; font-size:clamp(36px,6vw,64px); line-height:1.04; letter-spacing:-.3px; margin:0 0 16px; position:relative; background:linear-gradient(180deg,#fff, #d7d0ff 60%, #b9b0ff); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 8px 28px rgba(139,92,246,.15) }
    .subtitle{color:var(--muted); font-weight:600; font-size:18px; margin-bottom:20px}
    .lead{color:#dbd7ff; opacity:.9; max-width:56ch; line-height:1.8; margin-bottom:28px}
    .cta{ display:inline-flex; gap:10px; align-items:center; padding:14px 18px; border-radius:14px; font-weight:700; text-decoration:none; color:#0b0a13; background:linear-gradient(90deg, var(--gold), #FFEBA4); box-shadow:0 10px 30px rgba(238,217,114,.35); transition:transform .2s ease, box-shadow .2s ease }
    .cta:hover{transform:translateY(-2px); box-shadow:0 16px 36px rgba(238,217,114,.45)}

    .illustrationWrap{position:relative}
    .card3d{ position:relative; border-radius:24px; overflow:hidden; border:1px solid var(--glass-stroke); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow:0 30px 80px rgba(0,0,0,.35); transform:perspective(1000px) rotateX(0) rotateY(0); transition:transform .2s ease }
    .hero-img{display:block; width:100%; height:auto; aspect-ratio:4/3; object-fit:cover}
    .revealMask{ position:absolute; inset:0; background:conic-gradient(from 45deg at 0% 0%, transparent 0 10%, black 10% 20%, transparent 20% 30%, black 30% 40%, transparent 40% 50%, black 50% 60%, transparent 60% 70%, black 70% 80%, transparent 80% 90%, black 90% 100%); transform:translate(-120%, -120%) rotate(0.0001deg); filter:blur(1.2px) contrast(120%); animation:reveal 2.8s cubic-bezier(.2,.8,.2,1) .3s forwards }
    @keyframes reveal{to{transform:translate(0,0)}}
    .badge{position:absolute; right:16px; top:16px; padding:10px 14px; border-radius:12px; font-weight:700; color:#0b0a13; background:linear-gradient(90deg,#fff,#f7f5ff); box-shadow:0 10px 30px rgba(255,255,255,.25)}

    /* Sections */
    .section{padding:72px 0}
    .section h2{font-family:'Playfair Display',serif; font-size:clamp(28px,3.2vw,40px); margin:0 0 24px}
    .muted{color:var(--muted)}

    .steps{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    .step{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid var(--glass-stroke); border-radius:20px; padding:22px; position:relative; overflow:hidden; transition:transform .25s ease, box-shadow .25s ease }
    .step:hover{transform:translateY(-6px); box-shadow:0 24px 60px rgba(0,0,0,.35)}
    .step .n{width:38px; height:38px; display:grid; place-items:center; border-radius:999px; font-weight:800; color:#0b0a13; background:linear-gradient(90deg,var(--accent),var(--accent-2)); box-shadow:0 8px 22px rgba(139,92,246,.45)}
    .step h3{margin:12px 0 8px; font-weight:800}
    .step p{margin:0; color:#e9e7ff; opacity:.9}

    .faq{max-width:920px}
    details{background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border:1px solid var(--glass-stroke); border-radius:16px; padding:18px 20px; margin:10px 0}
    summary{cursor:pointer; font-weight:700}
    details[open]{box-shadow:0 16px 40px rgba(0,0,0,.35)}

    form{max-width:760px}
    input,textarea,select,button{font-family:inherit}
    .field{display:grid; gap:8px}
    .field input,.field textarea{ background:rgba(255,255,255,.04); border:1px solid var(--glass-stroke); color:var(--fg); padding:14px 16px; border-radius:12px }
    .btn{ border:none; cursor:pointer; padding:14px 18px; border-radius:14px; font-weight:800; letter-spacing:.3px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b0a13; box-shadow:0 12px 34px rgba(139,92,246,.35) }

    /* Chat widget */
    .chat-launch{ position:fixed; right:18px; bottom:18px; z-index:10000; display:flex; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08)); border:1px solid var(--glass-stroke); padding:10px 12px; border-radius:999px; -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px); box-shadow:0 14px 42px rgba(0,0,0,.45); cursor:pointer }
    .chat-launch b{background:linear-gradient(90deg,var(--gold),#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
    .chat-panel{ position:fixed; right:18px; bottom:78px; width:min(420px, calc(100vw - 32px)); height:min(68vh, 720px); border-radius:24px; overflow:hidden; display:none; z-index:9999; background:linear-gradient(178deg, rgba(20,20,28,.96), rgba(16,15,22,.96)); border:1px solid var(--glass-stroke); box-shadow:0 30px 80px rgba(0,0,0,.55) }
    .chat-panel.open{display:block}
    .chat-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--glass-stroke)}
    .chat-head h3{margin:0; font-family:'Playfair Display',serif; letter-spacing:.3px}
    .chat-body{padding:14px; height:calc(100% - 124px); overflow:auto; display:flex; flex-direction:column; gap:12px}
    .msg{display:flex; gap:10px; align-items:flex-start}
    .msg .bubble{max-width:85%; padding:12px 14px; border-radius:14px; line-height:1.6}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b0a13; border-top-right-radius:4px}
    .msg.ai .bubble{background:rgba(255,255,255,.06); border:1px solid var(--glass-stroke); border-top-left-radius:4px}
    .chat-foot{padding:12px; border-top:1px solid var(--glass-stroke); display:grid; grid-template-columns:1fr auto; gap:8px}
    .chat-foot input{background:rgba(255,255,255,.06); border:1px solid var(--glass-stroke); color:var(--fg); padding:12px 14px; border-radius:12px; width:100%; outline:none}
    .chat-foot input:focus{border-color:rgba(139,92,246,.6); box-shadow:0 0 0 3px rgba(139,92,246,.25)}
    .model-select{display:flex; gap:8px; align-items:center}
    .model-select select{background:transparent; color:var(--fg); border:1px solid var(--glass-stroke); padding:6px 8px; border-radius:8px}
    .notice{font-size:12px; color:#cfcaff; opacity:.8}

    @media (max-width:960px){ .hero{grid-template-columns:1fr; padding-top:16px} header{border-radius:20px} }
  </style>
</head>
<body>
  <div class="aurora"></div>
  <div class="sparkles" id="sparkles"></div>

  <header>
    <div class="brand">
      <img src="Tsinghua_University_logo_and_wordmark_in_Chinese_and_English_characters.svg.png" alt="Tsinghua" />
      <h1>Mind‑Mapper AI</h1>
    </div>
    <nav>
      <ul>
        <li><a class="active" href="#home"><span data-lang="en">Home</span><span data-lang="vi">Trang chủ</span></a></li>
        <li><a href="#how"><span data-lang="en">How it works</span><span data-lang="vi">Cách hoạt động</span></a></li>
        <li><a href="#about"><span data-lang="en">About Group 61</span><span data-lang="vi">Về Nhóm 61</span></a></li>
        <li><a href="#faq"><span>FAQ</span></a></li>
        <li><a href="#contact"><span data-lang="en">Contact</span><span data-lang="vi">Liên hệ</span></a></li>
      </ul>
    </nav>
    <div class="lang pill">
      <span>🌐</span>
      <select id="language">
        <option value="en" selected>English</option>
        <option value="vi">Tiếng Việt</option>
      </select>
    </div>
  </header>

  <main class="container" id="home">
    <section class="hero">
      <div>
        <h2 class="title">
          <span data-lang="en">Conversational MBTI Personality Insights — refined for students</span>
          <span data-lang="vi">Trò chuyện MBTI tinh tế — dành cho học sinh, sinh viên</span>
        </h2>
        <p class="subtitle">
          <span data-lang="en">A warm, human‑like conversation that reveals strengths, tendencies, and growth tips.</span>
          <span data-lang="vi">Một cuộc trò chuyện ấm áp, tự nhiên để hé lộ thế mạnh, xu hướng và gợi ý phát triển.</span>
        </p>
        <p class="lead">
          <span data-lang="en">No rigid multiple‑choice. Just natural chat. When you're ready, open the assistant below and start talking. After a brief exchange, you'll get a thoughtful MBTI‑style profile, confidence level, and practical suggestions.</span>
          <span data-lang="vi">Không cần trắc nghiệm cứng nhắc — chỉ trò chuyện tự nhiên. Khi sẵn sàng, mở trợ lý và bắt đầu. Chỉ sau vài tin nhắn, bạn sẽ nhận được hồ sơ MBTI ngắn gọn, mức độ tự tin và các gợi ý thực tiễn.</span>
        </p>
        <a class="cta" href="#how"><span data-lang="en">Begin your journey</span><span data-lang="vi">Bắt đầu hành trình</span> →</a>
      </div>
      <div class="illustrationWrap">
        <div class="card3d" id="card3d">
          <img class="hero-img" src="vietnam_students.png" alt="Students collaborating"/>
        </div>
      </div>
    </section>

    <section class="section" id="how">
      <h2><span data-lang="en">How it works</span><span data-lang="vi">Cách hoạt động</span></h2>
      <p class="muted"><span data-lang="en">Simple, elegant, respectful of your time.</span><span data-lang="vi">Đơn giản, tinh tế, tôn trọng thời gian của bạn.</span></p>
      <div class="steps">
        <div class="step">
          <span class="n">1</span>
          <h3><span data-lang="en">Start a natural chat</span><span data-lang="vi">Bắt đầu trò chuyện tự nhiên</span></h3>
          <p><span data-lang="en">Say hello and share how you like to study, socialize, and make decisions.</span><span data-lang="vi">Hãy chào và chia sẻ cách bạn học, giao tiếp và ra quyết định.</span></p>
        </div>
        <div class="step">
          <span class="n">2</span>
          <h3><span data-lang="en">Be yourself</span><span data-lang="vi">Hãy là chính mình</span></h3>
          <p><span data-lang="en">The assistant listens for patterns across the four MBTI axes.</span><span data-lang="vi">Trợ lý lắng nghe các mẫu hành vi theo bốn trục MBTI.</span></p>
        </div>
        <div class="step">
          <span class="n">3</span>
          <h3><span data-lang="en">Receive your profile</span><span data-lang="vi">Nhận hồ sơ của bạn</span></h3>
          <p><span data-lang="en">Get a concise MBTI‑style type with confidence, traits, and friendly development tips.</span><span data-lang="vi">Nhận kiểu MBTI, mức tự tin, đặc trưng nổi bật và gợi ý phát triển.</span></p>
        </div>
      </div>
    </section>

    <section class="section" id="about">
      <h2><span data-lang="en">About Group 61</span><span data-lang="vi">Về Nhóm 61</span></h2>
      <p class="muted">
        <span data-lang="en">We are Group 61 from Tsinghua University's IEDE 2025 program. Mind‑Mapper AI was born from our passion to use technology for self‑awareness and growth.</span>
        <span data-lang="vi">Chúng tôi là Nhóm 61 của chương trình IEDE 2025 (ĐH Thanh Hoa). Mind‑Mapper AI xuất phát từ niềm đam mê ứng dụng công nghệ để thúc đẩy tự nhận thức và phát triển bản thân.</span>
      </p>
      <p class="muted" style="margin-top:10px">
        <span data-lang="en">Our goal is to make personality analysis accessible, engaging, and modern for students.</span>
        <span data-lang="vi">Mục tiêu của chúng tôi là khiến phân tích tính cách trở nên gần gũi, thú vị và hiện đại cho học sinh, sinh viên.</span>
      </p>
    </section>

    <section class="section faq" id="faq">
      <h2>FAQ</h2>
      <details>
        <summary><span data-lang="en">What is the MBTI?</span><span data-lang="vi">MBTI là gì?</span></summary>
        <p><span data-lang="en">The Myers‑Briggs Type Indicator describes preferences in how people perceive information and make decisions, grouping into 16 types.</span><span data-lang="vi">MBTI mô tả khuynh hướng trong cách con người tiếp nhận thông tin và ra quyết định, phân loại thành 16 kiểu tính cách.</span></p>
      </details>
      <details>
        <summary><span data-lang="en">Is this a clinical assessment?</span><span data-lang="vi">Đây có phải đánh giá lâm sàng?</span></summary>
        <p><span data-lang="en">No—it's a self‑reflection tool powered by AI. Use it for guidance, not diagnosis.</span><span data-lang="vi">Không—đây là công cụ tự phản chiếu do AI hỗ trợ. Dùng để tham khảo, không phải chẩn đoán.</span></p>
      </details>
      <details>
        <summary><span data-lang="en">Is my data private and secure?</span><span data-lang="vi">Dữ liệu của tôi có riêng tư và an toàn?</span></summary>
        <p><span data-lang="en">On‑device mode keeps text in your browser. If you switch to a cloud model, text is sent only to that provider.</span><span data-lang="vi">Chế độ chạy tại chỗ giữ văn bản trong trình duyệt. Nếu dùng mô hình đám mây, nội dung chỉ gửi tới nhà cung cấp đó.</span></p>
      </details>
      <details>
        <summary><span data-lang="en">How long does it take?</span><span data-lang="vi">Mất bao lâu?</span></summary>
        <p><span data-lang="en">Usually 5–10 minutes to get a first profile.</span><span data-lang="vi">Thường 5–10 phút để có hồ sơ đầu tiên.</span></p>
      </details>
    </section>

    <section class="section" id="contact">
      <h2><span data-lang="en">Get in touch</span><span data-lang="vi">Liên hệ</span></h2>
      <form onsubmit="event.preventDefault(); this.reset(); alert(document.body.classList.contains('lang-vi') ? 'Cảm ơn! Chúng tôi sẽ liên hệ.' : 'Thanks! We\'ll be in touch.');">
        <div class="field">
          <label><span data-lang="en">Name</span><span data-lang="vi">Tên</span></label>
          <input required data-lang-en-placeholder="Your name" data-lang-vi-placeholder="Tên của bạn" />
        </div>
        <div class="field" style="margin-top:10px">
          <label><span data-lang="en">Email</span><span data-lang="vi">Email</span></label>
          <input type="email" required data-lang-en-placeholder="you@example.com" data-lang-vi-placeholder="ban@example.com" />
        </div>
        <div class="field" style="margin-top:10px">
          <label><span data-lang="en">Message</span><span data-lang="vi">Tin nhắn</span></label>
          <textarea rows="5" required data-lang-en-placeholder="How can we help?" data-lang-vi-placeholder="Chúng tôi có thể giúp gì?\u2026"></textarea>
        </div>
        <button class="btn" style="margin-top:12px"><span data-lang="en">Send message</span><span data-lang="vi">Gửi tin nhắn</span></button>
      </form>
    </section>
  </main>

  <!-- Chat launcher and panel -->
  <button class="chat-launch" id="chatOpen" title="Open Mind‑Mapper AI"> 🧠 <b><span data-lang="en">Chat</span><span data-lang="vi">Trò chuyện</span></b> </button>
  <div class="chat-panel open" id="chatPanel" aria-live="polite">
    <div class="chat-head">
      <h3>Mind‑Mapper AI — Personality Analyst</h3>
      <div class="model-select">
        <label for="model">Model:</label>
        <select id="model">
          <option value="webllm">On‑device (WebGPU)</option>
          <option value="openrouter">OpenRouter (free tier models)</option>
        </select>
      </div>
    </div>
    <div class="chat-body" id="chatBody">
      <div class="msg ai"><div class="bubble"><span data-lang="en">Hi! I’m your MBTI‑style personality analyst. Share how you approach studying, friends, and decisions. I’ll reflect back patterns and, when you’re ready, I can infer a type with a confidence score.</span><span data-lang="vi">Xin chào! Tôi là trợ lý phân tích tính cách theo MBTI. Hãy chia sẻ cách bạn học tập, kết bạn và ra quyết định. Tôi sẽ phản hồi những mẫu hành vi và khi bạn sẵn sàng, tôi có thể suy luận kiểu MBTI kèm mức độ tự tin.</span></div></div>
    </div>
    <div class="chat-foot">
      <input id="chatInput" placeholder="Type your message…" />
      <button class="btn" id="sendBtn"><span data-lang="en">Send</span><span data-lang="vi">Gửi</span></button>
    </div>
    <div class="notice" style="padding:8px 12px">Tip: After a few messages, type <b>"Give me my MBTI"</b>.</div>
  </div>

  <!-- WebLLM runtime (on‑device free LLM) -->
  <script src="https://unpkg.com/@mlc-ai/web-llm@0.2.73/dist/index.min.js"></script>
  <script>
    // Sparkles
    (function makeSparkles(){ const host=document.getElementById('sparkles'); for(let i=0;i<120;i++){ const s=document.createElement('i'); s.style.left=Math.random()*100+'vw'; s.style.top=(100+Math.random()*100)+'vh'; s.style.animationDuration=(10+Math.random()*16)+'s'; host.appendChild(s);} })();

    // 3D tilt
    (function tilt(){ const card=document.getElementById('card3d'); let b=card.getBoundingClientRect(); window.addEventListener('resize',()=>b=card.getBoundingClientRect()); card.addEventListener('mousemove',e=>{ const x=(e.clientX-b.left)/b.width-0.5; const y=(e.clientY-b.top)/b.height-0.5; card.style.transform=`perspective(1000px) rotateX(${-y*6}deg) rotateY(${x*8}deg)`; }); card.addEventListener('mouseleave',()=>card.style.transform='perspective(1000px) rotateX(0) rotateY(0)'); })();

    // Language toggle + placeholders
    (function initLang(){
      const sel=document.getElementById('language');
      function applyPlaceholders(){ const lang=document.body.classList.contains('lang-vi')?'vi':'en'; document.querySelectorAll('[data-lang-en-placeholder]').forEach(el=>{ const txt=el.getAttribute(`data-lang-${lang}-placeholder`); if(txt) el.placeholder=txt; }); }
      function setLang(lang){ document.body.classList.remove('lang-en','lang-vi'); document.body.classList.add('lang-'+lang); localStorage.setItem('preferredLanguage', lang); applyPlaceholders(); }
      const saved=localStorage.getItem('preferredLanguage')||'en'; sel.value=saved; setLang(saved); sel.addEventListener('change', e=> setLang(e.target.value));
    })();

    // Chat widget open/close
    const panel=document.getElementById('chatPanel');
    document.getElementById('chatOpen').onclick=()=>{ panel.classList.toggle('open'); if(panel.classList.contains('open')){ document.getElementById('chatInput')?.focus(); } };

    // --- Chat + LLM logic ---
    const chatBody=document.getElementById('chatBody');
    const input=document.getElementById('chatInput');
    const sendBtn=document.getElementById('sendBtn');
    const modelSel=document.getElementById('model');

    const SYSTEM_PROMPT=`You are Mind‑Mapper AI, a warm, insightful personality analyst for students.\n1) Ask brief, empathetic questions to understand the user across MBTI axes: (E/I), (S/N), (T/F), (J/P).\n2) Reflect patterns you notice, citing examples from their messages in plain language.\n3) When the user asks for their MBTI or after 6+ user messages, infer a 4‑letter type with a confidence %, and give 4–6 practical tips for study, teamwork, and wellbeing.\n4) Be unbiased and supportive. Keep answers under 180 words unless asked to go deeper.`;

    let webllmEngine=null, webllmReady=false;
    async function ensureWebLLM(){ if(webllmReady) return; if(!window.mlc) throw new Error('WebLLM runtime not loaded'); const {CreateMLCEngine, prebuiltAppConfig}=window.mlc; webllmEngine = await CreateMLCEngine(prebuiltAppConfig['Phi-3-mini-4k-instruct-q4f16_1'], {initProgressCallback:(p)=>{}}); webllmReady=true; }

    function appendMessage(role, text){ const wrap=document.createElement('div'); wrap.className='msg '+(role==='user'?'user':'ai'); wrap.innerHTML=`<div class="bubble">${text.replace(/</g,'&lt;')}</div>`; chatBody.appendChild(wrap); chatBody.scrollTop=chatBody.scrollHeight; }

    async function respondOnDevice(text){
      await ensureWebLLM();
      const history=[{role:'system', content:SYSTEM_PROMPT}];
      document.querySelectorAll('.msg').forEach(n=>{ const isUser=n.classList.contains('user'); const t=n.querySelector('.bubble').innerText; history.push({role:isUser?'user':'assistant', content:t}); });
      history.push({role:'user', content:text});
      let reply='';
      await webllmEngine.chat.completions.create({messages:history, stream:true, temperature:0.6, max_tokens:400}, (evt)=>{
        if(evt.choices && evt.choices.length){ const delta=evt.choices[0].delta?.content || ''; if(delta){ if(!appendMessage._streamEl){ appendMessage('assistant',''); appendMessage._streamEl=chatBody.lastElementChild.querySelector('.bubble'); } reply+=delta; appendMessage._streamEl.textContent=reply; chatBody.scrollTop=chatBody.scrollHeight; }}
      });
      appendMessage._streamEl=null;
    }

    async function respondOpenRouter(text){
      const key=(typeof OPENROUTER_API_KEY!=='undefined')?OPENROUTER_API_KEY:(window.OPENROUTER_API_KEY||'');
      if(!key){ appendMessage('assistant','To use a cloud model, set OPENROUTER_API_KEY as an environment variable on your host. Falling back to on‑device.'); modelSel.value='webllm'; return respondOnDevice(text); }
      const messages=[{role:'system', content:SYSTEM_PROMPT}];
      document.querySelectorAll('.msg').forEach(n=>{ const isUser=n.classList.contains('user'); const t=n.querySelector('.bubble').innerText; messages.push({role:isUser?'user':'assistant', content:t}); });
      messages.push({role:'user', content:text});
      const res=await fetch('https://openrouter.ai/api/v1/chat/completions',{ method:'POST', headers:{ 'Authorization':`Bearer ${key}`, 'Content-Type':'application/json' }, body:JSON.stringify({ model:'meta-llama/llama-3.1-8b-instruct:free', messages, temperature:0.6, max_tokens:400 }) });
      const json=await res.json(); const out=json.choices?.[0]?.message?.content || 'Sorry, no response.'; appendMessage('assistant', out);
    }

    async function handleSend(){ const text=input.value.trim(); if(!text) return; input.value=''; appendMessage('user', text); try{ if(modelSel.value==='webllm'){ await respondOnDevice(text);} else { await respondOpenRouter(text);} }catch(err){ console.error(err); appendMessage('assistant','I hit a snag. If your browser lacks WebGPU, try the cloud model (set your API key).'); } }

    sendBtn.addEventListener('click', handleSend);
    input.addEventListener('keydown', e=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); handleSend(); }});

    // optional helper to inject key at runtime
    window.setOpenRouterKey=(k)=>{ window.OPENROUTER_API_KEY=k };
  </script>
</body>
</html>

