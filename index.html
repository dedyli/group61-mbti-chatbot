<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind-Mapper AI – Sophisticated MBTI Personality Analyst</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet" />
  <style>
    :root{ --bg:#0b0a13; --fg:#f7f5ff; --muted:#bdb7e6; --accent:#8B5CF6; --accent-2:#F0A6FF; --gold:#EED972; --glass:rgba(255,255,255,.08); --glass-stroke:rgba(255,255,255,.12); }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{ margin:0; color:var(--fg); background:transparent; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; overflow-x:hidden; }

    /* Bilingual helpers */
    [data-lang]{display:none}
    body.lang-en [data-lang="en"], body.lang-en .block-en{display:initial}
    body.lang-vi [data-lang="vi"], body.lang-vi .block-vi{display:initial}

    .aurora{position:fixed; inset:0; z-index:-2; pointer-events:none; background:
      radial-gradient(60vw 60vw at -10% -10%, rgba(139,92,246,.35), transparent 60%),
      radial-gradient(50vw 50vw at 110% 10%, rgba(240,166,255,.25), transparent 60%),
      radial-gradient(40vw 40vw at 50% 110%, rgba(238,217,114,.18), transparent 60%),
      radial-gradient(25vw 25vw at 20% 70%, rgba(139,92,246,.18), transparent 70%),
      var(--bg);
      filter:saturate(120%) blur(10px); animation:auroraShift 24s ease-in-out infinite alternate; }
    @keyframes auroraShift{to{transform:translateY(-2%) scale(1.02)}}
    .sparkles{position:fixed; inset:0; z-index:-1; pointer-events:none}
    .sparkles i{position:absolute; width:3px; height:3px; border-radius:50%; background:rgba(255,255,255,.85); filter:blur(.3px); opacity:.7; animation:float 16s linear infinite, twinkle 2.5s ease-in-out infinite alternate}
    @keyframes float{to{transform:translateY(-120vh)}}
    @keyframes twinkle { 0% { opacity: .3; filter: blur(.3px) brightness(0.9); } 100% { opacity: 1; filter: blur(.3px) brightness(1.1); } }

    header{ position:sticky; top:16px; z-index:50; display:flex; gap:16px; align-items:center; justify-content:space-between; margin:16px auto 0; max-width:1200px; padding:12px 16px; border-radius:999px; background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); -webkit-backdrop-filter:blur(14px) saturate(140%); backdrop-filter:blur(14px) saturate(140%); border:1px solid var(--glass-stroke); box-shadow:0 8px 28px rgba(0,0,0,.25); }
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{width:120px; height:40px; object-fit:contain; border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .brand h1{margin:0; font-family:'Playfair Display',serif; font-weight:800; font-size:20px; letter-spacing:.3px}
    nav ul{margin:0; padding:0; list-style:none; display:flex; gap:8px; align-items:center}
    nav a{ color:var(--fg); text-decoration:none; font-weight:600; font-size:14px; letter-spacing:.3px; padding:10px 14px; border-radius:999px; position:relative; overflow:hidden; }
    nav a:after{content:""; position:absolute; inset:0; background:linear-gradient(90deg,var(--accent),var(--accent-2)); opacity:0; transition:.35s}
    nav a:hover:after, nav a.active:after{opacity:.25}
    .lang{display:flex; align-items:center; gap:8px}
    .pill{border:1px solid var(--glass-stroke); background:var(--glass); padding:8px 10px; border-radius:999px; display:flex; align-items:center; gap:8px}
    .pill select{background:transparent; border:none; color:var(--fg); font-weight:600}

    .container{max-width:1200px; margin:0 auto; padding:64px 16px}

    .hero{display:grid; grid-template-columns:1.1fr .9fr; align-items:center; gap:48px; padding-top:48px}
    .title{ font-family:'Playfair Display',serif; font-weight:800; font-size:clamp(36px,6vw,64px); line-height:1.04; letter-spacing:-.3px; margin:0 0 16px; position:relative; background:linear-gradient(180deg,#fff, #d7d0ff 60%, #b9b0ff); -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; text-shadow:0 8px 28px rgba(139,92,246,.15) }
    .subtitle{color:var(--muted); font-weight:600; font-size:18px; margin-bottom:20px}
    .lead{color:#dbd7ff; opacity:.9; max-width:56ch; line-height:1.8; margin-bottom:28px}
    .cta{ display:inline-flex; gap:10px; align-items:center; padding:14px 18px; border-radius:14px; font-weight:700; text-decoration:none; color:#0b0a13; background:linear-gradient(90deg, var(--gold), #FFEBA4); box-shadow:0 10px 30px rgba(238,217,114,.35); transition:transform .2s ease, box-shadow .2s ease }
    .cta:hover{transform:translateY(-2px); box-shadow:0 16px 36px rgba(238,217,114,.45)}

    .illustrationWrap{position:relative}
    .card3d{ position:relative; border-radius:24px; overflow:hidden; border:1px solid var(--glass-stroke); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow:0 30px 80px rgba(0,0,0,.35); transform:perspective(1000px) rotateX(0) rotateY(0); transition:transform .2s ease }
    .hero-img{display:block; width:100%; height:auto; aspect-ratio:4/3; object-fit:cover}
    .revealMask{ position:absolute; inset:0; background:conic-gradient(from 45deg at 0% 0%, transparent 0 10%, black 10% 20%, transparent 20% 30%, black 30% 40%, transparent 40% 50%, black 50% 60%, transparent 60% 70%, black 70% 80%, transparent 80% 90%, black 90% 100%); transform:translate(-120%, -120%) rotate(0.0001deg); filter:blur(1.2px) contrast(120%); animation:reveal 2.8s cubic-bezier(.2,.8,.2,1) .3s forwards }
    @keyframes reveal{to{transform:translate(0,0)}}
    .badge{position:absolute; right:16px; top:16px; padding:10px 14px; border-radius:12px; font-weight:700; color:#0b0a13; background:linear-gradient(90deg,#fff,#f7f5ff); box-shadow:0 10px 30px rgba(255,255,255,.25)}

    .section{padding:72px 0}
    .section h2{font-family:'Playfair Display',serif; font-size:clamp(28px,3.2vw,40px); margin:0 0 24px}
    .muted{color:var(--muted)}

    .steps{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    .step{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid var(--glass-stroke); border-radius:20px; padding:22px; position:relative; overflow:hidden; transition:transform .25s ease, box-shadow .25s ease }
    .step:hover{transform:translateY(-6px); box-shadow:0 24px 60px rgba(0,0,0,.35)}
    .step .n{width:38px; height:38px; display:grid; place-items:center; border-radius:999px; font-weight:800; color:#0b0a13; background:linear-gradient(90deg,var(--accent),var(--accent-2)); box-shadow:0 8px 22px rgba(139,92,246,.45)}
    .step h3{margin:12px 0 8px; font-weight:800}
    .step p{margin:0; color:#e9e7ff; opacity:.9}

    .faq{max-width:920px}
    details{background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border:1px solid var(--glass-stroke); border-radius:16px; padding:18px 20px; margin:10px 0}
    summary{cursor:pointer; font-weight:700}
    details[open]{box-shadow:0 16px 40px rgba(0,0,0,.35)}

    form{max-width:760px}
    input,textarea,select,button{font-family:inherit}
    .field{display:grid; gap:8px}
    .field input,.field textarea{ background:rgba(255,255,255,.04); border:1px solid var(--glass-stroke); color:var(--fg); padding:14px 16px; border-radius:12px }
    .btn{ border:none; cursor:pointer; padding:14px 18px; border-radius:14px; font-weight:800; letter-spacing:.3px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b0a13; box-shadow:0 12px 34px rgba(139,92,246,.35) }

    .chat-launch{ position:fixed; right:18px; bottom:18px; z-index:10000; display:flex; align-items:center; gap:12px; background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.08)); border:1px solid var(--glass-stroke); padding:10px 12px; border-radius:999px; -webkit-backdrop-filter:blur(12px); backdrop-filter:blur(12px); box-shadow:0 14px 42px rgba(0,0,0,.45); cursor:pointer }
    .chat-launch b{background:linear-gradient(90deg,var(--gold),#fff); -webkit-background-clip:text; -webkit-text-fill-color:transparent}
    .chat-panel{ position:fixed; right:18px; bottom:78px; width:min(420px, calc(100vw - 32px)); height:min(68vh, 720px); border-radius:24px; overflow:hidden; display:none; z-index:9999; background:linear-gradient(178deg, rgba(11,10,19,.85), rgba(16,15,22,.85)); -webkit-backdrop-filter:blur(20px) saturate(140%); backdrop-filter:blur(20px) saturate(140%); border:1px solid var(--glass-stroke); box-shadow:0 30px 80px rgba(0,0,0,.55) }
    .chat-panel.open{display:block}
    .chat-head{display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--glass-stroke)}
    .chat-head h3{margin:0; font-family:'Playfair Display',serif; letter-spacing:.3px}
    .chat-body{padding:14px; height:calc(100% - 124px); overflow:auto; display:flex; flex-direction:column; gap:12px}
    .msg{display:flex; gap:10px; align-items:flex-start}
    .msg .bubble{max-width:85%; padding:12px 14px; border-radius:14px; line-height:1.6}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b0a13; border-top-right-radius:4px}
    .msg.ai .bubble{background:rgba(255,255,255,.06); border:1px solid var(--glass-stroke); border-top-left-radius:4px}
    .chat-foot{padding:12px; border-top:1px solid var(--glass-stroke); display:grid; grid-template-columns:1fr; gap:8px}
    .chat-foot input{background:rgba(255,255,255,.06); border:1px solid var(--glass-stroke); color:var(--fg); padding:12px 14px; border-radius:12px; width:100%; outline:none}
    .chat-foot input:focus{border-color:rgba(139,92,246,.6); box-shadow:0 0 0 3px rgba(139,92,246,.25)}
    .notice{font-size:12px; color:#cfcaff; opacity:.8; padding:8px 12px;}
    
    .progress-bar { margin-top: 8px; }
    
    @media (max-width:960px){ .hero{grid-template-columns:1fr; padding-top:16px} header{border-radius:20px} }
  </style>
</head>
<body class="lang-en">
  <div class="aurora"></div>
  <div class="sparkles" id="sparkles"></div>

  <header>
    <div class="brand">
      <img src="Tsinghua_University_logo_and_wordmark_in_Chinese_and_English_characters.svg.png" alt="Tsinghua" />
      <h1>Mind-Mapper AI</h1>
    </div>
    <nav>
      <ul>
        <li><a class="active" href="#home"><span data-lang="en">Home</span><span data-lang="vi">Trang chủ</span></a></li>
        <li><a href="#how"><span data-lang="en">How it works</span><span data-lang="vi">Cách hoạt động</span></a></li>
        <li><a href="#about"><span data-lang="en">About Group 61</span><span data-lang="vi">Về Nhóm 61</span></a></li>
        <li><a href="#faq"><span>FAQ</span></a></li>
        <li><a href="#contact"><span data-lang="en">Contact</span><span data-lang="vi">Liên hệ</span></a></li>
      </ul>
    </nav>
    <div class="lang pill">
      <span>🌎</span>
      <select id="language">
        <option value="en" selected>English</option>
        <option value="vi">Tiếng Việt</option>
      </select>
    </div>
  </header>

  <main class="container" id="home">
    <section class="hero">
      <div>
        <h2 class="title">
          <span data-lang="en">Conversational MBTI Personality Insights – refined for students</span>
          <span data-lang="vi">Trò chuyện MBTI tinh tế – dành cho học sinh, sinh viên</span>
        </h2>
        <p class="subtitle">
          <span data-lang="en">A warm, human-like conversation that reveals strengths, tendencies, and growth tips.</span>
          <span data-lang="vi">Một cuộc trò chuyện ấm áp, tự nhiên để hé lộ thế mạnh, xu hướng và gợi ý phát triển.</span>
        </p>
        <p class="lead">
          <span data-lang="en">No rigid multiple-choice. Just natural chat. When you're ready, open the assistant below and start talking. After a brief exchange, you'll get a thoughtful MBTI-style profile, confidence level, and practical suggestions.</span>
          <span data-lang="vi">Không cần trắc nghiệm cứng nhắc – chỉ trò chuyện tự nhiên. Khi sẵn sàng, mở trợ lý và bắt đầu. Chỉ sau vài tin nhắn, bạn sẽ nhận được hồ sơ MBTI ngắn gọn, mức độ tự tin và các gợi ý thực tiễn.</span>
        </p>
        <a class="cta" href="#how"><span data-lang="en">Begin your journey</span><span data-lang="vi">Bắt đầu hành trình</span> →</a>
      </div>
      <div class="illustrationWrap">
        <div class="card3d" id="card3d">
          <img class="hero-img" src="vietnam_students.png"/>
        </div>
      </div>
    </section>

    <section class="section" id="how">
      <h2><span data-lang="en">How it works</span><span data-lang="vi">Cách hoạt động</span></h2>
      <p class="muted"><span data-lang="en">Simple, elegant, respectful of your time.</span><span data-lang="vi">Đơn giản, tinh tế, tôn trọng thời gian của bạn.</span></p>
      <div class="steps">
        <div class="step">
          <span class="n">1</span>
          <h3><span data-lang="en">Start a natural chat</span><span data-lang="vi">Bắt đầu trò chuyện tự nhiên</span></h3>
          <p><span data-lang="en">Say hello and share how you like to study, socialize, and make decisions.</span><span data-lang="vi">Hãy chào và chia sẻ cách bạn học, giao tiếp và ra quyết định.</span></p>
        </div>
        <div class="step">
          <span class="n">2</span>
          <h3><span data-lang="en">AI listens and learns</span><span data-lang="vi">AI lắng nghe và học hỏi</span></h3>
          <p><span data-lang="en">Our AI assistant listens for patterns and compares them to past conversations to improve its insights.</span><span data-lang="vi">Trợ lý AI lắng nghe, nhận diện các mẫu hành vi và so sánh với các cuộc trò chuyện trước để cải thiện độ chính xác.</span></p>
        </div>
        <div class="step">
          <span class="n">3</span>
          <h3><span data-lang="en">Receive your profile</span><span data-lang="vi">Nhận hồ sơ của bạn</span></h3>
          <p><span data-lang="en">Get a concise MBTI-style type with confidence, traits, and friendly development tips.</span><span data-lang="vi">Nhận kiểu MBTI, mức tự tin, đặc trưng nổi bật và gợi ý phát triển.</span></p>
        </div>
      </div>
    </section>

    <section class="section" id="about">
      <h2><span data-lang="en">About Group 61</span><span data-lang="vi">Về Nhóm 61</span></h2>
      <p class="muted">
        <span data-lang="en">We are Group 61 from Tsinghua University's IEDE 2025 program. Mind-Mapper AI was born from our passion to use technology for self-awareness and growth.</span>
        <span data-lang="vi">Chúng tôi là Nhóm 61 của chương trình IEDE 2025 (ĐH Thanh Hoa). Mind-Mapper AI xuất phát từ niềm đam mê ứng dụng công nghệ để thúc đẩy tự nhận thức và phát triển bản thân.</span>
      </p>
      <p class="muted" style="margin-top:10px">
        <span data-lang="en">Our goal is to make personality analysis accessible, engaging, and modern for students.</span>
        <span data-lang="vi">Mục tiêu của chúng tôi là khiến phân tích tính cách trở nên gần gũi, thú vị và hiện đại cho học sinh, sinh viên.</span>
      </p>
    </section>

    <section class="section faq" id="faq">
      <h2>FAQ</h2>
      <details>
        <summary><span data-lang="en">What is the MBTI?</span><span data-lang="vi">MBTI là gì?</span></summary>
        <p><span data-lang="en">The Myers-Briggs Type Indicator describes preferences in how people perceive information and make decisions, grouping into 16 types.</span><span data-lang="vi">MBTI mô tả khuynh hướng trong cách con người tiếp nhận thông tin và ra quyết định, phân loại thành 16 kiểu tính cách.</span></p>
      </details>
      <details>
        <summary><span data-lang="en">Is this a clinical assessment?</span><span data-lang="vi">Đây có phải đánh giá lâm sàng?</span></summary>
        <p><span data-lang="en">No—it's a self-reflection tool powered by AI. Use it for guidance, not diagnosis.</span><span data-lang="vi">Không—đây là công cụ tự phản chiếu do AI hỗ trợ. Dùng để tham khảo, không phải chẩn đoán.</span></p>
      </details>
      <details>
        <summary><span data-lang="en">Is my data private and secure?</span><span data-lang="vi">Dữ liệu của tôi có riêng tư và an toàn?</span></summary>
        <p><span data-lang="en">We securely save anonymized conversations to improve our AI's accuracy and insights. We do not store any personal identification information.</span><span data-lang="vi">Chúng tôi lưu trữ ẩn danh các cuộc trò chuyện một cách an toàn để cải thiện độ chính xác và thông tin chi tiết của AI. Chúng tôi không lưu trữ bất kỳ thông tin nhận dạng cá nhân nào.</span></p>
      </details>
      <details>
        <summary><span data-lang="en">How long does it take?</span><span data-lang="vi">Mất bao lâu?</span></summary>
        <p><span data-lang="en">Usually 5–10 minutes to get a first profile.</span><span data-lang="vi">Thường 5–10 phút để có hồ sơ đầu tiên.</span></p>
      </details>
    </section>

    <section class="section" id="contact">
      <h2><span data-lang="en">Get in touch</span><span data-lang="vi">Liên hệ</span></h2>
      <form onsubmit="event.preventDefault(); this.reset(); alert(document.body.classList.contains('lang-vi') ? 'Cảm ơn! Chúng tôi sẽ liên hệ.' : 'Thanks! We\'ll be in touch.');">
        <div class="field">
          <label><span data-lang="en">Name</span><span data-lang="vi">Tên</span></label>
          <input required data-lang-en-placeholder="Your name" data-lang-vi-placeholder="Tên của bạn" />
        </div>
        <div class="field" style="margin-top:10px">
          <label><span data-lang="en">Email</span><span data-lang="vi">Email</span></label>
          <input type="email" required data-lang-en-placeholder="you@example.com" data-lang-vi-placeholder="ban@example.com" />
        </div>
        <div class="field" style="margin-top:10px">
          <label><span data-lang="en">Message</span><span data-lang="vi">Tin nhắn</span></label>
          <textarea rows="5" required data-lang-en-placeholder="How can we help?" data-lang-vi-placeholder="Chúng tôi có thể giúp gì?…"></textarea>
        </div>
        <button class="btn" style="margin-top:12px"><span data-lang="en">Send message</span><span data-lang="vi">Gửi tin nhắn</span></button>
      </form>
    </section>
  </main>

  <button class="chat-launch" id="chatOpen" title="Take MBTI Assessment">🧠 <b><span data-lang="en">Start Chat</span><span data-lang="vi">Bắt đầu</span></b></button>
  <div class="chat-panel" id="chatPanel" aria-live="polite">
    <div class="chat-head">
      <h3>MBTI Personality Assessment</h3>
      <button id="closeChat" style="background: none; border: none; color: var(--fg); cursor: pointer; font-size: 18px;">✕</button>
    </div>
    <div class="chat-body" id="chatBody">
    </div>
    <div class="chat-foot" id="chatFoot">
      <div id="chatInputArea" style="display: grid; grid-template-columns: 1fr auto; gap: 8px;">
        <input id="chatInput" placeholder="Type your answer..." />
        <button class="btn" id="sendBtn"><span data-lang="en">Send</span><span data-lang="vi">Gửi</span></button>
      </div>
      <button class="btn" id="resetBtn" style="display: none; width: 100%;">
        <span data-lang="en">Start New Test</span>
        <span data-lang="vi">Bài test mới</span>
      </button>
      <div class="progress-bar" id="progressBar" style="margin-top: 8px;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 4px;">
          <span style="font-size: 11px; color: var(--muted);">Progress</span>
          <span id="progressText" style="font-size: 11px; color: var(--muted);">1/5</span>
        </div>
        <div style="background: rgba(255,255,255,.1); border-radius: 4px; height: 4px; overflow: hidden;">
          <div id="progressFill" style="background: linear-gradient(90deg, var(--accent), var(--accent-2)); height: 100%; width: 20%; transition: width 0.3s ease;"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Global variables
    let conversationHistory = [];
    let chatBody, chatInput, sendBtn, resetBtn, chatInputArea, progressBar, progressText, progressFill;

    // Initialize sparkles animation
    function initializeSparkles() { 
      const host = document.getElementById('sparkles'); 
      if (!host) return;
      
      for(let i = 0; i < 120; i++){ 
        const s = document.createElement('i'); 
        s.style.left = Math.random() * 100 + 'vw';
        s.style.top = '100vh';
        s.style.animationDuration = (10 + Math.random() * 16) + 's'; 
        host.appendChild(s);
      } 
    }

    // Initialize card tilt effect
    function initializeTilt() { 
      const card = document.getElementById('card3d'); 
      if (!card) return;
      
      let b = card.getBoundingClientRect(); 
      window.addEventListener('resize', () => b = card.getBoundingClientRect()); 
      
      card.addEventListener('mousemove', e => { 
        const x = (e.clientX - b.left) / b.width - 0.5; 
        const y = (e.clientY - b.top) / b.height - 0.5; 
        card.style.transform = `perspective(1000px) rotateX(${-y * 6}deg) rotateY(${x * 8}deg)`; 
      }); 
      
      card.addEventListener('mouseleave', () => {
        card.style.transform = 'perspective(1000px) rotateX(0) rotateY(0)';
      }); 
    }

    // Initialize language switching
    function initializeLanguage() {
      const sel = document.getElementById('language');
      if (!sel) return;
      
      function applyPlaceholders() { 
        const lang = document.body.classList.contains('lang-vi') ? 'vi' : 'en'; 
        document.querySelectorAll('[data-lang-en-placeholder]').forEach(el => { 
          const txt = el.getAttribute(`data-lang-${lang}-placeholder`); 
          if(txt) el.placeholder = txt; 
        }); 
      }
      
      function setLang(lang) { 
        document.body.classList.remove('lang-en','lang-vi'); 
        document.body.classList.add('lang-' + lang); 
        localStorage.setItem('preferredLanguage', lang); 
        applyPlaceholders();
        if (chatBody && conversationHistory.length === 0) {
          startConversation();
        }
      }
      
      const saved = localStorage.getItem('preferredLanguage') || 'en'; 
      sel.value = saved; 
      setLang(saved); 
      sel.addEventListener('change', e => setLang(e.target.value));
    }

    // Initialize chat panel controls
    function initializeChatPanel() {
      const panel = document.getElementById('chatPanel');
      const chatOpen = document.getElementById('chatOpen');
      const closeChat = document.getElementById('closeChat');
      
      if (!panel || !chatOpen) return;
      
      chatOpen.onclick = () => { 
        panel.classList.toggle('open'); 
        if(panel.classList.contains('open') && chatInput){ 
          chatInput.focus(); 
          if (conversationHistory.length === 0) {
            startConversation();
          }
        } 
      };

      if (closeChat) {
        closeChat.onclick = () => {
          panel.classList.remove('open');
        };
      }
    }

    // Add message to chat
    function addMessage(role, content) {
      if (!chatBody) return;
      
      const messageDiv = document.createElement('div');
      messageDiv.className = `msg ${role}`;
      
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      
      // Process content for display
      let processedContent = content
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
        .replace(/\n/g, '<br>');
      
      bubble.innerHTML = processedContent;
      messageDiv.appendChild(bubble);
      chatBody.appendChild(messageDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Update progress bar
    function updateProgress(step) {
      if (!progressBar || !progressText || !progressFill) return;
      
      const percentage = (step / 5) * 100;
      progressText.textContent = `${step}/5`;
      progressFill.style.width = `${percentage}%`;
    }

    // Show typing indicator
    function showTyping() {
      if (!chatBody) return;
      
      const typingDiv = document.createElement('div');
      typingDiv.className = 'msg ai';
      typingDiv.id = 'typing-indicator';
      typingDiv.innerHTML = '<div class="bubble">Typing...</div>';
      chatBody.appendChild(typingDiv);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    // Hide typing indicator
    function hideTyping() {
      const typing = document.getElementById('typing-indicator');
      if (typing) typing.remove();
    }

    // Start new conversation
    async function startConversation() {
      if (!chatBody) return;
      
      chatBody.innerHTML = '';
      conversationHistory = [];
      updateProgress(1);
      
      showTyping();
      
      try {
        const response = await fetch('/.netlify/functions/mbti-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: [] })
        });
        
        const data = await response.json();
        hideTyping();
        
        if (data.message) {
          addMessage('ai', data.message);
          conversationHistory.push({ role: 'assistant', content: data.message });
          
          if (data.progress) {
            updateProgress(data.progress);
          }
        } else {
          // Fallback message
          addMessage('ai', "Hi! I'm here to help you discover your MBTI personality type. After a busy day, what helps you recharge - being around people or having quiet time alone?");
          conversationHistory.push({ role: 'assistant', content: "Hi! I'm here to help you discover your MBTI personality type. After a busy day, what helps you recharge - being around people or having quiet time alone?" });
        }
        
      } catch (error) {
        console.error('Error starting conversation:', error);
        hideTyping();
        addMessage('ai', "Hi! I'm here to help you discover your MBTI personality type. Let's start: After a busy day, what helps you recharge - being around people or having quiet time alone?");
        conversationHistory.push({ role: 'assistant', content: "Initial question" });
      }
    }

    // Handle sending user message
    async function handleSend() {
      if (!chatInput || !chatBody) return;
      
      const userMessage = chatInput.value.trim();
      if (!userMessage) return;
      
      chatInput.value = '';
      addMessage('user', userMessage);
      conversationHistory.push({ role: 'user', content: userMessage });
      
      showTyping();
      
      try {
        const response = await fetch('/.netlify/functions/mbti-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ messages: conversationHistory })
        });
        
        const data = await response.json();
        hideTyping();
        
        if (data.message) {
          addMessage('ai', data.message);
          conversationHistory.push({ role: 'assistant', content: data.message });
          
          if (data.progress) {
            updateProgress(data.progress);
          }
          
          // If assessment is complete
          if (data.ready && data.type) {
            if (chatInputArea) chatInputArea.style.display = 'none';
            if (resetBtn) resetBtn.style.display = 'block';
            if (progressBar) progressBar.style.display = 'none';
            
            // Add a completion message
            setTimeout(() => {
              addMessage('ai', `🎉 Assessment complete! Your MBTI type is **${data.type}** with ${Math.round(data.confidence * 100)}% confidence.`);
            }, 1000);
          }
        } else {
          addMessage('ai', "I didn't get a proper response. Can you try rephrasing that?");
        }
        
      } catch (error) {
        console.error('Error sending message:', error);
        hideTyping();
        addMessage('ai', "Sorry, I'm having technical difficulties. Can you please try again?");
      }
    }

    // Reset chat to start over
    function resetChat() {
      conversationHistory = [];
      if (chatBody) chatBody.innerHTML = '';
      if (chatInputArea) chatInputArea.style.display = 'grid';
      if (resetBtn) resetBtn.style.display = 'none';
      if (progressBar) progressBar.style.display = 'block';
      updateProgress(1);
      startConversation();
      if (chatInput) chatInput.focus();
    }

    // Initialize chat controls
    function initializeChatControls() {
      chatBody = document.getElementById('chatBody');
      chatInput = document.getElementById('chatInput');
      sendBtn = document.getElementById('sendBtn');
      resetBtn = document.getElementById('resetBtn');
      chatInputArea = document.getElementById('chatInputArea');
      progressBar = document.getElementById('progressBar');
      progressText = document.getElementById('progressText');
      progressFill = document.getElementById('progressFill');
      
      if (!chatBody || !chatInput || !sendBtn) {
        console.error('Chat elements not found');
        return;
      }
      
      sendBtn.addEventListener('click', handleSend);
      if (resetBtn) resetBtn.addEventListener('click', resetChat);
      
      chatInput.addEventListener('keydown', e => {
        if (e.key === 'Enter' && !e.shiftKey) {
          e.preventDefault();
          handleSend();
        }
      });
      
      console.log('✅ Chat controls initialized');
    }

    // Initialize everything when DOM is ready
    document.addEventListener('DOMContentLoaded', () => {
      console.log('DOM loaded, initializing...');
      
      try {
        initializeSparkles();
        initializeTilt();
        initializeLanguage();
        initializeChatPanel();
        initializeChatControls();
        
        console.log('✅ All systems ready');
      } catch (error) {
        console.error('Initialization error:', error);
      }
    });

    // Backup initialization
    if (document.readyState !== 'loading') {
      setTimeout(() => {
        try {
          initializeSparkles();
          initializeTilt();
          initializeLanguage();
          initializeChatPanel();
          initializeChatControls();
          console.log('✅ Backup initialization completed');
        } catch (error) {
          console.error('Backup initialization error:', error);
        }
      }, 100);
    }
  </script>
</body>
</html>