<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Group 61 ‚Äî Chat</title>
  <meta name="description" content="Group 61 Project Chat" />
  <style>
    :root {
      --bg: #0f172a; --card: #111827; --muted: #94a3b8; --text: #e5e7eb; --accent: #22d3ee; --ok: #22c55e; --err: #ef4444;
      --border: rgba(255,255,255,0.08);
    }
    * { box-sizing: border-box; }
    body { margin:0; font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, "Apple Color Emoji", "Segoe UI Emoji"; background: var(--bg); color: var(--text); }
    .container { max-width: 900px; margin: 0 auto; padding: 24px; }
    .card { background: var(--card); border: 1px solid var(--border); border-radius: 16px; padding: 16px; }
    .row { display: flex; gap: 12px; align-items: stretch; }
    .col { flex: 1; }
    textarea, input[type="text"] {
      width: 100%; background: #0b1220; color: var(--text); border: 1px solid var(--border);
      border-radius: 12px; padding: 12px; outline: none;
    }
    textarea { min-height: 100px; resize: vertical; }
    button {
      appearance: none; border: 1px solid var(--border); background: #0b1220; color: var(--text);
      padding: 12px 16px; border-radius: 12px; cursor: pointer;
    }
    button:hover { border-color: rgba(255,255,255,0.2); }
    .btn-primary { background: linear-gradient(180deg, #0ea5e9, #22d3ee); color: #001018; border: none; }
    .btn-sm { padding: 6px 10px; font-size: 12px; }
    .stack { display: grid; gap: 12px; }
    .messages { display: grid; gap: 12px; padding: 8px; max-height: 60vh; overflow-y: auto; }
    .bubble { background: #0b1220; border: 1px solid var(--border); border-radius: 14px; padding: 12px; }
    .bubble.user { border-left: 3px solid var(--accent); }
    .bubble.ai { border-left: 3px solid #a78bfa; }
    .meta { font-size: 12px; color: var(--muted); display: flex; gap: 10px; align-items: center; }
    .feedback { display: inline-flex; gap: 6px; margin-top: 8px; }
    .pill { font-size: 11px; padding: 4px 8px; border-radius: 999px; border: 1px solid var(--border); color: var(--muted); }
    .ok { color: var(--ok); }
    .err { color: var(--err); }
    .hidden { display: none; }
  </style>
</head>
<body>
  <div class="container stack">
    <header class="stack">
      <h1 style="margin:0">Group 61 ‚Äî Chat</h1>
      <p class="pill">Netlify + Supabase (feedback saved server-side)</p>
    </header>

    <!-- Conversation area -->
    <section class="card stack">
      <div id="messages" class="messages" aria-live="polite"></div>

      <!-- Composer -->
      <form id="chat-form" class="stack" autocomplete="off">
        <label for="user-input" class="meta">Your message</label>
        <textarea id="user-input" name="user-input" placeholder="Ask something‚Ä¶"></textarea>
        <div class="row">
          <div class="col">
            <input id="system-prompt" type="text" placeholder="(Optional) system prompt" />
          </div>
          <div>
            <button id="send-btn" class="btn-primary" type="submit">Send</button>
          </div>
        </div>
      </form>
    </section>

    <!-- Status -->
    <div id="status" class="meta"></div>
  </div>

  <!-- Your existing client-side logic for calling /.netlify/functions/process-chat -->
  <!-- If you already have a process-chat.js, keep this script tag and it will still work. -->
  <script src="/process-chat.js"></script>

  <script>
    /**
     * Minimal helpers in case your existing process-chat.js isn't present.
     * If you DO have process-chat.js, these helpers won't conflict ‚Äî they
     * only run the same happy path: POST to /.netlify/functions/process-chat
     * and render messages with feedback buttons tied to handleFeedback().
     */

    const $ = (s, r = document) => r.querySelector(s);
    const messagesEl = $('#messages');
    const statusEl = $('#status');

    // Render a message bubble
    function renderMessage({ role, text, conversationId, idx }) {
      const wrap = document.createElement('div');
      wrap.className = `bubble ${role}`;
      wrap.innerHTML = `
        <div class="meta">
          <span>${role === 'user' ? 'You' : 'AI'}</span>
          ${typeof idx === 'number' ? `<span class="pill">#${idx}</span>` : ''}
          ${conversationId ? `<span class="pill">conv ${conversationId}</span>` : ''}
        </div>
        <div class="content">${escapeHtml(text).replace(/\n/g,'<br>')}</div>
        ${role === 'ai' && conversationId ? `
          <div class="feedback">
            <button class="btn-sm" onclick="handleFeedback(${conversationId}, true, this)">üëç</button>
            <button class="btn-sm" onclick="handleFeedback(${conversationId}, false, this)">üëé</button>
          </div>` : ''}
      `;
      messagesEl.appendChild(wrap);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function escapeHtml(s='') {
      return s.replace(/[&<>"']/g, c => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));
    }

    // Wire up the chat form if process-chat.js isn't handling it
    (function attachFormIfNeeded() {
      const form = $('#chat-form');
      if (!form) return;

      // If process-chat.js is already listening, we won't double-submit.
      let handlerAttached = false;
      form.addEventListener('submit', (e) => {
        if (handlerAttached) return;
        e.preventDefault();
        sendChat();
      }, { once: true });
    })();

    async function sendChat() {
      const input = $('#user-input');
      const system = $('#system-prompt');
      const sendBtn = $('#send-btn');

      const text = (input.value || '').trim();
      if (!text) return;

      try {
        sendBtn.disabled = true;
        statusEl.textContent = 'Sending‚Ä¶';
        renderMessage({ role: 'user', text });

        const res = await fetch('/.netlify/functions/process-chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            message: text,
            system_prompt: system.value || null
          })
        });

        const ok = res.ok;
        const payload = await (async () => { try { return await res.json(); } catch { return {}; } })();

        if (!ok) {
          const msg = typeof payload === 'object' && payload.message ? payload.message : await res.text();
          throw new Error(msg || `HTTP ${res.status}`);
        }

        // Expecting payload: { reply: string, conversation_id: number }
        const reply = payload.reply ?? '(no reply)';
        const conversationId = Number(payload.conversation_id) || undefined;

        renderMessage({ role: 'ai', text: reply, conversationId, idx: (payload.turn_index ?? undefined) });
        statusEl.textContent = 'Done.';
      } catch (err) {
        console.error(err);
        statusEl.innerHTML = `<span class="err">Error:</span> ${escapeHtml(err.message || String(err))}`;
      } finally {
        $('#send-btn').disabled = false;
        $('#user-input').value = '';
      }
    }

    /**
     * >>> FEEDBACK: now saved via Netlify function (service key) <<<
     * Exposed globally so your message templates can call: handleFeedback(id, true|false, btn)
     */
    window.handleFeedback = async function handleFeedback(conversationId, isAccurate, btnEl) {
      const buttons = btnEl?.parentElement?.querySelectorAll('button');

      try {
        // Optimistic UI
        buttons?.forEach(b => b.disabled = true);
        btnEl?.classList.add('pill');

        const res = await fetch('/.netlify/functions/save-feedback', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            conversation_id: Number(conversationId),
            is_accurate: Boolean(isAccurate)
          })
        });

        if (!res.ok) {
          const txt = await res.text();
          throw new Error(txt || `HTTP ${res.status}`);
        }

        // Success UI
        const wrap = btnEl.closest('.bubble');
        const stamp = document.createElement('div');
        stamp.className = 'meta';
        stamp.innerHTML = isAccurate
          ? `<span class="ok">‚úÖ Thanks for the feedback!</span>`
          : `<span class="err">‚ùå Feedback received ‚Äî we'll improve.</span>`;
        wrap.appendChild(stamp);

        // Hide buttons after success
        btnEl.parentElement?.classList.add('hidden');
      } catch (err) {
        console.error('Error saving feedback:', err);
        alert('Could not save feedback: ' + (err.message || String(err)));
        // Re-enable on failure
        buttons?.forEach(b => b.disabled = false);
        btnEl?.classList.remove('pill');
      }
    };
  </script>
</body>
</html>
