<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Mind-Mapper AI — Personality Insights & Conflict Resolution</title>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700;800&display=swap" rel="stylesheet" />
  <style>
    :root{ 
      --bg:#0b0a13; --fg:#f7f5ff; --muted:#bdb7e6; 
      --accent:#8B5CF6; --accent-2:#F0A6FF; --gold:#EED972; 
      --conflict:#FF6B6B; --conflict-2:#FF8A8A; --harmony:#4ECDC4;
      --glass:rgba(255,255,255,.08); --glass-stroke:rgba(255,255,255,.12); 
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{ margin:0; color:var(--fg); background:transparent; font-family:'Poppins',system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial; overflow-x:hidden; }

    /* Multilingual helpers */
    [data-lang]{display:none}
    body.lang-en [data-lang="en"], body.lang-en .block-en{display:initial}
    body.lang-vi [data-lang="vi"], body.lang-vi .block-vi{display:initial}
    body.lang-zh [data-lang="zh"], body.lang-zh .block-zh{display:initial}

    /* Service-specific display */
    .service-section { display: none; animation: fadeIn 0.5s ease-in-out; }
    .service-section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    .aurora{position:fixed; inset:0; z-index:-2; pointer-events:none; background:
      radial-gradient(60vw 60vw at -10% -10%, rgba(139,92,246,.35), transparent 60%),
      radial-gradient(50vw 50vw at 110% 10%, rgba(240,166,255,.25), transparent 60%),
      radial-gradient(40vw 40vw at 50% 110%, rgba(238,217,114,.18), transparent 60%),
      radial-gradient(25vw 25vw at 20% 70%, rgba(139,92,246,.18), transparent 70%),
      var(--bg);
      filter:saturate(120%) blur(10px); animation:auroraShift 24s ease-in-out infinite alternate; }
    @keyframes auroraShift{to{transform:translateY(-2%) scale(1.02)}}
    
    .sparkles{position:fixed; inset:0; z-index:-1; pointer-events:none}
    .sparkles i{position:absolute; width:3px; height:3px; border-radius:50%; background:rgba(255,255,255,.85); filter:blur(.3px); opacity:.7; animation:float 16s linear infinite, twinkle 2.5s ease-in-out infinite alternate}
    @keyframes float{to{transform:translateY(-120vh)}}
    @keyframes twinkle { 0% { opacity: .3; filter: blur(.3px) brightness(0.9); } 100% { opacity: 1; filter: blur(.3px) brightness(1.1); } }

    header{ position:sticky; top:16px; z-index:50; display:flex; gap:16px; align-items:center; justify-content:space-between; margin:16px auto 0; max-width:1200px; padding:12px 16px; border-radius:20px; background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06)); -webkit-backdrop-filter:blur(14px) saturate(140%); backdrop-filter:blur(14px) saturate(140%); border:1px solid var(--glass-stroke); box-shadow:0 8px 28px rgba(0,0,0,.25); }
    .brand{display:flex; align-items:center; gap:12px}
    .brand img{width:120px; height:40px; object-fit:contain; border-radius:8px; box-shadow:0 6px 16px rgba(0,0,0,.35)}
    .brand h1{margin:0; font-family:'Playfair Display',serif; font-weight:800; font-size:20px; letter-spacing:.3px}
    
    nav ul{margin:0; padding:0; list-style:none; display:flex; gap:8px; align-items:center}
    nav a{ color:var(--fg); text-decoration:none; font-weight:600; font-size:14px; letter-spacing:.3px; padding:10px 14px; border-radius:12px; position:relative; overflow:hidden; transition: all .3s ease; }
    nav a:after{content:""; position:absolute; inset:0; background:linear-gradient(90deg,var(--accent),var(--accent-2)); opacity:0; transition:.35s}
    nav a:hover:after{opacity:.25}
    nav a.active{font-weight:700; box-shadow:0 4px 20px rgba(139,92,246,.4);}
    nav a.active:after{opacity:.25}

    /* Service-specific nav styling */
    nav a.personality-service {
      background: rgba(139,92,246,.1);
      border: 1px solid rgba(139,92,246,.2);
    }
    nav a.personality-service:hover, nav a.personality-service.active {
      background: rgba(139,92,246,.2);
      box-shadow: 0 8px 25px rgba(139,92,246,.3);
    }
    
    nav a.conflict-service {
      background: rgba(255,107,107,.1);
      border: 1px solid rgba(255,107,107,.2);
    }
    nav a.conflict-service:hover, nav a.conflict-service.active {
      background: rgba(255,107,107,.2);
      box-shadow: 0 8px 25px rgba(255,107,107,.3);
    }

    /* Language pill */
    .lang{display:flex; align-items:center; gap:8px}
    .pill{border:1px solid #6b61b8; background:rgba(14,12,30,.85); padding:8px 10px; border-radius:999px; display:flex; align-items:center; gap:8px; box-shadow:0 8px 24px rgba(0,0,0,.45)}
    .pill select{background:rgba(29,25,58,.95); border:1px solid #8B5CF6; color:#f3f0ff; font-weight:700; padding:8px 10px; border-radius:999px; outline:none; appearance:none}
    .pill select option{background:#1f1a3f; color:#f3f0ff;}

    .container{max-width:1200px; margin:0 auto; padding:64px 16px}

    /* Service Hero Sections */
    .service-hero{display:grid; grid-template-columns:1.1fr .9fr; align-items:center; gap:48px; padding-top:48px}
    .service-title{ font-family:'Playfair Display',serif; font-weight:800; font-size:clamp(36px,6vw,64px); line-height:1.04; letter-spacing:-.3px; margin:0 0 16px; position:relative; }
    
    .personality-title {
      background:linear-gradient(180deg,#fff, #d7d0ff 60%, #b9b0ff); 
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; 
      text-shadow:0 8px 28px rgba(139,92,246,.15);
    }
    .conflict-title {
      background:linear-gradient(180deg,#fff, #ffcccb 60%, #ff9999); 
      -webkit-background-clip:text; background-clip:text; -webkit-text-fill-color:transparent; 
      text-shadow:0 8px 28px rgba(255,107,107,.15);
    }

    .subtitle{color:var(--muted); font-weight:600; font-size:18px; margin-bottom:20px}
    .lead{color:#dbd7ff; opacity:.9; max-width:56ch; line-height:1.8; margin-bottom:28px}
    
    .service-cta{ display:inline-flex; gap:10px; align-items:center; padding:14px 18px; border-radius:14px; font-weight:700; text-decoration:none; transition:transform .2s ease, box-shadow .2s ease; }
    .personality-cta{ color:#0b0a13; background:linear-gradient(90deg, var(--gold), #FFEBA4); box-shadow:0 10px 30px rgba(238,217,114,.35); }
    .personality-cta:hover{transform:translateY(-2px); box-shadow:0 16px 36px rgba(238,217,114,.45)}
    .conflict-cta{ color:#fff; background:linear-gradient(90deg, var(--conflict), var(--conflict-2)); box-shadow:0 10px 30px rgba(255,107,107,.35); }
    .conflict-cta:hover{transform:translateY(-2px); box-shadow:0 16px 36px rgba(255,107,107,.45)}

    .illustrationWrap{position:relative}
    .card3d{ position:relative; border-radius:24px; overflow:hidden; border:1px solid var(--glass-stroke); background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); box-shadow:0 30px 80px rgba(0,0,0,.35); transform:perspective(1000px) rotateX(0) rotateY(0); transition:transform .2s ease }
    .hero-img{display:block; width:100%; height:auto; aspect-ratio:4/3; object-fit:cover}

    .section{padding:72px 0}
    .section h2{font-family:'Playfair Display',serif; font-size:clamp(28px,3.2vw,40px); margin:0 0 24px}
    .muted{color:var(--muted)}

    /* Feature grids */
    .feature-grid{display:grid; grid-template-columns:repeat(auto-fit, minmax(280px, 1fr)); gap:24px; margin-top:50px}
    .feature-card{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid var(--glass-stroke); border-radius:20px; padding:22px; position:relative; overflow:hidden; transition:transform .25s ease, box-shadow .25s ease }
    .feature-card:hover{transform:translateY(-6px); box-shadow:0 24px 60px rgba(0,0,0,.35)}
    .feature-card h3{margin:12px 0 8px; font-weight:800}
    .feature-card p{margin:0; color:#e9e7ff; opacity:.9}

    .personality-card h3 { color: var(--accent-2); }
    .conflict-card h3 { color: var(--conflict); }

    /* When to use sections */
    .when-to-use{background:rgba(255,255,255,.05); border-radius:20px; padding:30px; margin:40px 0; border:1px solid var(--glass-stroke)}
    .when-to-use h3{margin:0 0 20px; text-align:center; font-size:24px; font-weight:700}
    .use-cases{display:grid; grid-template-columns:repeat(auto-fit, minmax(200px, 1fr)); gap:16px}
    .use-case{background:rgba(255,255,255,.03); padding:16px; border-radius:12px; text-align:center}

    /* Steps */
    .steps{display:grid; grid-template-columns:repeat(3,1fr); gap:16px}
    .step{ background:linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.03)); border:1px solid var(--glass-stroke); border-radius:20px; padding:22px; position:relative; overflow:hidden; transition:transform .25s ease, box-shadow .25s ease }
    .step:hover{transform:translateY(-6px); box-shadow:0 24px 60px rgba(0,0,0,.35)}
    .step .n{width:38px; height:38px; display:grid; place-items:center; border-radius:999px; font-weight:800; color:#0b0a13; margin-bottom:12px}
    .step h3{margin:12px 0 8px; font-weight:800}
    .step p{margin:0; color:#e9e7ff; opacity:.9}

    .personality-step .n { background:linear-gradient(90deg,var(--accent),var(--accent-2)); box-shadow:0 8px 22px rgba(139,92,246,.45); }
    .conflict-step .n { background:linear-gradient(90deg,var(--conflict),var(--conflict-2)); box-shadow:0 8px 22px rgba(255,107,107,.45); }

    /* FAQ */
    .faq{max-width:920px}
    details{background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03)); border:1px solid var(--glass-stroke); border-radius:16px; padding:18px 20px; margin:10px 0}
    summary{cursor:pointer; font-weight:700}
    details[open]{box-shadow:0 16px 40px rgba(0,0,0,.35)}

    /* Contact form */
    form{max-width:760px}
    input,textarea,select,button{font-family:inherit}
    .field{display:grid; gap:8px}
    .field input,.field textarea{ background:rgba(255,255,255,.04); border:1px solid var(--glass-stroke); color:var(--fg); padding:14px 16px; border-radius:12px }
    .btn{ border:none; cursor:pointer; padding:14px 18px; border-radius:14px; font-weight:800; letter-spacing:.3px; background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#0b0a13; box-shadow:0 12px 34px rgba(139,92,246,.35) }

    /* Chat systems */
    .chat-launch{ 
      position:fixed; right:18px; bottom:18px; z-index:10000; width:240px; height:240px; 
      border:none; background:transparent; cursor:pointer; padding:0;
      animation:mascotFloat 3s ease-in-out infinite, mascotGlow 2s ease-in-out infinite alternate;
    }
    .chat-launch img {
      width:100%; height:100%; object-fit:contain; border-radius:50%; 
      filter:drop-shadow(0 0 20px rgba(139,92,246,.6)) drop-shadow(0 0 40px rgba(139,92,246,.4)) drop-shadow(0 0 60px rgba(139,92,246,.2));
      transition:transform .3s ease, filter .3s ease;
    }
    .chat-launch:hover img {
      transform:scale(1.1) rotate(5deg);
      filter:drop-shadow(0 0 25px rgba(139,92,246,.8)) drop-shadow(0 0 50px rgba(139,92,246,.6)) drop-shadow(0 0 80px rgba(139,92,246,.4));
    }
    .chat-launch.conflict img {
      filter:drop-shadow(0 0 20px rgba(255,107,107,.6)) drop-shadow(0 0 40px rgba(255,107,107,.4)) drop-shadow(0 0 60px rgba(255,107,107,.2));
    }
    .chat-launch.conflict:hover img {
      filter:drop-shadow(0 0 25px rgba(255,107,107,.8)) drop-shadow(0 0 50px rgba(255,107,107,.6)) drop-shadow(0 0 80px rgba(255,107,107,.4));
    }
    @keyframes mascotFloat { 0%, 100% { transform:translateY(0px); } 50% { transform:translateY(-15px); } }
    @keyframes mascotGlow { 0% { filter:drop-shadow(0 0 20px rgba(139,92,246,.6)) drop-shadow(0 0 40px rgba(139,92,246,.4)); } 100% { filter:drop-shadow(0 0 30px rgba(139,92,246,.8)) drop-shadow(0 0 60px rgba(139,92,246,.6)); } }
    
    .chat-panel{ 
        position:fixed; right:18px; bottom:270px; width:min(420px, calc(100vw - 32px)); height:min(68vh, 720px); 
        border-radius:24px; overflow:hidden; display:none; flex-direction:column; z-index:9999; 
        background:linear-gradient(178deg, rgba(11,10,19,.85), rgba(16,15,22,.85)); 
        -webkit-backdrop-filter:blur(20px) saturate(140%); backdrop-filter:blur(20px) saturate(140%); 
        border:1px solid var(--glass-stroke); box-shadow:0 30px 80px rgba(0,0,0,.55); 
    }
    .chat-panel.open { display:flex; }
    .chat-head{ padding:12px 16px; flex-shrink:0; border-bottom:1px solid rgba(255,255,255,.12); }
    .personality-head { background:linear-gradient(90deg, #241b5f, #3c2c9f 45%, #6d4df7); }
    .conflict-head { background:linear-gradient(90deg, #5f1b1b, #9f2c2c 45%, #f74d4d); }
    .chat-head h3{ margin:0; font-family:'Playfair Display',serif; letter-spacing:.3px; font-weight:800; }
    .chat-body{ padding:14px; flex-grow:1; overflow:auto; display:flex; flex-direction:column; gap:12px }

    .msg{display:flex; gap:10px; align-items:flex-start}
    .msg .bubble{max-width:85%; padding:12px 14px; border-radius:14px; line-height:1.6}
    .msg.user{justify-content:flex-end}
    .msg.user .bubble{color:#0b0a13; border-top-right-radius:4px}
    .msg.user.personality .bubble{background:linear-gradient(90deg,var(--accent),var(--accent-2))}
    .msg.user.conflict .bubble{background:linear-gradient(90deg,var(--conflict),var(--conflict-2))}
    .msg.ai .bubble{background:rgba(255,255,255,.06); border:1px solid var(--glass-stroke); border-top-left-radius:4px}
    
    .chat-foot{ padding:12px; border-top:1px solid var(--glass-stroke); display:grid; grid-template-columns:1fr; gap:8px; flex-shrink:0; background:rgba(255,255,255,.02); }
    .chat-foot input{background:rgba(255,255,255,.06); border:1px solid var(--glass-stroke); color:var(--fg); padding:12px 14px; border-radius:12px; width:100%; outline:none}
    .chat-foot input:focus{border-color:rgba(139,92,246,.6); box-shadow:0 0 0 3px rgba(139,92,246,.25)}
    .notice{font-size:12px; color:#cfcaff; opacity:.8; padding:8px 12px;}
    
    .feedback-buttons { margin-top: 10px; display: flex; gap: 8px; }
    .feedback-buttons button { background: rgba(255,255,255,.1); border: 1px solid var(--glass-stroke); color: var(--fg); padding: 4px 10px; border-radius: 8px; cursor: pointer; transition: background .2s; font-size: 12px; }
    .feedback-buttons button:hover { background: rgba(255,255,255,.2); }
    .feedback-buttons button.selected { background: var(--accent); color: #0b0a13; border-color: transparent; }
    .feedback-buttons button:disabled { opacity: 0.6; cursor: not-allowed; }

    @media (max-width:960px){ 
      .service-hero{grid-template-columns:1fr; padding-top:16px} 
      header{border-radius:20px; flex-direction:column; gap:16px; padding:16px}
      nav ul{width:100%; justify-content:center; flex-wrap:wrap}
      nav a{flex:1; min-width:120px; justify-content:center}
    }
  </style>
</head>
<body class="lang-en">
  <div class="aurora"></div>
  <div class="sparkles" id="sparkles"></div>

  <header>
    <div class="brand">
      <img src="Tsinghua_University_logo_and_wordmark_in_Chinese_and_English_characters.svg.png" alt="Tsinghua" />
      <h1>Mind-Mapper AI</h1>
    </div>
    <nav>
      <ul>
        <li><a href="#personality" class="nav-link personality-service active" data-section="personality">
          🧠 <span data-lang="en">Personality Analysis</span><span data-lang="vi">Phân tích tính cách</span><span data-lang="zh">性格分析</span>
        </a></li>
        <li><a href="#conflict" class="nav-link conflict-service" data-section="conflict">
          🤝 <span data-lang="en">Conflict Resolution</span><span data-lang="vi">Giải quyết xung đột</span><span data-lang="zh">冲突解决</span>
        </a></li>
        <li><a href="#about" class="nav-link">
          ℹ️ <span data-lang="en">About</span><span data-lang="vi">Về chúng tôi</span><span data-lang="zh">关于我们</span>
        </a></li>
        <li><a href="#faq" class="nav-link">❓ <span>FAQ</span></a></li>
        <li><a href="#contact" class="nav-link">
          📧 <span data-lang="en">Contact</span><span data-lang="vi">Liên hệ</span><span data-lang="zh">联系</span>
        </a></li>
      </ul>
    </nav>
    <div class="lang pill">
      <span>🌎</span>
      <select id="language" aria-label="Language selector">
        <option value="en" selected>English</option>
        <option value="vi">Tiếng Việt</option>
        <option value="zh">中文</option>
      </select>
    </div>
  </header>

  <main class="container">
    <!-- Personality Analysis Section -->
    <section id="personality-section" class="service-section active">
      <div class="service-hero">
        <div>
          <h2 class="service-title personality-title">
            <span data-lang="en">Discover Your Personality</span>
            <span data-lang="vi">Khám phá tính cách của bạn</span>
            <span data-lang="zh">探索你的性格</span>
          </h2>
          <p class="subtitle">
            <span data-lang="en">A warm, human-like chat that reveals strengths, tendencies, and growth tips.</span>
            <span data-lang="vi">Cuộc trò chuyện gần gũi giúp bạn hiểu rõ điểm mạnh, xu hướng và cách phát triển.</span>
            <span data-lang="zh">以轻松自然的对话，了解你的优势、倾向与成长建议。</span>
          </p>
          <p class="lead">
            <span data-lang="en">No rigid multiple-choice—just natural chat. Click the AI assistant below and start talking. After a brief exchange, you'll get a thoughtful MBTI-style profile, confidence level, and practical suggestions.</span>
            <span data-lang="vi">Không cần trắc nghiệm cứng nhắc—chỉ cần trò chuyện tự nhiên. Mở trợ lý bên dưới và bắt đầu. Sau vài tin nhắn, bạn sẽ nhận được hồ sơ kiểu MBTI, mức độ tự tin và gợi ý hữu ích.</span>
            <span data-lang="zh">无需死板的选择题，只需自然聊天。开启下方助手并开始交流；很快你就会收到 MBTI 风格的简介、可信度以及实用建议。</span>
          </p>
          <a class="service-cta personality-cta" href="#" onclick="openPersonalityChat()">
            <span data-lang="en">Start Analysis</span>
            <span data-lang="vi">Bắt đầu phân tích</span>
            <span data-lang="zh">开始分析</span> →
          </a>
        </div>
        <div class="illustrationWrap">
          <div class="card3d" id="personalityCard3d">
            <img class="hero-img" src="hero_image.png" alt="Professionals of diverse backgrounds"/>
          </div>
        </div>
      </div>

      <div class="when-to-use">
        <h3>
          <span data-lang="en">Perfect for when you want to:</span>
          <span data-lang="vi">Hoàn hảo khi bạn muốn:</span>
          <span data-lang="zh">非常适合当你想要：</span>
        </h3>
        <div class="use-cases">
          <div class="use-case">
            <strong>🔍 <span data-lang="en">Self-Discovery</span><span data-lang="vi">Tự khám phá</span><span data-lang="zh">自我发现</span></strong><br>
            <span data-lang="en">Learn about your natural preferences and tendencies</span>
            <span data-lang="vi">Tìm hiểu về sở thích và xu hướng tự nhiên</span>
            <span data-lang="zh">了解你的天然偏好和倾向</span>
          </div>
          <div class="use-case">
            <strong>🚀 <span data-lang="en">Career Growth</span><span data-lang="vi">Phát triển sự nghiệp</span><span data-lang="zh">职业发展</span></strong><br>
            <span data-lang="en">Understand your work style and ideal environments</span>
            <span data-lang="vi">Hiểu phong cách làm việc và môi trường lý tưởng</span>
            <span data-lang="zh">理解你的工作风格和理想环境</span>
          </div>
          <div class="use-case">
            <strong>🤝 <span data-lang="en">Relationships</span><span data-lang="vi">Các mối quan hệ</span><span data-lang="zh">人际关系</span></strong><br>
            <span data-lang="en">Improve how you connect with others</span>
            <span data-lang="vi">Cải thiện cách kết nối với người khác</span>
            <span data-lang="zh">改善与他人的连接方式</span>
          </div>
          <div class="use-case">
            <strong>🎯 <span data-lang="en">Personal Development</span><span data-lang="vi">Phát triển cá nhân</span><span data-lang="zh">个人发展</span></strong><br>
            <span data-lang="en">Get actionable tips for growth</span>
            <span data-lang="vi">Nhận lời khuyên thực tế cho sự phát triển</span>
            <span data-lang="zh">获得可行的成长建议</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>
          <span data-lang="en">How it works</span>
          <span data-lang="vi">Cách hoạt động</span>
          <span data-lang="zh">如何运作</span>
        </h2>
        <div class="steps">
          <div class="step personality-step">
            <span class="n">1</span>
            <h3>
              <span data-lang="en">Start a natural chat</span>
              <span data-lang="vi">Bắt đầu trò chuyện tự nhiên</span>
              <span data-lang="zh">开始自然对话</span>
            </h3>
            <p>
              <span data-lang="en">Say hello and share how you work, socialize, and make decisions.</span>
              <span data-lang="vi">Hãy chào và chia sẻ cách bạn làm việc, giao tiếp và ra quyết định.</span>
              <span data-lang="zh">先打个招呼，说说你的工作方式、人际互动与决策习惯。</span>
            </p>
          </div>
          <div class="step personality-step">
            <span class="n">2</span>
            <h3>
              <span data-lang="en">AI listens and learns</span>
              <span data-lang="vi">AI lắng nghe và học hỏi</span>
              <span data-lang="zh">AI 认真倾听并学习</span>
            </h3>
            <p>
              <span data-lang="en">The assistant looks for patterns and refines insights over the chat.</span>
              <span data-lang="vi">Trợ lý tìm các mẫu hành vi và hoàn thiện nhận định trong suốt cuộc trò chuyện.</span>
              <span data-lang="zh">助手在对话中识别模式，不断完善结论。</span>
            </p>
          </div>
          <div class="step personality-step">
            <span class="n">3</span>
            <h3>
              <span data-lang="en">Receive your profile</span>
              <span data-lang="vi">Nhận hồ sơ của bạn</span>
              <span data-lang="zh">获取你的画像</span>
            </h3>
            <p>
              <span data-lang="en">Get an MBTI-style type with confidence, traits, and friendly tips.</span>
              <span data-lang="vi">Nhận kiểu MBTI cùng mức tự tin, đặc trưng chính và gợi ý hữu ích.</span>
              <span data-lang="zh">获得 MBTI 风格类型、可信度、关键特质和贴心建议。</span>
            </p>
          </div>
        </div>
      </div>

      <div class="feature-grid">
        <div class="feature-card personality-card">
          <h3>🗣️ <span data-lang="en">Natural Conversation</span><span data-lang="vi">Trò chuyện tự nhiên</span><span data-lang="zh">自然对话</span></h3>
          <p>
            <span data-lang="en">No rigid questionnaires—just chat naturally about your preferences, work style, and decision-making.</span>
            <span data-lang="vi">Không cần bảng câu hỏi cứng nhắc—chỉ cần trò chuyện tự nhiên về sở thích, phong cách làm việc và cách quyết định.</span>
            <span data-lang="zh">无需死板问卷—只需自然聊聊你的偏好、工作风格和决策方式。</span>
          </p>
        </div>
        <div class="feature-card personality-card">
          <h3>🎯 <span data-lang="en">Accurate Analysis</span><span data-lang="vi">Phân tích chính xác</span><span data-lang="zh">精准分析</span></h3>
          <p>
            <span data-lang="en">Our AI analyzes patterns in your responses to determine your MBTI type with high confidence.</span>
            <span data-lang="vi">AI của chúng tôi phân tích các mẫu trong phản hồi của bạn để xác định kiểu MBTI với độ tin cậy cao.</span>
            <span data-lang="zh">我们的 AI 分析你的回答模式，以高可信度确定你的 MBTI 类型。</span>
          </p>
        </div>
        <div class="feature-card personality-card">
          <h3>💡 <span data-lang="en">Personalized Insights</span><span data-lang="vi">Thông tin cá nhân hóa</span><span data-lang="zh">个性化见解</span></h3>
          <p>
            <span data-lang="en">Get specific strengths, growth areas, and practical tips tailored to your unique personality.</span>
            <span data-lang="vi">Nhận được những điểm mạnh cụ thể, lĩnh vực phát triển và mẹo thực tế phù hợp với tính cách độc đáo của bạn.</span>
            <span data-lang="zh">获得专门针对你独特性格的具体优势、成长领域和实用建议。</span>
          </p>
        </div>
      </div>
    </section>

    <!-- Conflict Resolution Section -->
    <section id="conflict-section" class="service-section">
      <div class="service-hero">
        <div>
          <h2 class="service-title conflict-title">
            <span data-lang="en">Resolve Conflicts Wisely</span>
            <span data-lang="vi">Giải quyết xung đột thông minh</span>
            <span data-lang="zh">明智解决冲突</span>
          </h2>
          <p class="subtitle">
            <span data-lang="en">Get personalized strategies to resolve interpersonal conflicts using personality insights.</span>
            <span data-lang="vi">Nhận chiến lược cá nhân hóa để giải quyết xung đột giữa con người dựa trên hiểu biết về tính cách.</span>
            <span data-lang="zh">基于性格洞察，获得个性化的人际冲突解决策略。</span>
          </p>
          <p class="lead">
            <span data-lang="en">Whether it's workplace tension, family disagreements, or team conflicts, our AI helps you understand the root causes and provides tailored resolution strategies based on personality types involved.</span>
            <span data-lang="vi">Dù là căng thẳng nơi làm việc, bất đồng gia đình hay xung đột nhóm, AI của chúng tôi giúp bạn hiểu nguyên nhân gốc rễ và cung cấp chiến lược giải quyết phù hợp dựa trên các kiểu tính cách liên quan.</span>
            <span data-lang="zh">无论是职场紧张、家庭分歧还是团队冲突，我们的 AI 帮你理解根本原因，并基于涉及的性格类型提供定制化解决方案。</span>
          </p>
          <a class="service-cta conflict-cta" href="#" onclick="openConflictChat()">
            <span data-lang="en">Get Help Now</span>
            <span data-lang="vi">Nhận trợ giúp ngay</span>
            <span data-lang="zh">立即获得帮助</span> →
          </a>
        </div>
        <div class="illustrationWrap">
          <div class="card3d" id="conflictCard3d">
            <img class="hero-img" src="hero_image.png" alt="People resolving conflicts"/>
          </div>
        </div>
      </div>

      <div class="when-to-use">
        <h3>
          <span data-lang="en">Get help with:</span>
          <span data-lang="vi">Nhận trợ giúp với:</span>
          <span data-lang="zh">获得帮助解决：</span>
        </h3>
        <div class="use-cases">
          <div class="use-case">
            <strong>💬 <span data-lang="en">Communication Issues</span><span data-lang="vi">Vấn đề giao tiếp</span><span data-lang="zh">沟通问题</span></strong><br>
            <span data-lang="en">Misunderstandings with colleagues or family</span>
            <span data-lang="vi">Hiểu lầm với đồng nghiệp hoặc gia đình</span>
            <span data-lang="zh">与同事或家人的误解</span>
          </div>
          <div class="use-case">
            <strong>⚖️ <span data-lang="en">Decision Deadlocks</span><span data-lang="vi">Bế tắc quyết định</span><span data-lang="zh">决策僵局</span></strong><br>
            <span data-lang="en">Can't agree on important choices</span>
            <span data-lang="vi">Không thể đồng ý về các lựa chọn quan trọng</span>
            <span data-lang="zh">无法就重要选择达成一致</span>
          </div>
          <div class="use-case">
            <strong>👥 <span data-lang="en">Team Tensions</span><span data-lang="vi">Căng thẳng nhóm</span><span data-lang="zh">团队紧张</span></strong><br>
            <span data-lang="en">Workplace conflicts affecting productivity</span>
            <span data-lang="vi">Xung đột nơi làm việc ảnh hưởng năng suất</span>
            <span data-lang="zh">影响生产力的职场冲突</span>
          </div>
          <div class="use-case">
            <strong>💼 <span data-lang="en">Work Style Clashes</span><span data-lang="vi">Xung đột phong cách làm việc</span><span data-lang="zh">工作风格冲突</span></strong><br>
            <span data-lang="en">Different approaches causing friction</span>
            <span data-lang="vi">Các cách tiếp cận khác nhau gây ma sát</span>
            <span data-lang="zh">不同方法导致的摩擦</span>
          </div>
        </div>
      </div>

      <div class="section">
        <h2>
          <span data-lang="en">How conflict resolution works</span>
          <span data-lang="vi">Cách giải quyết xung đột hoạt động</span>
          <span data-lang="zh">冲突解决如何运作</span>
        </h2>
        <div class="steps">
          <div class="step conflict-step">
            <span class="n">1</span>
            <h3>
              <span data-lang="en">Describe the situation</span>
              <span data-lang="vi">Mô tả tình huống</span>
              <span data-lang="zh">描述情况</span>
            </h3>
            <p>
              <span data-lang="en">Tell us about the conflict, the people involved, and what's at stake.</span>
              <span data-lang="vi">Hãy cho chúng tôi biết về xung đột, những người liên quan và điều gì đang bị đe dọa.</span>
              <span data-lang="zh">告诉我们冲突情况、涉及的人员以及利害关系。</span>
            </p>
          </div>
          <div class="step conflict-step">
            <span class="n">2</span>
            <h3>
              <span data-lang="en">AI analyzes patterns</span>
              <span data-lang="vi">AI phân tích mẫu hình</span>
              <span data-lang="zh">AI 分析模式</span>
            </h3>
            <p>
              <span data-lang="en">Our system identifies personality types and communication patterns causing the conflict.</span>
              <span data-lang="vi">Hệ thống của chúng tôi xác định các kiểu tính cách và mẫu giao tiếp gây ra xung đột.</span>
              <span data-lang="zh">我们的系统识别导致冲突的性格类型和沟通模式。</span>
            </p>
          </div>
          <div class="step conflict-step">
            <span class="n">3</span>
            <h3>
              <span data-lang="en">Get targeted solutions</span>
              <span data-lang="vi">Nhận giải pháp có mục tiêu</span>
              <span data-lang="zh">获得针对性解决方案</span>
            </h3>
            <p>
              <span data-lang="en">Receive specific strategies, conversation scripts, and actionable steps to resolve the conflict.</span>
              <span data-lang="vi">Nhận các chiến lược cụ thể, kịch bản cuộc trò chuyện và các bước hành động để giải quyết xung đột.</span>
              <span data-lang="zh">获得具体策略、对话脚本和可行的解决步骤。</span>
            </p>
          </div>
        </div>
      </div>

      <div class="feature-grid">
        <div class="feature-card conflict-card">
          <h3>🔍 <span data-lang="en">Root Cause Analysis</span><span data-lang="vi">Phân tích nguyên nhân gốc</span><span data-lang="zh">根本原因分析</span></h3>
          <p>
            <span data-lang="en">Understand why conflicts happen based on personality differences and communication styles.</span>
            <span data-lang="vi">Hiểu tại sao xung đột xảy ra dựa trên sự khác biệt về tính cách và phong cách giao tiếp.</span>
            <span data-lang="zh">基于性格差异和沟通风格理解冲突发生的原因。</span>
          </p>
        </div>
        <div class="feature-card conflict-card">
          <h3>🎯 <span data-lang="en">Targeted Strategies</span><span data-lang="vi">Chiến lược có mục tiêu</span><span data-lang="zh">针对性策略</span></h3>
          <p>
            <span data-lang="en">Get specific resolution techniques tailored to the personality types involved.</span>
            <span data-lang="vi">Nhận các kỹ thuật giải quyết cụ thể phù hợp với các kiểu tính cách liên quan.</span>
            <span data-lang="zh">获得针对涉及性格类型的具体解决技巧。</span>
          </p>
        </div>
        <div class="feature-card conflict-card">
          <h3>💬 <span data-lang="en">Communication Scripts</span><span data-lang="vi">Kịch bản giao tiếp</span><span data-lang="zh">沟通脚本</span></h3>
          <p>
            <span data-lang="en">Practice exact phrases and approaches that work for each personality type.</span>
            <span data-lang="vi">Luyện tập các cụm từ và cách tiếp cận chính xác hoạt động cho từng kiểu tính cách.</span>
            <span data-lang="zh">练习适用于每种性格类型的确切短语和方法。</span>
          </p>
        </div>
      </div>
    </section>

    <!-- About Section -->
    <section class="section" id="about">
      <h2>
        <span data-lang="en">About Group 61</span>
        <span data-lang="vi">Về Nhóm 61</span>
        <span data-lang="zh">关于第 61 组</span>
      </h2>
      <p class="muted">
        <span data-lang="en">We are Group 61 from Tsinghua University's IEDE 2025 program. Mind-Mapper AI was born from our passion to use technology for self-awareness and growth.</span>
        <span data-lang="vi">Chúng tôi là Nhóm 61 của chương trình IEDE 2025 (ĐH Thanh Hoa). Mind-Mapper AI ra đời từ mong muốn dùng công nghệ để giúp mọi người hiểu mình và phát triển.</span>
        <span data-lang="zh">我们来自清华大学 IEDE 2025 项目的第 61 组。Mind-Mapper AI 源于我们希望用技术帮助每个人自我认知与成长的热情。</span>
      </p>
      <p class="muted" style="margin-top:10px">
        <span data-lang="en">Our goal is to make personality analysis and conflict resolution accessible, engaging, and modern for everyone.</span>
        <span data-lang="vi">Mục tiêu của chúng tôi là đưa phân tích tính cách và giải quyết xung đột đến với mọi người—dễ tiếp cận, thú vị và hiện đại.</span>
        <span data-lang="zh">我们的目标：让性格分析和冲突解决更易用、更有趣、更现代，服务于所有人。</span>
      </p>
    </section>

    <!-- FAQ Section -->
    <section class="section faq" id="faq">
      <h2>FAQ</h2>
      <details>
        <summary><span data-lang="en">What is the MBTI?</span><span data-lang="vi">MBTI là gì?</span><span data-lang="zh">什么是 MBTI？</span></summary>
        <p><span data-lang="en">The Myers-Briggs Type Indicator describes preferences in how people perceive information and make decisions, grouping into 16 types.</span><span data-lang="vi">MBTI mô tả xu hướng trong cách con người tiếp nhận thông tin và ra quyết định, gồm 16 kiểu tính cách.</span><span data-lang="zh">MBTI（迈尔斯-布里格斯性格指标）描述人们在信息感知与决策方式上的偏好，共 16 种类型。</span></p>
      </details>
      <details>
        <summary><span data-lang="en">How does conflict resolution work?</span><span data-lang="vi">Giải quyết xung đột hoạt động như thế nào?</span><span data-lang="zh">冲突解决是如何工作的？</span></summary>
        <p><span data-lang="en">Our AI analyzes the personalities and communication styles involved in your conflict, then provides tailored strategies and specific conversation approaches to help resolve the issue.</span><span data-lang="vi">AI của chúng tôi phân tích các tính cách và phong cách giao tiếp liên quan đến xung đột của bạn, sau đó cung cấp các chiến lược phù hợp và cách tiếp cận cuộc trò chuyện cụ thể để giúp giải quyết vấn đề.</span><span data-lang="zh">我们的 AI 分析你冲突中涉及的性格和沟通风格，然后提供定制策略和具体的对话方法来帮助解决问题。</span></p>
      </details>
      <details>
        <summary><span data-lang="en">Is this a clinical assessment?</span><span data-lang="vi">Đây có phải đánh giá lâm sàng?</span><span data-lang="zh">这是临床评估吗？</span></summary>
        <p><span data-lang="en">No—it's a self-reflection and guidance tool powered by AI. Use it for insights and guidance, not diagnosis.</span><span data-lang="vi">Không—đây là công cụ tự phản chiếu và hướng dẫn do AI hỗ trợ. Dùng để tham khảo và hướng dẫn, không phải chẩn đoán.</span><span data-lang="zh">不是。这是一个由 AI 驱动的自我反思和指导工具，仅供洞察和指导，不用于诊断。</span></p>
      </details>
      <details>
        <summary><span data-lang="en">Is my data private and secure?</span><span data-lang="vi">Dữ liệu của tôi có riêng tư và an toàn?</span><span data-lang="zh">我的数据是否安全？</span></summary>
        <p><span data-lang="en">We securely save anonymized conversations to improve our AI's accuracy and insights. We do not store any personal identification information.</span><span data-lang="vi">Chúng tôi lưu trữ ẩn danh các cuộc trò chuyện một cách an toàn để cải thiện độ chính xác của AI. Không lưu bất kỳ thông tin định danh cá nhân nào.</span><span data-lang="zh">我们仅安全保存已匿名化的对话，用于提升准确度；不存储任何可识别个人的信息。</span></p>
      </details>
      <details>
        <summary><span data-lang="en">How long does it take?</span><span data-lang="vi">Mất bao lâu?</span><span data-lang="zh">需要多久？</span></summary>
        <p><span data-lang="en">Personality analysis usually takes 5–10 minutes to get a first profile. Conflict resolution varies depending on complexity but typically provides initial guidance within a few exchanges.</span><span data-lang="vi">Phân tích tính cách thường mất 5–10 phút để có bản phân tích đầu tiên. Giải quyết xung đột thay đổi tùy thuộc vào độ phức tạp nhưng thường cung cấp hướng dẫn ban đầu trong vài lần trao đổi.</span><span data-lang="zh">性格分析通常 5–10 分钟即可获得初步画像。冲突解决因复杂程度而异，但通常在几次交流内就能提供初步指导。</span></p>
      </details>
    </section>

    <!-- Contact Section -->
    <section class="section" id="contact">
      <h2><span data-lang="en">Get in touch</span><span data-lang="vi">Liên hệ</span><span data-lang="zh">联系我们</span></h2>
      <form id="contactForm">
        <div class="field">
          <label><span data-lang="en">Name</span><span data-lang="vi">Tên</span><span data-lang="zh">姓名</span></label>
          <input id="contact-name" required data-lang-en-placeholder="Your name" data-lang-vi-placeholder="Tên của bạn" data-lang-zh-placeholder="你的名字" />
        </div>
        <div class="field" style="margin-top:10px">
          <label><span data-lang="en">Email</span><span data-lang="vi">Email</span><span data-lang="zh">邮箱</span></label>
          <input id="contact-email" type="email" required data-lang-en-placeholder="you@example.com" data-lang-vi-placeholder="ban@example.com" data-lang-zh-placeholder="ni@example.com" />
        </div>
        <div class="field" style="margin-top:10px">
          <label><span data-lang="en">Message</span><span data-lang="vi">Tin nhắn</span><span data-lang="zh">留言</span></label>
          <textarea id="contact-message" rows="5" required data-lang-en-placeholder="How can we help?" data-lang-vi-placeholder="Chúng tôi có thể giúp gì?" data-lang-zh-placeholder="我们能如何帮助你？"></textarea>
        </div>
        <button class="btn" style="margin-top:12px">
          <span data-lang="en">Send message</span>
          <span data-lang="vi">Gửi tin nhắn</span>
          <span data-lang="zh">发送</span>
        </button>
      </form>
    </section>
  </main>

  <!-- Chat Launch Buttons -->
  <button class="chat-launch personality-chat" id="personalityChatOpen" title="Chat with Personality AI" style="display:none;">
    <img src="mascot.png" alt="Personality AI Mascot" />
  </button>

  <button class="chat-launch conflict conflict-chat" id="conflictChatOpen" title="Chat with Conflict Resolution AI" style="display:none;">
    <img src="mascot.png" alt="Conflict Resolution AI Mascot" />
  </button>

  <!-- Chat Panels -->
  <div class="chat-panel personality-panel" id="personalityChatPanel" aria-live="polite">
    <div class="chat-head personality-head">
      <h3><span data-lang="en">Personality Analyst</span><span data-lang="vi">Chuyên gia Tính cách</span><span data-lang="zh">性格分析师</span></h3>
    </div>
    <div class="chat-body" id="personalityChatBody"></div>
    <div class="chat-foot" id="personalityChatFoot">
      <div id="personalityInputArea" style="display:grid; grid-template-columns: 1fr auto; gap: 8px;">
        <input id="personalityChatInput" placeholder="Type your message…" />
        <button class="btn" id="personalitySendBtn">
          <span data-lang="en">Send</span>
          <span data-lang="vi">Gửi</span>
          <span data-lang="zh">发送</span>
        </button>
      </div>
      <button class="btn" id="personalityResetBtn" style="display:none; width:100%;">
        <span data-lang="en">Start New Analysis</span>
        <span data-lang="vi">Bắt đầu phân tích mới</span>
        <span data-lang="zh">开始新的分析</span>
      </button>
    </div>
  </div>

  <div class="chat-panel conflict-panel" id="conflictChatPanel" aria-live="polite">
    <div class="chat-head conflict-head">
      <h3><span data-lang="en">Conflict Resolution Specialist</span><span data-lang="vi">Chuyên gia Giải quyết Xung đột</span><span data-lang="zh">冲突解决专家</span></h3>
    </div>
    <div class="chat-body" id="conflictChatBody"></div>
    <div class="chat-foot" id="conflictChatFoot">
      <div id="conflictInputArea" style="display:grid; grid-template-columns: 1fr auto; gap: 8px;">
        <input id="conflictChatInput" placeholder="Describe your conflict…" />
        <button class="btn" id="conflictSendBtn">
          <span data-lang="en">Send</span>
          <span data-lang="vi">Gửi</span>
          <span data-lang="zh">发送</span>
        </button>
      </div>
      <button class="btn" id="conflictResetBtn" style="display:none; width:100%;">
        <span data-lang="en">Start New Session</span>
        <span data-lang="vi">Bắt đầu phiên mới</span>
        <span data-lang="zh">开始新会话</span>
      </button>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // --- 1. Supabase Configuration ---
    const supa_url = 'https://okbqkkftdxazdfkiovjj.supabase.co';
    const supa_anon_key = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im9rYnFra2Z0ZHhhemRma2lvdmpqIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTUxNDUxOTEsImV4cCI6MjA3MDcyMTE5MX0.SvYI1lxJP-dzEK5j1xGNdJu-pNtWEzVm7S2wnQBMY9c';
    const supabaseClient = supabase.createClient(supa_url, supa_anon_key);

    // Globals
    let personalityHistory = [];
    let conflictHistory = [];
    let currentService = 'personality';
    let latestPersonalityProgress = null;

    // --- 2. Utility Functions ---
    function initializeSparkles() { 
      const host = document.getElementById('sparkles'); 
      if (!host || host.children.length) return;
      for(let i=0;i<120;i++){ 
        const s=document.createElement('i'); 
        s.style.left=Math.random()*100+'vw';
        s.style.top='100vh';
        s.style.animationDuration=(10+Math.random()*16)+'s'; 
        host.appendChild(s);
      } 
    }

    function initializeTilt() { 
      const personalityCard = document.getElementById('personalityCard3d');
      const conflictCard = document.getElementById('conflictCard3d'); 
      [personalityCard, conflictCard].forEach(card => {
        if (!card) return;
        let b = card.getBoundingClientRect(); 
        window.addEventListener('resize', () => b = card.getBoundingClientRect()); 
        card.addEventListener('mousemove', e => { 
          const x=(e.clientX-b.left)/b.width-0.5; 
          const y=(e.clientY-b.top)/b.height-0.5; 
          card.style.transform=`perspective(1000px) rotateX(${-y*6}deg) rotateY(${x*8}deg)`; 
        }); 
        card.addEventListener('mouseleave', () => { card.style.transform='perspective(1000px) rotateX(0) rotateY(0)';}); 
      });
    }

    function initializeLanguage() {
      const sel = document.getElementById('language');
      if (!sel) return;

      function applyPlaceholders() { 
        const lang = document.body.classList.contains('lang-vi') ? 'vi' :
                     document.body.classList.contains('lang-zh') ? 'zh' : 'en';
        document.querySelectorAll('[data-lang-en-placeholder]').forEach(el => { 
          const txt = el.getAttribute(`data-lang-${lang}-placeholder`); 
          if(txt) el.placeholder = txt; 
        }); 
      }
      
      function setLang(lang) { 
        document.body.classList.remove('lang-en','lang-vi','lang-zh'); 
        document.body.classList.add('lang-' + lang); 
        localStorage.setItem('preferredLanguage', lang); 
        applyPlaceholders();
        // Refresh initial messages
        displayPersonalityInitialMessage();
        displayConflictInitialMessage();
      }
      
      const saved = localStorage.getItem('preferredLanguage') || 'en'; 
      sel.value = saved; 
      setLang(saved); 
      sel.addEventListener('change', e => setLang(e.target.value));
    }

    // --- 3. Navigation ---
    function initializeNavigation() {
      const navLinks = document.querySelectorAll('.nav-link[data-section]');
      const sections = document.querySelectorAll('.service-section');
      
      navLinks.forEach(link => {
        link.addEventListener('click', function(e) {
          e.preventDefault();
          
          const targetSection = this.dataset.section;
          
          // Update active nav link
          navLinks.forEach(nl => nl.classList.remove('active'));
          this.classList.add('active');
          
          // Update visible section
          sections.forEach(section => section.classList.remove('active'));
          document.getElementById(targetSection + '-section').classList.add('active');
          
          // Update current service and show appropriate chat button
          currentService = targetSection;
          updateChatButtons();
          
          // Update URL without page reload
          history.pushState(null, '', '#' + targetSection);
        });
      });
      
      // Handle direct URL access
      const hash = window.location.hash.slice(1);
      if (hash && (hash === 'personality' || hash === 'conflict')) {
        const targetLink = document.querySelector(`[data-section="${hash}"]`);
        if (targetLink) {
          targetLink.click();
        }
      }
    }

    function updateChatButtons() {
      const personalityBtn = document.getElementById('personalityChatOpen');
      const conflictBtn = document.getElementById('conflictChatOpen');
      
      if (currentService === 'personality') {
        personalityBtn.style.display = 'block';
        conflictBtn.style.display = 'none';
      } else if (currentService === 'conflict') {
        personalityBtn.style.display = 'none';
        conflictBtn.style.display = 'block';
      } else {
        personalityBtn.style.display = 'none';
        conflictBtn.style.display = 'none';
      }
    }

    // --- 4. Service Launch Functions ---
    function openPersonalityChat() {
      currentService = 'personality';
      updateChatButtons();
      document.getElementById('personalityChatPanel').classList.add('open');
      document.getElementById('personalityChatInput').focus();
    }

    function openConflictChat() {
      currentService = 'conflict';
      updateChatButtons();
      document.getElementById('conflictChatPanel').classList.add('open');
      document.getElementById('conflictChatInput').focus();
    }

    // --- 5. Chat Panel Functions ---
    function initializeChatPanels() {
      // Personality chat
      const personalityOpen = document.getElementById('personalityChatOpen');
      const personalityPanel = document.getElementById('personalityChatPanel');
      if (personalityOpen && personalityPanel) {
        personalityOpen.onclick = () => { 
          personalityPanel.classList.toggle('open');
          if (personalityPanel.classList.contains('open')) {
            if (latestPersonalityProgress && latestPersonalityProgress.current_step < latestPersonalityProgress.total_steps) {
              updatePersonalityProgressBar(latestPersonalityProgress);
            }
            document.getElementById('personalityChatInput').focus();
          }
        };
      }

      // Conflict chat
      const conflictOpen = document.getElementById('conflictChatOpen');
      const conflictPanel = document.getElementById('conflictChatPanel');
      if (conflictOpen && conflictPanel) {
        conflictOpen.onclick = () => { 
          conflictPanel.classList.toggle('open');
          if (conflictPanel.classList.contains('open')) {
            document.getElementById('conflictChatInput').focus();
          }
        };
      }
    }

    // --- 6. Contact Form Handler ---
    async function handleContactSubmit(event) {
        event.preventDefault();
        const form = event.target;
        const submitButton = form.querySelector('button');
        
        const formData = {
            name: document.getElementById('contact-name').value,
            email: document.getElementById('contact-email').value,
            message: document.getElementById('contact-message').value,
            lang: localStorage.getItem('preferredLanguage') || 'en',
            user_agent: navigator.userAgent
        };

        submitButton.disabled = true;
        submitButton.textContent = 'Sending...';

        try {
            const { data, error } = await supabaseClient
                .from('contact_messages')
                .insert([formData]);

            if (error) throw error;

            alert(document.body.classList.contains('lang-vi') ? 'Cảm ơn! Chúng tôi đã nhận được tin nhắn của bạn.' :
                  document.body.classList.contains('lang-zh') ? '谢谢！我们已收到你的留言。' :
                  'Thanks! We have received your message.');
            form.reset();

        } catch (error) {
            console.error('Error submitting contact form:', error.message);
            alert('Sorry, there was an error sending your message. Please try again.');
        
        } finally {
            submitButton.disabled = false;
            const lang = document.body.className.split(' ').find(c => c.startsWith('lang-')).split('-')[1] || 'en';
            submitButton.innerHTML = form.querySelector(`[data-lang="${lang}"]`).outerHTML;
        }
    }

    // --- 7. Chat Messaging Functions ---
    function displayPersonalityInitialMessage() {
      const chatBody = document.getElementById('personalityChatBody');
      if (!chatBody) return;
      const isVI = document.body.classList.contains('lang-vi');
      const isZH = document.body.classList.contains('lang-zh');
      chatBody.innerHTML = ''; 
      const initialMsg = document.createElement('div');
      initialMsg.className = 'msg ai';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      let welcomeText;
      if (isVI) {
        welcomeText = `Chào bạn! Cùng trò chuyện một chút về tính cách nhé. Bạn cứ thoải mái chia sẻ cách làm việc, giao tiếp hay ra quyết định. Mình sẽ lắng nghe và giúp bạn hiểu mình hơn. 😊`;
      } else if (isZH) {
        welcomeText = `你好！我们来轻松聊聊你的性格吧。可以随意说说你的工作方式、人际相处或者决策习惯。我会认真倾听并给出有用的反馈。😊`;
      } else {
        welcomeText = `Hey there! Let's chat a bit about your personality. Tell me how you like to work, socialize, or make decisions. I'm here to listen and help you learn more about yourself. 😊`;
      }
      bubble.innerHTML = `<span>${welcomeText}</span>`;
      initialMsg.appendChild(bubble);
      chatBody.appendChild(initialMsg);
      personalityHistory = [{ role: 'assistant', content: welcomeText }];
    }

    function displayConflictInitialMessage() {
      const chatBody = document.getElementById('conflictChatBody');
      if (!chatBody) return;
      const isVI = document.body.classList.contains('lang-vi');
      const isZH = document.body.classList.contains('lang-zh');
      chatBody.innerHTML = ''; 
      const initialMsg = document.createElement('div');
      initialMsg.className = 'msg ai';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      let welcomeText;
      if (isVI) {
        welcomeText = `Xin chào! Tôi là chuyên gia giải quyết xung đột của bạn. 🤝

Hãy mô tả tình huống bạn đang gặp phải - ai là những người liên quan và điều gì đang gây ra căng thẳng? 

Tôi sẽ giúp bạn:
• Hiểu rõ nguyên nhân gốc rễ
• Đưa ra các chiến lược phù hợp  
• Cung cấp những câu nói cụ thể bạn có thể dùng
• Tìm ra giải pháp có lợi cho tất cả mọi người

Cứ thoải mái chia sẻ nhé!`;
      } else if (isZH) {
        welcomeText = `你好！我是你的冲突解决专家。🤝

请描述一下你遇到的情况——涉及哪些人，什么原因导致了紧张关系？

我会帮你：
• 理解根本原因
• 提供针对性策略
• 给出具体的表达建议
• 找到对所有人都有利的解决方案

请随意分享你的情况！`;
      } else {
        welcomeText = `Hello! I'm your conflict resolution specialist. 🤝

Please describe the situation you're dealing with - who's involved and what's causing the tension?

I'll help you:
• Understand the root causes
• Develop targeted strategies  
• Get specific phrases you can use
• Find solutions that work for everyone

Feel free to share what's going on!`;
      }
      bubble.innerHTML = `<span>${welcomeText}</span>`;
      initialMsg.appendChild(bubble);
      chatBody.appendChild(initialMsg);
      conflictHistory = [{ role: 'assistant', content: welcomeText }];
    }

    function appendMessage(service, role, text, conversationId = null, showFeedback = false) { 
      const chatBody = document.getElementById(service + 'ChatBody');
      if (!chatBody) return;
      const wrap = document.createElement('div'); 
      wrap.className = 'msg ' + (role === 'user' ? `user ${service}` : 'ai');
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      let processedText = text
        .replace(/</g,'&lt;')
        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>') 
        .replace(/\*(.*?)\*/g, '<em>$1</em>')
        .replace(/\n/g,'<br>');
      bubble.innerHTML = processedText;
      if (role === 'ai' && conversationId && showFeedback) {
        const fb = document.createElement('div');
        fb.className = 'feedback-buttons';
        fb.innerHTML = `
          <button data-convo-id="${conversationId}" data-rating="true">👍 Accurate</button>
          <button data-convo-id="${conversationId}" data-rating="false">👎 Not Quite</button>`;
        bubble.appendChild(fb);
      }
      wrap.appendChild(bubble);
      chatBody.appendChild(wrap); 
      chatBody.scrollTop = chatBody.scrollHeight; 
    }

    function showTyping(service) {
      const chatBody = document.getElementById(service + 'ChatBody');
      if (!chatBody) return;
      const wrap = document.createElement('div');
      wrap.className = 'msg ai typing';
      wrap.id = service + '-typing-indicator';
      wrap.innerHTML = `<div class="bubble">Typing...</div>`;
      chatBody.appendChild(wrap);
      chatBody.scrollTop = chatBody.scrollHeight;
    }

    function hideTyping(service){ 
      const t = document.getElementById(service + '-typing-indicator'); 
      if(t) t.remove(); 
    }

    function updatePersonalityProgressBar(progress) {
      if (progress && progress.current_step >= progress.total_steps) {
        const ex = document.getElementById('personality-progress-container'); if (ex) ex.remove();
        latestPersonalityProgress = null; return;
      }
      let pc = document.getElementById('personality-progress-container');
      if (!pc) {
        pc = document.createElement('div');
        pc.id = 'personality-progress-container';
        pc.style.cssText = `
          padding: 8px 14px;border-bottom:1px solid var(--glass-stroke);
          background: rgba(255,255,255,.03); text-align:center; font-size:12px;
          color: var(--muted); font-weight:500; flex-shrink:0;`;
        const head = document.querySelector('#personalityChatPanel .chat-head');
        if (head && head.parentNode) head.parentNode.insertBefore(pc, head.nextSibling);
      }
      if (progress) {
        const count = Object.values(progress.dimensions_explored || {}).filter(Boolean).length;
        pc.innerHTML = `Analysis Progress: Dimensions Explored ${count}/4`;
      }
    }

    async function handleFeedback(conversationId, isAccurate) {
      try {
        const buttons = document.querySelectorAll(`button[data-convo-id="${conversationId}"]`);
        buttons.forEach(b => b.disabled = true);
        const res = await fetch('/.netlify/functions/save-feedback', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({ conversation_id:Number(conversationId), is_accurate:Boolean(isAccurate) })
        });
        if (!res.ok) throw new Error(await res.text() || `HTTP ${res.status}`);
        buttons.forEach(btn => {
          if (btn.getAttribute('data-rating') === String(isAccurate)) {
            btn.textContent = isAccurate ? '✅ Thanks!' : '📝 Noted';
            btn.classList.add('selected');
          }
        });
      } catch (error) {
        console.error('Error saving feedback:', error);
        alert('Could not save feedback: ' + (error.message || String(error)));
        const buttons = document.querySelectorAll(`button[data-convo-id="${conversationId}"]`);
        buttons.forEach(b => b.disabled = false);
      }
    }

    function initializeFeedbackHandlers() {
      document.getElementById('personalityChatBody').addEventListener('click', (e) => {
        const t = e.target;
        if (t.tagName === 'BUTTON' && t.hasAttribute('data-convo-id')) {
          const id = t.getAttribute('data-convo-id');
          const ok = t.getAttribute('data-rating') === 'true';
          handleFeedback(id, ok);
        }
      });

      document.getElementById('conflictChatBody').addEventListener('click', (e) => {
        const t = e.target;
        if (t.tagName === 'BUTTON' && t.hasAttribute('data-convo-id')) {
          const id = t.getAttribute('data-convo-id');
          const ok = t.getAttribute('data-rating') === 'true';
          handleFeedback(id, ok);
        }
      });
    }

    // --- 8. Personality Chat Handler ---
    async function handlePersonalitySend() {
      const input = document.getElementById('personalityChatInput');
      if (!input) return;
      const text = input.value.trim(); 
      if (!text) return; 
      input.value=''; 
      appendMessage('personality', 'user', text);
      personalityHistory.push({ role:'user', content:text });
      showTyping('personality');
      
      try {
        const messages = personalityHistory.slice(-10);
        
        console.log('🔍 SENDING PERSONALITY REQUEST');
        
        // Call the dedicated personality function
        const res = await fetch('/.netlify/functions/personality-chat', {
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body:JSON.stringify({ 
            messages,
            language: localStorage.getItem('preferredLanguage') || 'en'
          })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${res.status}: Request failed`);
        }
        
        const data = await res.json();
        hideTyping('personality');
        
        if (data.reply) {
          try {
            const mbtiResult = JSON.parse(data.reply);
            personalityHistory.push({ role:'assistant', content:data.reply });
            
            if (mbtiResult.progress) { 
              latestPersonalityProgress = mbtiResult.progress; 
              updatePersonalityProgressBar(latestPersonalityProgress); 
            }
            
            let responseText = '';
            let isActualResult = false;
            
            if (mbtiResult.ready_for_analysis === true && mbtiResult.type && mbtiResult.type !== 'Unknown') {
              isActualResult = true;
              responseText = `🎯 **Your MBTI Type: ${mbtiResult.type}**\n`;
              responseText += `📊 Confidence: ${Math.round(mbtiResult.confidence * 100)}%\n\n`;
              if (mbtiResult.one_liner) responseText += `💭 *${mbtiResult.one_liner}*\n\n`;
              if (mbtiResult.reasoning) responseText += `**My Analysis:**\n${mbtiResult.reasoning}\n\n`;
              if (mbtiResult.strengths?.length) {
                responseText += `✨ **Your Strengths:**\n`; 
                mbtiResult.strengths.forEach(s => responseText += `• ${s}\n`); 
                responseText += '\n';
              }
              if (mbtiResult.growth_tips?.length) {
                responseText += `🌱 **Growth Tips:**\n`; 
                mbtiResult.growth_tips.forEach(t => responseText += `• ${t}\n`); 
              }
              document.getElementById('personalityInputArea').style.display='none';
              document.getElementById('personalityResetBtn').style.display='block';
            } else {
              responseText = mbtiResult.one_liner || 'I need a bit more information. Can you tell me more?';
            }
            
            appendMessage('personality', 'ai', responseText, data.conversation_id, isActualResult);
            
          } catch (e) {
            console.error('JSON parse error:', e);
            appendMessage('personality', 'ai', data.reply);
            personalityHistory.push({ role:'assistant', content:data.reply });
          }
        } else {
          appendMessage('personality', 'ai', 'Sorry, I received an unexpected response format.');
        }
      } catch (err) { 
        hideTyping('personality'); 
        handleChatError('personality', err);
      }
    }

    // --- 9. Conflict Chat Handler ---
    function formatConflictResponse(conflictData) {
      let formatted = '';
      
      // Handle error responses
      if (conflictData.status === 'error') {
        return conflictData.main_response || 'I encountered an error. Please try again.';
      }
      
      // Main response (always present)
      if (conflictData.main_response) {
        formatted += conflictData.main_response;
      }
      
      // Add conflict analysis if present
      if (conflictData.conflict_analysis) {
        formatted += '\n\n**💡 What I see happening:**\n';
        formatted += conflictData.conflict_analysis;
      }
      
      // Add insights if present
      if (conflictData.insights && conflictData.insights.length > 0) {
        formatted += '\n\n**🔍 Key Insights:**\n';
        conflictData.insights.forEach(insight => {
          formatted += `• ${insight}\n`;
        });
      }
      
      // Add resolution strategies if present
      if (conflictData.resolution_strategies && conflictData.resolution_strategies.length > 0) {
        formatted += '\n\n**🛠️ Resolution Strategies:**\n';
        conflictData.resolution_strategies.forEach((strategy, index) => {
          formatted += `\n**${index + 1}. ${strategy.strategy}**\n`;
          formatted += `${strategy.description}\n`;
          
          if (strategy.example_phrases && strategy.example_phrases.length > 0) {
            formatted += `\n*Try saying:*\n`;
            strategy.example_phrases.forEach(phrase => {
              formatted += `💬 "${phrase}"\n`;
            });
          }
        });
      }
      
      // Add action steps if present
      if (conflictData.action_steps && conflictData.action_steps.length > 0) {
        formatted += '\n\n**📋 Your Next Steps:**\n';
        conflictData.action_steps.forEach((step, index) => {
          formatted += `${index + 1}. ${step}\n`;
        });
      }
      
      // Add prevention tips if present
      if (conflictData.prevention_tips && conflictData.prevention_tips.length > 0) {
        formatted += '\n\n**🛡️ Future Prevention:**\n';
        conflictData.prevention_tips.forEach(tip => {
          formatted += `• ${tip}\n`;
        });
      }
      
      // Add key questions if present
      if (conflictData.key_questions && conflictData.key_questions.length > 0) {
        formatted += '\n\n**❓ To help me understand better:**\n';
        conflictData.key_questions.forEach(question => {
          formatted += `• ${question}\n`;
        });
      }
      
      // Add next steps if present (different from action_steps)
      if (conflictData.next_steps && conflictData.next_steps.length > 0) {
        formatted += '\n\n**🎯 What I'll help you with next:**\n';
        conflictData.next_steps.forEach(step => {
          formatted += `• ${step}\n`;
        });
      }
      
      return formatted.trim();
    }

    async function handleConflictSend() {
      const input = document.getElementById('conflictChatInput');
      if (!input) return;
      const text = input.value.trim(); 
      if (!text) return; 
      input.value=''; 
      appendMessage('conflict', 'user', text);
      conflictHistory.push({ role:'user', content:text });
      showTyping('conflict');
      
      try {
        const messages = conflictHistory.slice(-10);
        
        console.log('🔍 SENDING CONFLICT REQUEST');
        
        // Call the dedicated conflict function
        const res = await fetch('/.netlify/functions/conflict-chat', {
          method:'POST', 
          headers:{'Content-Type':'application/json'}, 
          body:JSON.stringify({ 
            messages,
            language: localStorage.getItem('preferredLanguage') || 'en'
          })
        });
        
        if (!res.ok) {
          const errorData = await res.json().catch(() => ({}));
          throw new Error(errorData.error || `HTTP ${res.status}: Request failed`);
        }
        
        const data = await res.json();
        
        console.log('🔍 RECEIVED CONFLICT RESPONSE:', data);
        
        hideTyping('conflict');
        
        if (data.reply) {
          try {
            const conflictResult = JSON.parse(data.reply);
            conflictHistory.push({ role:'assistant', content:data.reply });
            
            console.log('🔍 PARSED CONFLICT JSON:', conflictResult);
            
            // Format the conflict response for user-friendly display
            const formattedResponse = formatConflictResponse(conflictResult);
            appendMessage('conflict', 'ai', formattedResponse, data.conversation_id, false);
            
          } catch (parseError) {
            console.error('❌ Failed to parse conflict JSON:', parseError);
            conflictHistory.push({ role:'assistant', content:data.reply });
            appendMessage('conflict', 'ai', data.reply, data.conversation_id, false);
          }
        } else {
          appendMessage('conflict', 'ai', 'Sorry, I received an unexpected response format.');
        }
      } catch (err) { 
        hideTyping('conflict'); 
        handleChatError('conflict', err);
      }
    }

    // --- 10. Shared Error Handler ---
    function handleChatError(service, error) {
      if (error.message.includes('Too many requests')) {
        appendMessage(service, 'ai', 'I\'m receiving a lot of requests right now. Please wait a minute and try again.');
      } else if (error.message.includes('Origin not allowed')) {
        appendMessage(service, 'ai', 'There seems to be a security issue. Please refresh the page and try again.');
      } else {
        appendMessage(service, 'ai', `Sorry, I encountered an error: ${error.message}. Please try again.`); 
      }
    }

    function resetPersonalityChat() {
      displayPersonalityInitialMessage();
      document.getElementById('personalityInputArea').style.display = 'grid';
      document.getElementById('personalityResetBtn').style.display = 'none';
      document.getElementById('personalityChatInput').focus();
      latestPersonalityProgress = null;
      const pc = document.getElementById('personality-progress-container');
      if (pc) pc.remove();
    }

    function resetConflictChat() {
      displayConflictInitialMessage();
      document.getElementById('conflictInputArea').style.display = 'grid';
      document.getElementById('conflictResetBtn').style.display = 'none';
      document.getElementById('conflictChatInput').focus();
    }

    function initializeChatControls() {
      // Personality controls
      const personalitySendBtn = document.getElementById('personalitySendBtn');
      const personalityResetBtn = document.getElementById('personalityResetBtn');
      const personalityInput = document.getElementById('personalityChatInput');
      
      if (personalitySendBtn) personalitySendBtn.addEventListener('click', handlePersonalitySend);
      if (personalityResetBtn) personalityResetBtn.addEventListener('click', resetPersonalityChat);
      if (personalityInput) {
        personalityInput.addEventListener('keydown', e => { 
          if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); handlePersonalitySend(); }
        });
      }

      // Conflict controls
      const conflictSendBtn = document.getElementById('conflictSendBtn');
      const conflictResetBtn = document.getElementById('conflictResetBtn');
      const conflictInput = document.getElementById('conflictChatInput');
      
      if (conflictSendBtn) conflictSendBtn.addEventListener('click', handleConflictSend);
      if (conflictResetBtn) conflictResetBtn.addEventListener('click', resetConflictChat);
      if (conflictInput) {
        conflictInput.addEventListener('keydown', e => { 
          if (e.key === 'Enter' && !e.shiftKey){ e.preventDefault(); handleConflictSend(); }
        });
      }

      initializeFeedbackHandlers();
      displayPersonalityInitialMessage();
      displayConflictInitialMessage();
    }

    // --- 11. Initialize Everything ---
    document.addEventListener('DOMContentLoaded', () => {
      initializeSparkles();
      initializeTilt();
      initializeLanguage();
      initializeNavigation();
      initializeChatPanels();
      initializeChatControls();
      updateChatButtons();

      const contactForm = document.getElementById('contactForm');
      if (contactForm) {
          contactForm.addEventListener('submit', handleContactSubmit);
      }

      // Make functions globally available
      window.openPersonalityChat = openPersonalityChat;
      window.openConflictChat = openConflictChat;
    });
  </script>
</body>
</html>